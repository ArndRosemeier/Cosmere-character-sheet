<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmere RPG Character Sheet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #7d3c3c;
            --accent-color: #d4af37;
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --border-color: #ddd;
            --text-primary: #333;
            --text-secondary: #666;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --physical-color: #c44444;
            --cognitive-color: #4472c4;
            --spiritual-color: #70ad47;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            background-color: var(--accent-color);
            color: var(--text-primary);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.primary {
            background-color: var(--success-color);
            color: white;
        }

        button.danger {
            background-color: var(--danger-color);
            color: white;
        }

        .character-list {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .character-list h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .character-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .character-card {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .character-card.active {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.1);
        }

        .character-card h3 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .character-card p {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .sheet-container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sheet-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-column {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .stat-column.physical {
            border-color: var(--physical-color);
            background-color: rgba(196, 68, 68, 0.05);
        }

        .stat-column.cognitive {
            border-color: var(--cognitive-color);
            background-color: rgba(68, 114, 196, 0.05);
        }

        .stat-column.spiritual {
            border-color: var(--spiritual-color);
            background-color: rgba(112, 173, 71, 0.05);
        }

        .stat-column h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid currentColor;
        }

        .stat-column.physical h3 {
            color: var(--physical-color);
        }

        .stat-column.cognitive h3 {
            color: var(--cognitive-color);
        }

        .stat-column.spiritual h3 {
            color: var(--spiritual-color);
        }

        .attribute-box,
        .defense-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .attribute-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .attribute-label {
            font-weight: 600;
            font-size: 1.1em;
        }

        .attribute-value {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            background-color: var(--bg-primary);
            padding: 10px;
            border-radius: 4px;
        }

        .defense-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-primary);
            border-radius: 4px;
        }

        .defense-label {
            font-weight: 600;
        }

        .defense-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .skills-section {
            margin-bottom: 20px;
        }

        .skill-row {
            display: grid;
            grid-template-columns: 2fr 80px 80px;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .skill-row:hover {
            background-color: var(--bg-primary);
        }

        .skill-name {
            font-weight: 500;
        }

        .skill-attr {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .skill-rank {
            width: 70px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .skill-modifier {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            padding: 6px;
            background-color: var(--bg-primary);
            border-radius: 4px;
        }

        .resources-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .resource-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .resource-label {
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text-secondary);
        }

        .resource-values {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .resource-current,
        .resource-max {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .resource-current {
            width: 80px;
        }

        .resource-max {
            width: 80px;
            background-color: var(--bg-primary);
        }

        .paths-section {
            margin-bottom: 30px;
        }

        .path-selector {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .path-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .path-card {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .path-card:hover {
            border-color: var(--primary-color);
        }

        .path-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.1);
        }

        .path-card h4 {
            margin-bottom: 5px;
        }

        .path-card p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .notes-section {
            margin-top: 30px;
        }

        .notes-area {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }

        .level-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .level-display {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        @media print {
            header, .header-controls, .character-list, button {
                display: none;
            }
            
            .sheet-container {
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .sheet-header {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                flex-direction: column;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .auto-calc {
            color: var(--success-color);
            font-style: italic;
        }

        .validation-warning {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-warning.error {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .validation-warning.success {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .validation-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .validation-message {
            flex-grow: 1;
        }

        .point-tracker {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .point-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .point-tracker-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .point-tracker-values {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .points-used {
            color: var(--primary-color);
        }

        .points-total {
            color: var(--text-secondary);
        }

        .points-remaining {
            padding: 5px 15px;
            border-radius: 20px;
            background-color: var(--bg-primary);
        }

        .points-remaining.over {
            background-color: #f8d7da;
            color: #dc3545;
        }

        .points-remaining.complete {
            background-color: #d4edda;
            color: #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.3s ease;
        }

        .progress-fill.over {
            background: linear-gradient(90deg, #dc3545, #ff6b6b);
        }

        .progress-fill.complete {
            background: linear-gradient(90deg, #28a745, #4caf50);
        }

        .validation-summary {
            margin-bottom: 20px;
        }

        .character-complete-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .character-complete-badge.incomplete {
            background-color: #fff3cd;
            color: #856404;
        }

        .character-complete-badge.complete {
            background-color: #d4edda;
            color: #155724;
        }

        .help-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 5px;
        }

        .expertises-section {
            margin-bottom: 20px;
        }

        .expertise-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .expertise-tag {
            padding: 8px 15px;
            background-color: var(--accent-color);
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expertise-remove {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            font-size: 1.2em;
            width: 20px;
            height: 20px;
        }

        .add-expertise {
            padding: 8px 15px;
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
        }

        .add-expertise:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Dice Roller Styles */
        .dice-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
            z-index: 999;
        }

        .dice-toggle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            border: 2px solid #ddd;
            font-size: 1.3em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            opacity: 0.7;
        }

        .dice-toggle:hover {
            transform: scale(1.05);
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .dice-toggle.active {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border-color: var(--accent-color);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transform: scale(1.1);
        }

        .dice-fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .dice-fab:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .dice-roller-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .dice-roller-modal.active {
            display: flex;
        }

        .talent-card, .talent-card-inline {
            transition: all 0.2s ease;
        }

        .talent-card:hover:not([style*="cursor: not-allowed"]),
        .talent-card-inline:hover:not([style*="cursor: not-allowed"]) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
            border-color: var(--primary-color) !important;
        }

        /* Equipment & Combat Styles */
        .equipment-section, .injuries-section, .connections-section, .character-details-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item-card {
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 15px;
        }

        .item-details {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .item-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .item-stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .item-stat-value {
            font-weight: bold;
            color: var(--text-primary);
        }

        .item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .currency-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .currency-input label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .currency-input input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100px;
        }

        .injuries-list, .conditions-list, .connections-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .injury-card, .condition-card, .connection-card {
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .condition-card {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .connection-card {
            background: #d1ecf1;
            border-color: #0c5460;
        }

        .armor-selector select {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
        }

        .weapon-selection-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .weapon-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .weapon-option:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .weapon-option-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .weapon-option-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .dice-roller-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .dice-roller-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .dice-roller-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .dice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .dice-button {
            padding: 15px;
            border: 2px solid var(--primary-color);
            background: white;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dice-button:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .dice-button:active {
            transform: translateY(0);
        }

        .modifier-section {
            margin-bottom: 20px;
        }

        .modifier-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modifier-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }

        .skill-quick-roll {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .skill-roll-btn {
            padding: 10px;
            border: 2px solid var(--accent-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .skill-roll-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .skill-roll-name {
            font-weight: bold;
            font-size: 0.9em;
        }

        .skill-roll-modifier {
            font-size: 1.1em;
            color: var(--success-color);
        }

        .roll-result {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .roll-result-total {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .roll-result-breakdown {
            font-size: 1em;
            opacity: 0.9;
        }

        .roll-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
        }

        .roll-history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .roll-history-item:last-child {
            border-bottom: none;
        }

        .roll-history-item strong {
            color: var(--primary-color);
        }

        .plot-die-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-color);
        }

        .plot-die-result {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .plot-die-icon {
            font-size: 2em;
        }

        /* Inline Dice Roller Icons */
        .inline-dice-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 8px;
            transition: all 0.2s;
            opacity: 0.7;
            vertical-align: middle;
        }

        .inline-dice-btn:hover {
            opacity: 1;
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .inline-dice-btn:active {
            transform: scale(0.95);
        }

        .inline-dice-btn.large {
            width: 32px;
            height: 32px;
            font-size: 1.1em;
        }

        .defense-row .inline-dice-btn,
        .resource-box .inline-dice-btn {
            margin-left: 10px;
        }

        .skill-row .inline-dice-btn {
            margin-left: 5px;
        }

        .attribute-box .inline-dice-btn {
            margin-left: 10px;
        }

        /* Toast notification for quick rolls */
        .roll-toast {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
        }

        .roll-toast.show {
            display: flex;
        }

        .roll-toast-content {
            position: relative;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 500px;
            animation: slideDown 0.3s ease;
        }

        .roll-toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
            transition: background 0.2s;
        }

        .roll-toast-close:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .roll-toast-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            padding-right: 30px;
        }

        .roll-toast-result {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .roll-toast-breakdown {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }

        .roll-toast.hiding .roll-toast-content {
            animation: slideOut 0.3s ease;
        }

        .roll-toast.hiding {
            animation: slideOut 0.3s ease;
        }

        @media (max-width: 768px) {
            .dice-controls {
                bottom: 20px;
                right: 20px;
                gap: 8px;
            }

            .dice-toggle {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }

            .dice-fab {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .dice-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .roll-toast {
                padding: 10px;
            }

            .roll-toast-content {
                min-width: 0;
                width: 100%;
                max-width: calc(100vw - 20px);
            }

            .inline-dice-btn {
                width: 20px;
                height: 20px;
                font-size: 0.8em;
            }
        }

        /* ===== COMBAT & PLAY SECTION (Tablet Optimized) ===== */
        .combat-play-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid var(--primary-color);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .combat-play-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .combat-play-header:hover {
            background: rgba(255,255,255,0.08);
        }

        .combat-play-header h2 {
            margin: 0;
            color: var(--accent-color);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-indicator {
            font-size: 1.2em;
            transition: transform 0.3s;
            color: var(--accent-color);
        }

        .combat-play-header.collapsed .collapse-indicator {
            transform: rotate(-90deg);
        }

        .combat-play-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s;
            opacity: 1;
        }

        .combat-play-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Compact Grid Layout for Tablet */
        .play-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .play-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .play-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .play-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(68,138,255,0.3);
            border-radius: 8px;
            padding: 12px;
        }

        .play-card-header {
            font-weight: bold;
            font-size: 0.95em;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .play-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            margin-bottom: 6px;
            min-height: 44px; /* Tablet touch target */
        }

        .play-stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .play-stat-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Touch-friendly dice buttons */
        .play-dice-btn {
            min-width: 44px;
            min-height: 44px;
            font-size: 1.3em;
            background: var(--accent-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-center: center;
            padding: 0;
        }

        .play-dice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .play-dice-btn:active {
            transform: scale(0.95);
        }

        /* Collapsible Section */
        .collapsible-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(68,138,255,0.2);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 12px 15px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: rgba(255,255,255,0.08);
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        .collapsible-content {
            max-height: 3000px;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 15px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 15px;
        }

        /* Action List */
        .action-list {
            display: grid;
            gap: 10px;
        }

        .action-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        .action-item.reaction {
            border-left-color: var(--secondary-color);
        }

        .action-item.free {
            border-left-color: var(--success-color);
        }

        .action-name {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-cost {
            font-size: 0.85em;
            color: var(--accent-color);
            font-weight: bold;
        }

        .action-description {
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Tablet Optimizations */
        @media (max-width: 1024px) {
            .combat-play-section {
                padding: 12px;
            }
            
            button, .play-dice-btn {
                min-width: 48px;
                min-height: 48px;
            }
            
            .play-stat-row {
                min-height: 48px;
            }
        }

        /* Character Building section (separate from play) */
        .character-building {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 3px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cosmere RPG Character Sheet</h1>
            <p>Stormlight Archive - Plotweaver System v1.01</p>
            <div class="header-controls">
                <button onclick="app.createNewCharacter()">‚ú® New Character</button>
                <button onclick="app.exportToFile()">üì• Export</button>
                <button onclick="app.importFromFile()">üì§ Import</button>
                <button class="danger" onclick="app.deleteCurrentCharacter()">üóëÔ∏è Delete Character</button>
            </div>
        </header>

        <div id="characterListSection" class="character-list">
            <h2>Your Characters</h2>
            <div id="characterListItems" class="character-list-items"></div>
        </div>

        <div id="characterSheetSection" class="sheet-container hidden">
            <div class="level-section">
                <div class="level-display">
                    Total Level <span id="characterLevel">0</span>
                    <span id="characterCompleteBadge" class="character-complete-badge incomplete">Incomplete</span>
                </div>
                <div>Tier: <span id="characterTier">Local Heroes</span></div>
                <div id="pathLevelsDisplay" style="margin: 10px 0; font-size: 0.9em;"></div>
                <div id="talentPointsDisplay" style="margin: 10px 0; font-size: 0.9em; padding: 8px; background: #f0f8ff; border-radius: 4px; border: 1px solid #d0e8ff;">
                    <strong>üíé Talent Points:</strong> <span id="talentPoints">0 available</span>
                </div>
            </div>

            <div id="validationSummary" class="validation-summary"></div>

            <!-- ===== COMBAT & PLAY SECTION (Optimized for Tablets) ===== -->
            <div class="combat-play-section" id="combatPlaySection">
                <div class="combat-play-header" onclick="app.toggleCombatPlay()">
                    <h2>‚öîÔ∏è Combat & Play</h2>
                    <span class="collapse-indicator">‚ñº</span>
                </div>
                
                <div class="combat-play-content" id="combatPlayContent">
                    <!-- Quick Stats Grid -->
                    <div class="play-grid">
                        <!-- Attributes Card -->
                        <div class="play-card">
                            <div class="play-card-header">‚ö° Attributes</div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">STR</span>
                                <span class="play-stat-value">
                                    <span id="playStrength">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('strength', document.getElementById('strength').value)" title="Roll Strength test">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">SPD</span>
                                <span class="play-stat-value">
                                    <span id="playSpeed">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('speed', document.getElementById('speed').value)" title="Roll Speed test">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">INT</span>
                                <span class="play-stat-value">
                                    <span id="playIntellect">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('intellect', document.getElementById('intellect').value)" title="Roll Intellect test">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">WIL</span>
                                <span class="play-stat-value">
                                    <span id="playWillpower">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('willpower', document.getElementById('willpower').value)" title="Roll Willpower test">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">AWR</span>
                                <span class="play-stat-value">
                                    <span id="playAwareness">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('awareness', document.getElementById('awareness').value)" title="Roll Awareness test">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">PRE</span>
                                <span class="play-stat-value">
                                    <span id="playPresence">2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttribute('presence', document.getElementById('presence').value)" title="Roll Presence test">üé≤</button>
                                </span>
                            </div>
                        </div>

                        <!-- Defenses & Combat Stats Card -->
                        <div class="play-card">
                            <div class="play-card-header">üõ°Ô∏è Defenses & Combat</div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Physical Def</span>
                                <span class="play-stat-value">
                                    <span id="playPhysicalDefense">14</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollDefense('Physical Defense', document.getElementById('physicalDefense').textContent)" title="Roll">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Cognitive Def</span>
                                <span class="play-stat-value">
                                    <span id="playCognitiveDefense">14</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollDefense('Cognitive Defense', document.getElementById('cognitiveDefense').textContent)" title="Roll">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Spiritual Def</span>
                                <span class="play-stat-value">
                                    <span id="playSpiritualDefense">14</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollDefense('Spiritual Defense', document.getElementById('spiritualDefense').textContent)" title="Roll">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Initiative</span>
                                <span class="play-stat-value">
                                    <span id="playInitiative">+2</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollInitiative(document.getElementById('initiative').textContent)" title="Roll Initiative">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Melee Attack</span>
                                <span class="play-stat-value">
                                    <span id="playMeleeAttack">+4</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttack('Melee', document.getElementById('meleeAttack').textContent)" title="Roll Melee Attack">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Ranged Attack</span>
                                <span class="play-stat-value">
                                    <span id="playRangedAttack">+4</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollAttack('Ranged', document.getElementById('rangedAttack').textContent)" title="Roll Ranged Attack">üé≤</button>
                                </span>
                            </div>
                        </div>

                        <!-- Resources Card -->
                        <div class="play-card">
                            <div class="play-card-header">üíé Resources</div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Health</span>
                                <span class="play-stat-value">
                                    <input type="number" id="playCurrentHealth" min="0" style="width: 50px; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 4px; color: white; padding: 4px;" onchange="document.getElementById('currentHealth').value = this.value; app.updateCharacter()">
                                    <span>/</span>
                                    <span id="playMaxHealth">16</span>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Focus</span>
                                <span class="play-stat-value">
                                    <input type="number" id="playCurrentFocus" min="0" style="width: 50px; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 4px; color: white; padding: 4px;" onchange="document.getElementById('currentFocus').value = this.value; app.updateCharacter()">
                                    <span>/</span>
                                    <span id="playMaxFocus">8</span>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Investiture</span>
                                <span class="play-stat-value">
                                    <input type="number" id="playCurrentInvestiture" min="0" style="width: 50px; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 4px; color: white; padding: 4px;" onchange="document.getElementById('currentInvestiture').value = this.value; app.updateCharacter()">
                                    <span>/</span>
                                    <span id="playMaxInvestiture">4</span>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Deflect</span>
                                <span class="play-stat-value" id="playDeflect">0</span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Recovery Die</span>
                                <span class="play-stat-value">
                                    <span id="playRecoveryDie">1d6</span>
                                    <button class="play-dice-btn" onclick="diceRoller.rollRecovery(document.getElementById('recoveryDie').textContent)" title="Roll Recovery Die">üé≤</button>
                                </span>
                            </div>
                            <div class="play-stat-row">
                                <span class="play-stat-label">Movement</span>
                                <span class="play-stat-value" id="playMovement">40 ft</span>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible Skills Section -->
                    <div class="collapsible-section" style="margin-top: 15px;">
                        <div class="collapsible-header" onclick="app.toggleSection('playSkills')">
                            <h3>üìö Skills</h3>
                            <span class="collapse-indicator" id="playSkillsIndicator">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="playSkillsContent">
                            <div id="playSkillsList"></div>
                        </div>
                    </div>

                    <!-- Collapsible Weapons Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="app.toggleSection('playWeapons')">
                            <h3>‚öîÔ∏è Weapons</h3>
                            <span class="collapse-indicator" id="playWeaponsIndicator">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="playWeaponsContent">
                            <div id="playWeaponsList"></div>
                        </div>
                    </div>

                    <!-- Collapsible Actions Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="app.toggleSection('playActions')">
                            <h3>üéØ Combat Actions</h3>
                            <span class="collapse-indicator" id="playActionsIndicator">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="playActionsContent">
                            <div class="action-list">
                                <!-- Actions (1-3 actions) -->
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Strike
                                    </div>
                                    <div class="action-description">Attack with unarmed or wielded weapon. Can use once per hand per turn (offhand costs 2 focus).</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Move
                                    </div>
                                    <div class="action-description">Move up to your movement rate. Slowed if crawling, climbing, swimming, or being stealthy.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Interact
                                    </div>
                                    <div class="action-description">Open door, pick up item, draw/sheathe weapon, pass item to ally, etc. No skill test usually required.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Use a Skill
                                    </div>
                                    <div class="action-description">Use any skill for challenging tasks: Perception to search, Stealth to hide, Medicine to treat, etc.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Brace
                                    </div>
                                    <div class="action-description">Hide behind cover within 5 ft. Attacks against you gain disadvantage until you move or attack.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Disengage
                                    </div>
                                    <div class="action-description">Move 5 feet without triggering Reactive Strikes.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Gain Advantage
                                    </div>
                                    <div class="action-description">Make a skill test against enemy's defense. On success, gain advantage on your next test using a different skill.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Shove
                                    </div>
                                    <div class="action-description">Athletics test vs target's Physical defense. On success, push or pull them 5 feet horizontally.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè</span>
                                        Grapple
                                    </div>
                                    <div class="action-description">Athletics test vs target's Physical defense. On success, they're Restrained until you're Unconscious, you release them, or they escape your reach.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè +varies</span>
                                        Ready
                                    </div>
                                    <div class="action-description">Prepare an action for a trigger. Costs the Ready action plus the action you're preparing.</div>
                                </div>
                                <div class="action-item">
                                    <div class="action-name">
                                        <span class="action-cost">‚óè‚óè</span>
                                        Recover
                                    </div>
                                    <div class="action-description">Roll your recovery die to restore health and/or focus. Can only use once per scene.</div>
                                </div>
                                
                                <!-- Free Actions -->
                                <div class="action-item free">
                                    <div class="action-name">
                                        <span class="action-cost">FREE</span>
                                        Banter
                                    </div>
                                    <div class="action-description">Speak briefly (couple sentences). For longer speech or persuasion, Use a Skill.</div>
                                </div>
                                <div class="action-item free">
                                    <div class="action-name">
                                        <span class="action-cost">FREE</span>
                                        Drop
                                    </div>
                                    <div class="action-description">Drop any number of objects you're holding.</div>
                                </div>
                                
                                <!-- Reactions -->
                                <div class="action-item reaction">
                                    <div class="action-name">
                                        <span class="action-cost">‚ö° REACTION</span>
                                        Aid
                                    </div>
                                    <div class="action-description">Spend 1 focus to grant an ally advantage on their test. Must be in range to assist.</div>
                                </div>
                                <div class="action-item reaction">
                                    <div class="action-name">
                                        <span class="action-cost">‚ö° REACTION</span>
                                        Avoid Danger
                                    </div>
                                    <div class="action-description">Agility test to dodge environmental hazard (falling boulder, shove, etc). DC 15 or attacker's test result.</div>
                                </div>
                                <div class="action-item reaction">
                                    <div class="action-name">
                                        <span class="action-cost">‚ö° REACTION</span>
                                        Dodge
                                    </div>
                                    <div class="action-description">Spend 1 focus to add disadvantage to an enemy's attack test against you. Can't use on area attacks.</div>
                                </div>
                                <div class="action-item reaction">
                                    <div class="action-name">
                                        <span class="action-cost">‚ö° REACTION</span>
                                        Reactive Strike
                                    </div>
                                    <div class="action-description">When enemy leaves your reach, spend 1 focus to make a melee weapon attack. Doesn't work on teleportation.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== CHARACTER BUILDING SECTION ===== -->
            <div class="character-building">
            <div class="point-tracker">
                <div class="point-tracker-header">
                    <div class="point-tracker-title">Attribute Points</div>
                    <div class="point-tracker-values">
                        <span class="points-used" id="attributePointsUsed">0</span>
                        <span>/</span>
                        <span class="points-total" id="attributePointsTotal">10</span>
                        <span class="points-remaining" id="attributePointsRemaining">10 remaining</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="attributeProgressBar" style="width: 0%"></div>
                </div>
                <div class="help-text">Starting characters have 12 attribute points to distribute (minimum 0, maximum 5 per attribute)</div>
            </div>

            <div class="point-tracker">
                <div class="point-tracker-header">
                    <div class="point-tracker-title">Skill Ranks</div>
                    <div class="point-tracker-values">
                        <span class="points-used" id="skillRanksUsed">0</span>
                        <span>/</span>
                        <span class="points-total" id="skillRanksTotal">0</span>
                        <span class="points-remaining" id="skillRanksRemaining">0 remaining</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="skillProgressBar" style="width: 0%"></div>
                </div>
                <div class="help-text">Skill ranks are gained through leveling and your chosen path</div>
            </div>

            <div class="point-tracker">
                <div class="point-tracker-header">
                    <div class="point-tracker-title">Talent Points</div>
                    <div class="point-tracker-values">
                        <span class="points-used" id="talentPointsUsed">0</span>
                        <span>/</span>
                        <span class="points-total" id="talentPointsTotal">0</span>
                        <span class="points-remaining" id="talentPointsRemaining">0 remaining</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="talentProgressBar" style="width: 0%"></div>
                </div>
                <div class="help-text" id="talentPointsBreakdown">Talents gained through leveling and ancestry bonuses</div>
            </div>

            <div class="sheet-header">
                <div class="input-group">
                    <label>Character Name</label>
                    <input type="text" id="characterName" placeholder="Enter name..." oninput="app.updateCharacter(); app.recalculateAll();">
                </div>
                <div class="input-group">
                    <label>Player Name</label>
                    <input type="text" id="playerName" placeholder="Your name..." onchange="app.updateCharacter()">
                </div>
                <div class="input-group">
                    <label>Ancestry</label>
                    <select id="ancestry" onchange="app.updateCharacter()"></select>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Culture</label>
                <select id="culture" onchange="app.updateCharacter()"></select>
            </div>

            <div class="stats-grid">
                <div class="stat-column physical">
                    <h3>Physical</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Strength</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="strength" min="0" max="5" value="2" oninput="app.updateAttributeValue('strength', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('strength', document.getElementById('strength').value)"
                                        title="Roll Strength test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Speed</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="speed" min="0" max="5" value="2" oninput="app.updateAttributeValue('speed', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('speed', document.getElementById('speed').value)"
                                        title="Roll Speed test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Physical Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="physicalDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Physical Defense', document.getElementById('physicalDefense').textContent)"
                                        title="Roll against Physical Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Physical Skills</h4>
                        <div id="physicalSkills"></div>
                    </div>
                </div>

                <div class="stat-column cognitive">
                    <h3>Cognitive</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Intellect</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="intellect" min="0" max="5" value="2" oninput="app.updateAttributeValue('intellect', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('intellect', document.getElementById('intellect').value)"
                                        title="Roll Intellect test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Willpower</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="willpower" min="0" max="5" value="2" oninput="app.updateAttributeValue('willpower', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('willpower', document.getElementById('willpower').value)"
                                        title="Roll Willpower test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Cognitive Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="cognitiveDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Cognitive Defense', document.getElementById('cognitiveDefense').textContent)"
                                        title="Roll against Cognitive Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Cognitive Skills</h4>
                        <div id="cognitiveSkills"></div>
                    </div>
                </div>

                <div class="stat-column spiritual">
                    <h3>Spiritual</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Awareness</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="awareness" min="0" max="5" value="2" oninput="app.updateAttributeValue('awareness', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('awareness', document.getElementById('awareness').value)"
                                        title="Roll Awareness test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Presence</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="presence" min="0" max="5" value="2" oninput="app.updateAttributeValue('presence', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('presence', document.getElementById('presence').value)"
                                        title="Roll Presence test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Spiritual Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="spiritualDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Spiritual Defense', document.getElementById('spiritualDefense').textContent)"
                                        title="Roll against Spiritual Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Spiritual Skills</h4>
                        <div id="spiritualSkills"></div>
                    </div>
                </div>
            </div>

            <div class="resources-section">
                <div class="resource-box">
                    <div class="resource-label">Health</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentHealth" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxHealth">16</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Focus</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentFocus" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxFocus">8</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Investiture</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentInvestiture" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxInvestiture">4</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Deflect</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="deflect" min="0" onchange="app.updateCharacter()">
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Recovery Die</div>
                    <div class="resource-values" style="flex-direction: column; gap: 10px;">
                        <div class="resource-max auto-calc" id="recoveryDie">1d6</div>
                        <button class="inline-dice-btn large" 
                                onclick="diceRoller.rollRecovery(document.getElementById('recoveryDie').textContent)"
                                title="Roll Recovery Die"
                                style="margin: 0 auto;">üé≤ Roll</button>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Movement</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="movement">40 ft</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Senses Range</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="sensesRange">80 ft</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Lifting Capacity</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="liftingCapacity">200 lbs</div>
                    </div>
                </div>
            </div>

            <!-- Equipment & Combat Section -->
            <div class="equipment-section">
                <h2>‚öîÔ∏è Equipment & Combat</h2>
                
                <!-- Starting Kit Selection -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                    <h3 style="margin-top: 0;">Starting Kit</h3>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="min-width: 100px;">Select Kit:</label>
                            <select id="startingKit" onchange="app.selectStartingKit(this.value)" style="flex: 1;">
                                <option value="">-- Choose a Starting Kit --</option>
                            </select>
                        </div>
                        <div id="startingKitDetails" style="display: none; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                            <!-- Kit details will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Attack Bonuses -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="resource-box">
                        <div class="resource-label">Melee Attack</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="meleeAttack">+4</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollAttack('Melee', document.getElementById('meleeAttack').textContent)"
                                    title="Roll melee attack">üé≤</button>
                        </div>
                    </div>
                    <div class="resource-box">
                        <div class="resource-label">Ranged Attack</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="rangedAttack">+4</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollAttack('Ranged', document.getElementById('rangedAttack').textContent)"
                                    title="Roll ranged attack">üé≤</button>
                        </div>
                    </div>
                    <div class="resource-box">
                        <div class="resource-label">Initiative</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="initiative">+2</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollInitiative(document.getElementById('initiative').textContent)"
                                    title="Roll initiative">üé≤</button>
                        </div>
                    </div>
                </div>

                <!-- Weapons -->
                <h3>üó°Ô∏è Weapons</h3>
                <div id="weaponsList" class="items-list"></div>
                <button onclick="app.addWeapon()" style="margin-top: 10px;">+ Add Weapon</button>

                <!-- Armor -->
                <h3 style="margin-top: 25px;">üõ°Ô∏è Armor</h3>
                <div class="armor-selector">
                    <label>Equipped Armor:</label>
                    <select id="equippedArmor" onchange="app.equipArmor(this.value)">
                        <option value="">None</option>
                    </select>
                    <div id="armorDetails" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;">
                        <div><strong>Deflect:</strong> <span id="armorDeflect">0</span></div>
                        <div><strong>Weight:</strong> <span id="armorWeight">0</span> lbs</div>
                        <div><strong>Traits:</strong> <span id="armorTraits">-</span></div>
                    </div>
                </div>

                <!-- Currency -->
                <h3 style="margin-top: 25px;">üíé Spheres (Currency)</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="currency-input">
                        <label>Chips (0.05 mk)</label>
                        <input type="number" id="chips" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div class="currency-input">
                        <label>Marks (1 mk)</label>
                        <input type="number" id="marks" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div class="currency-input">
                        <label>Broams (20 mk)</label>
                        <input type="number" id="broams" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div style="margin-left: auto; padding: 15px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 8px; color: #333; font-weight: bold;">
                        <div style="font-size: 0.85em;">Total Worth</div>
                        <div style="font-size: 1.3em;"><span id="totalMarks">0</span> marks</div>
                    </div>
                </div>

                <!-- Inventory (Collapsible) -->
                <div style="margin-top: 25px;">
                    <h3 style="cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(68,138,255,0.1); border-radius: 6px;" 
                        onclick="app.toggleInventory()">
                        <span>üéí Inventory</span>
                        <span id="inventoryToggleIcon" style="transition: transform 0.3s;">‚ñº</span>
                    </h3>
                    <div id="inventoryContent" style="margin-top: 10px;">
                        <div id="inventoryList" class="items-list"></div>
                        <button onclick="app.addInventoryItem()" style="margin-top: 10px;">+ Add Item</button>
                    </div>
                </div>
            </div>

            <!-- Injuries & Conditions Section -->
            <div class="injuries-section" style="margin-top: 30px;">
                <h2>ü©π Injuries & Conditions</h2>
                
                <h3>Injuries</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h4 style="margin: 10px 0;">Temporary Injuries</h4>
                        <div id="temporaryInjuries" class="injuries-list"></div>
                        <button onclick="app.addInjury('temporary')" style="margin-top: 10px;">+ Add Temporary Injury</button>
                    </div>
                    <div>
                        <h4 style="margin: 10px 0;">Permanent Injuries</h4>
                        <div id="permanentInjuries" class="injuries-list"></div>
                        <button onclick="app.addInjury('permanent')" style="margin-top: 10px;">+ Add Permanent Injury</button>
                    </div>
                </div>

                <h3 style="margin-top: 25px;">Conditions</h3>
                <div id="conditionsList" class="conditions-list"></div>
                <button onclick="app.addCondition()" style="margin-top: 10px;">+ Add Condition</button>
            </div>

            <!-- Connections Section -->
            <div class="connections-section" style="margin-top: 30px;">
                <h2>ü§ù Connections & Relationships</h2>
                <div class="help-text">Track important NPCs, allies, enemies, and other relationships</div>
                <div id="connectionsList" class="connections-list"></div>
                <button onclick="app.addConnection()" style="margin-top: 10px;">+ Add Connection</button>
            </div>

            <!-- Character Details Section -->
            <div class="character-details-section" style="margin-top: 30px;">
                <h2>üë§ Character Details</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="input-group">
                        <label>Age</label>
                        <input type="text" id="characterAge" placeholder="25" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Gender/Pronouns</label>
                        <input type="text" id="characterGender" placeholder="She/Her" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Height</label>
                        <input type="text" id="characterHeight" placeholder="5'8\"" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Weight</label>
                        <input type="text" id="characterWeight" placeholder="140 lbs" onchange="app.updateCharacter()">
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Physical Appearance</label>
                    <textarea id="characterAppearance" placeholder="Describe your character's appearance, distinguishing features, typical clothing, etc." 
                              onchange="app.updateCharacter()" style="min-height: 80px;"></textarea>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Backstory</label>
                    <textarea id="characterBackstory" placeholder="Your character's history, important life events, motivations, fears, etc." 
                              onchange="app.updateCharacter()" style="min-height: 100px;"></textarea>
                </div>
            </div>

            <div class="paths-section">
                <h2>Paths & Talents</h2>
                <div class="help-text" style="margin-bottom: 15px;">Select your character's heroic paths and radiant order. Each path grants unique talents.</div>
                
                <div id="pathsAndTalentsContainer"></div>

                <div class="path-selector" style="margin-top: 20px;">
                    <label>Add Path:</label>
                    <select id="addPathDropdown" onchange="app.addPath(this.value); this.value='';">
                        <option value="">-- Select a path to add --</option>
                        <optgroup label="Heroic Paths" id="heroicPathOptions"></optgroup>
                        <optgroup label="Radiant Orders" id="radiantOrderOptions"></optgroup>
                    </select>
                </div>
            </div>

            <div class="surges-section" id="surgesSection" style="display: none;">
                <h2>Surges</h2>
                <div class="help-text" style="margin-bottom: 15px;">
                    As a Radiant, you gain access to two surges based on your order. 
                    <strong>Surge ranks</strong> use skill rank increases (same pool as skills). 
                    <strong>Surge talents</strong> use talent points (same pool as path talents).
                </div>
                <div id="surgesContainer"></div>
            </div>

            <div class="expertises-section">
                <h2>Expertises</h2>
                <div class="expertise-list" id="expertiseList">
                    <button class="add-expertise" onclick="app.addExpertise()">+ Add Expertise</button>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Purpose</label>
                <input type="text" id="purpose" placeholder="Your character's driving purpose..." oninput="app.updateCharacter(); app.validateCharacter();">
                <div class="help-text">What drives your character? What is their ultimate goal?</div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Obstacle</label>
                <input type="text" id="obstacle" placeholder="Your character's main obstacle..." oninput="app.updateCharacter(); app.validateCharacter();">
                <div class="help-text">What stands in their way? What weakness or challenge must they overcome?</div>
            </div>

            <div class="notes-section">
                <h2>Goals</h2>
                <p class="help-text" style="margin-bottom: 15px;">
                    Goals represent tangible objectives your character is working toward. Each goal has 3 milestone checkboxes to track progress.
                </p>
                <div id="goalsList" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px;"></div>
                <button onclick="app.addGoal()" style="margin-bottom: 20px;">+ Add Goal</button>
                
                <h2>Notes</h2>
                <textarea class="notes-area" id="notes" placeholder="Additional notes..." onchange="app.updateCharacter()"></textarea>
            </div>
            </div><!-- End character-building -->
        </div><!-- End characterSheetSection -->
    </div><!-- End container -->

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="app.handleFileImport(event)">

    <!-- Dice Roller Controls -->
    <div class="dice-controls">
        <button id="plotDieToggle" class="dice-toggle" onclick="diceRoller.togglePlotDie()" title="Plot Die">
            üìñ
        </button>
        <button id="advantageToggle" class="dice-toggle" onclick="diceRoller.toggleAdvantage()" title="Advantage">
            ‚¨ÜÔ∏è
        </button>
        <button id="disadvantageToggle" class="dice-toggle" onclick="diceRoller.toggleDisadvantage()" title="Disadvantage">
            ‚¨áÔ∏è
        </button>
        <button class="dice-fab" onclick="diceRoller.open()" title="Dice Roller (D key)">üé≤</button>
    </div>

    <!-- Roll Toast Notification -->
    <div id="rollToast" class="roll-toast" onclick="if(event.target === this) diceRoller.hideToast()">
        <div class="roll-toast-content" onclick="event.stopPropagation()">
            <button class="roll-toast-close" onclick="diceRoller.hideToast()" title="Close (or click outside)">√ó</button>
            <div class="roll-toast-title" id="toastTitle">Roll Result</div>
            <div class="roll-toast-result" id="toastResult">15</div>
            <div class="roll-toast-breakdown" id="toastBreakdown">1d20+5</div>
        </div>
    </div>

    <!-- Weapon Selection Modal -->
    <div id="weaponModal" class="dice-roller-modal" onclick="if(event.target === this) app.closeWeaponModal()">
        <div class="dice-roller-content" style="max-width: 800px;">
            <div class="dice-roller-header">
                <h2>‚öîÔ∏è Select Weapon</h2>
                <button class="modal-close" onclick="app.closeWeaponModal()">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="weaponSearch" placeholder="Search weapons..." 
                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1em;"
                       oninput="app.filterWeapons(this.value)">
            </div>

            <div style="max-height: 60vh; overflow-y: auto;">
                <h3 style="color: var(--primary-color);">Light Weapons</h3>
                <div id="lightWeaponsList" class="weapon-selection-list"></div>
                
                <h3 style="color: var(--secondary-color); margin-top: 20px;">Heavy Weapons</h3>
                <div id="heavyWeaponsList" class="weapon-selection-list"></div>
            </div>
        </div>
    </div>

    <!-- Equipment/Item Modal -->
    <div id="itemModal" class="dice-roller-modal" onclick="if(event.target === this) app.closeItemModal()">
        <div class="dice-roller-content" style="max-width: 800px;">
            <div class="dice-roller-header">
                <h2>üéí Select Equipment</h2>
                <button class="modal-close" onclick="app.closeItemModal()">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="itemSearch" placeholder="Search equipment..." 
                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1em;"
                       oninput="app.filterItems(this.value)">
            </div>

            <div style="max-height: 60vh; overflow-y: auto;">
                <!-- Custom Item Option -->
                <div class="weapon-option" onclick="app.addCustomItem()" 
                     style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-weight: bold; margin-bottom: 20px; border: 2px solid #2e7d32;">
                    <div class="weapon-option-name" style="color: white;">‚ú® Custom Item (Free-form)</div>
                    <div class="weapon-option-stats" style="color: white; opacity: 0.95;">Add an item not in the standard list</div>
                </div>

                <h3 style="color: var(--primary-color);">Standard Equipment</h3>
                <div id="itemsList" class="weapon-selection-list"></div>
            </div>
        </div>
    </div>

    <!-- Condition Selection Modal -->
    <div id="conditionModal" class="dice-roller-modal" onclick="if(event.target === this) app.closeConditionModal()">
        <div class="dice-roller-content" style="max-width: 700px;">
            <div class="dice-roller-header">
                <h2>ü©π Select Condition</h2>
                <button class="modal-close" onclick="app.closeConditionModal()">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="conditionSearch" placeholder="Search conditions..." 
                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1em;"
                       oninput="app.filterConditions(this.value)">
            </div>

            <div style="max-height: 60vh; overflow-y: auto;">
                <div id="conditionSelectionList" class="weapon-selection-list"></div>
            </div>
        </div>
    </div>

    <!-- Dice Roller Modal -->
    <div id="diceRollerModal" class="dice-roller-modal" onclick="if(event.target === this) diceRoller.close()">
        <div class="dice-roller-content">
            <div class="dice-roller-header">
                <h2>üé≤ Dice Roller</h2>
                <button class="modal-close" onclick="diceRoller.close()">√ó</button>
            </div>

            <div id="rollResult" style="display: none;"></div>

            <h3>Quick Roll</h3>
            <div class="dice-grid">
                <button class="dice-button" onclick="diceRoller.roll('1d4')">d4</button>
                <button class="dice-button" onclick="diceRoller.roll('1d6')">d6</button>
                <button class="dice-button" onclick="diceRoller.roll('1d8')">d8</button>
                <button class="dice-button" onclick="diceRoller.roll('1d10')">d10</button>
                <button class="dice-button" onclick="diceRoller.roll('1d12')">d12</button>
                <button class="dice-button" onclick="diceRoller.roll('1d20')">d20</button>
            </div>

            <div class="plot-die-section">
                <h3 style="margin-top: 0;">Plot Die (Cosmere Mechanic)</h3>
                <p style="margin: 5px 0; font-size: 0.9em;">Roll with advantage/disadvantage based on plot die result</p>
                <button class="dice-button" style="width: 100%;" onclick="diceRoller.rollWithPlotDie()">
                    Roll d20 + Plot Die
                </button>
                <div id="plotDieResult"></div>
            </div>

            <div class="modifier-section">
                <h3>Custom Roll</h3>
                <div class="modifier-input-group">
                    <input type="text" class="modifier-input" id="customDiceInput" placeholder="e.g., 2d6+5, 1d20+3" value="1d20">
                    <button class="dice-button" style="width: auto; padding: 10px 20px;" onclick="diceRoller.rollCustom()">Roll</button>
                </div>
            </div>

            <div id="skillQuickRolls"></div>

            <h3>Roll History</h3>
            <div class="roll-history" id="rollHistory">
                <p style="text-align: center; color: #999;">No rolls yet</p>
            </div>
            <button style="margin-top: 10px;" onclick="diceRoller.clearHistory()">Clear History</button>
        </div>
    </div>

    <script>
        // Dice Roller System
        const diceRoller = {
            history: [],
            hasAdvantage: false,
            hasDisadvantage: false,
            hasPlotDie: false,

            toggleAdvantage: function() {
                this.hasAdvantage = !this.hasAdvantage;
                if (this.hasAdvantage) this.hasDisadvantage = false; // Mutex with disadvantage
                this.updateToggleUI();
            },

            toggleDisadvantage: function() {
                this.hasDisadvantage = !this.hasDisadvantage;
                if (this.hasDisadvantage) this.hasAdvantage = false; // Mutex with advantage
                this.updateToggleUI();
            },

            togglePlotDie: function() {
                this.hasPlotDie = !this.hasPlotDie;
                this.updateToggleUI();
            },

            updateToggleUI: function() {
                document.getElementById('advantageToggle').classList.toggle('active', this.hasAdvantage);
                document.getElementById('disadvantageToggle').classList.toggle('active', this.hasDisadvantage);
                document.getElementById('plotDieToggle').classList.toggle('active', this.hasPlotDie);
            },

            resetToggles: function() {
                this.hasAdvantage = false;
                this.hasDisadvantage = false;
                this.hasPlotDie = false;
                this.updateToggleUI();
            },

            open: function() {
                document.getElementById('diceRollerModal').classList.add('active');
                this.updateSkillQuickRolls();
            },

            close: function() {
                document.getElementById('diceRollerModal').classList.remove('active');
            },

            roll: function(diceNotation, label = '') {
                const result = this.parseDiceRoll(diceNotation);
                this.displayResult(result, label);
                this.addToHistory(result, label);
                return result;
            },

            rollCustom: function() {
                const input = document.getElementById('customDiceInput').value.trim();
                if (!input) return;
                this.roll(input, 'Custom Roll');
            },

            rollWithPlotDie: function() {
                const plotDieRoll = Math.floor(Math.random() * 6) + 1;
                let plotResult = '';
                let plotBonus = 0;

                // Plot die mechanics (6-sided)
                // 1-2: Complication with bonus, 3-4: Blank, 5-6: Opportunity
                if (plotDieRoll >= 5) {
                    plotResult = `‚≠ê Opportunity! (${plotDieRoll})`;
                } else if (plotDieRoll <= 2) {
                    plotBonus = plotDieRoll * 2;
                    plotResult = `‚ö†Ô∏è Complication! (+${plotBonus} bonus) (${plotDieRoll})`;
                } else {
                    plotResult = `Blank (${plotDieRoll}) - No effect`;
                }

                // Roll d20
                const d20Roll = Math.floor(Math.random() * 20) + 1;
                const finalRoll = d20Roll + plotBonus;
                
                let breakdown = `Plot Die: ${plotResult}<br>`;
                if (plotBonus > 0) {
                    breakdown += `d20: ${d20Roll} + ${plotBonus} (Complication bonus) = ${finalRoll}`;
                } else {
                    breakdown += `d20: ${d20Roll}`;
                }

                const result = {
                    total: finalRoll,
                    breakdown: breakdown,
                    dice: [d20Roll],
                    modifier: plotBonus,
                    diceRolls: [d20Roll]
                };

                this.displayResult(result, 'Plot Die Roll');
                this.addToHistory(result, 'Plot Die Roll');

                // Show plot die result
                document.getElementById('plotDieResult').innerHTML = `
                    <div class="plot-die-result">
                        <span class="plot-die-icon">üé≤</span>
                        <div>${plotResult}</div>
                    </div>
                `;
            },

            parseDiceRoll: function(notation) {
                notation = notation.toLowerCase().replace(/\s/g, '');
                
                // Parse notation like "2d6+5" or "1d20-2"
                const match = notation.match(/(\d+)?d(\d+)([\+\-]\d+)?/);
                
                if (!match) {
                    // Try just a modifier
                    if (/^[\+\-]?\d+$/.test(notation)) {
                        return {
                            total: parseInt(notation),
                            breakdown: `Flat modifier: ${notation}`,
                            dice: [],
                            modifier: parseInt(notation),
                            diceRolls: []
                        };
                    }
                    return null;
                }

                const numDice = parseInt(match[1]) || 1;
                const dieSize = parseInt(match[2]);
                const modifier = match[3] ? parseInt(match[3]) : 0;

                const rolls = [];
                for (let i = 0; i < numDice; i++) {
                    rolls.push(Math.floor(Math.random() * dieSize) + 1);
                }

                const diceTotal = rolls.reduce((sum, roll) => sum + roll, 0);
                const total = diceTotal + modifier;

                const breakdown = `${numDice}d${dieSize}${modifier >= 0 ? '+' : ''}${modifier !== 0 ? modifier : ''}<br>` +
                                `Rolls: [${rolls.join(', ')}] = ${diceTotal}` +
                                (modifier !== 0 ? `<br>Modifier: ${modifier >= 0 ? '+' : ''}${modifier}` : '');

                return {
                    total: total,
                    breakdown: breakdown,
                    dice: rolls,
                    modifier: modifier,
                    diceRolls: rolls
                };
            },

            displayResult: function(result, label) {
                if (!result) {
                    document.getElementById('rollResult').innerHTML = `
                        <div class="roll-result">
                            <div>Invalid dice notation</div>
                        </div>
                    `;
                    document.getElementById('rollResult').style.display = 'block';
                    return;
                }

                const resultHTML = `
                    <div class="roll-result">
                        ${label ? `<div style="font-size: 1.2em; margin-bottom: 10px;">${label}</div>` : ''}
                        <div class="roll-result-total">${result.total}</div>
                        <div class="roll-result-breakdown">${result.breakdown}</div>
                    </div>
                `;

                document.getElementById('rollResult').innerHTML = resultHTML;
                document.getElementById('rollResult').style.display = 'block';
            },

            addToHistory: function(result, label) {
                const timestamp = new Date().toLocaleTimeString();
                this.history.unshift({
                    result: result,
                    label: label,
                    timestamp: timestamp
                });

                // Keep only last 20 rolls
                if (this.history.length > 20) {
                    this.history = this.history.slice(0, 20);
                }

                this.updateHistoryDisplay();
            },

            updateHistoryDisplay: function() {
                const container = document.getElementById('rollHistory');
                
                if (this.history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No rolls yet</p>';
                    return;
                }

                container.innerHTML = this.history.map(entry => {
                    let resultDisplay;
                    if (entry.result.damageTotal !== undefined) {
                        // Weapon attack with damage
                        resultDisplay = `<strong>${entry.result.total}</strong> <span style="font-size: 0.8em; color: #999;">ATK</span> / <strong>${entry.result.damageTotal}</strong> <span style="font-size: 0.8em; color: #999;">DMG</span>`;
                    } else {
                        resultDisplay = `<strong>${entry.result.total}</strong>`;
                    }
                    
                    return `
                        <div class="roll-history-item">
                            ${resultDisplay} - ${entry.label || 'Roll'}
                            <span style="float: right; color: #999; font-size: 0.85em;">${entry.timestamp}</span>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${entry.result.breakdown.replace(/<br>/g, ', ').replace(/<\/?strong>/g, '')}</div>
                        </div>
                    `;
                }).join('');
            },

            clearHistory: function() {
                this.history = [];
                this.updateHistoryDisplay();
            },

            updateSkillQuickRolls: function() {
                if (!app.currentCharacter) return;

                const char = app.currentCharacter;
                const skills = app.rules.skills.list;

                // Get skills with ranks > 0 or significant modifiers
                const relevantSkills = skills.filter(skill => {
                    const rank = char.skills[skill.id] || 0;
                    const attr = char.attributes[skill.attribute] || 0;
                    return rank > 0 || attr > 0;
                }).slice(0, 12); // Show top 12

                if (relevantSkills.length === 0) return;

                const html = `
                    <h3>Quick Skill Rolls</h3>
                    <div class="skill-quick-roll">
                        ${relevantSkills.map(skill => {
                            const rank = char.skills[skill.id] || 0;
                            const attr = char.attributes[skill.attribute] || 0;
                            const modifier = attr + rank;
                            
                            return `
                                <button class="skill-roll-btn" onclick="diceRoller.rollSkill('${skill.id}', '${skill.name}', ${modifier})">
                                    <div class="skill-roll-name">${skill.name}</div>
                                    <div class="skill-roll-modifier">+${modifier}</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                `;

                document.getElementById('skillQuickRolls').innerHTML = html;
            },

            rollSkill: function(skillId, skillName, modifier) {
                const d20Roll = Math.floor(Math.random() * 20) + 1;
                const total = d20Roll + modifier;

                const result = {
                    total: total,
                    breakdown: `1d20 + ${modifier}<br>Roll: ${d20Roll} + Modifier: ${modifier}`,
                    dice: [d20Roll],
                    modifier: modifier,
                    diceRolls: [d20Roll]
                };

                this.displayResult(result, `${skillName} Test`);
                this.addToHistory(result, `${skillName} Test`);
            },

            // Inline rolling - shows toast instead of modal
            rollInline: function(notation, label, showToast = true) {
                let finalResult;
                let plotDieInfo = '';
                let plotBonus = 0;

                // Roll plot die if enabled
                if (this.hasPlotDie) {
                    const plotRoll = Math.floor(Math.random() * 6) + 1;
                    if (plotRoll >= 5) {
                        // 5-6: Opportunity
                        plotDieInfo = 'üìñ Plot Die: ‚≠ê Opportunity! ‚Ä¢ ';
                    } else if (plotRoll <= 2) {
                        // 1-2: Complication with bonus
                        plotBonus = plotRoll * 2; // +2 for roll of 1, +4 for roll of 2
                        plotDieInfo = `üìñ Plot Die: ‚ö†Ô∏è Complication! (+${plotBonus} bonus) ‚Ä¢ `;
                    } else {
                        // 3-4: Blank (no effect)
                        plotDieInfo = 'üìñ Plot Die: Blank (no effect) ‚Ä¢ ';
                    }
                }

                // Check if this is a d20 roll that can have advantage/disadvantage
                const isD20Roll = notation.toLowerCase().includes('d20');
                
                if (isD20Roll && (this.hasAdvantage || this.hasDisadvantage)) {
                    // Roll with advantage/disadvantage
                    const baseResult = this.parseDiceRoll(notation);
                    const secondResult = this.parseDiceRoll(notation);
                    
                    if (this.hasAdvantage) {
                        finalResult = baseResult.total >= secondResult.total ? baseResult : secondResult;
                        finalResult.breakdown = `‚¨ÜÔ∏è Advantage: [${baseResult.total}, ${secondResult.total}] ‚Üí Keep ${finalResult.total}`;
                    } else {
                        finalResult = baseResult.total <= secondResult.total ? baseResult : secondResult;
                        finalResult.breakdown = `‚¨áÔ∏è Disadvantage: [${baseResult.total}, ${secondResult.total}] ‚Üí Keep ${finalResult.total}`;
                    }
                    
                    // Apply plot die bonus
                    if (plotBonus > 0) {
                        finalResult.total += plotBonus;
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown + ` + ${plotBonus}`;
                    } else if (plotDieInfo) {
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown;
                    }
                } else {
                    finalResult = this.parseDiceRoll(notation);
                    if (!finalResult) return;
                    
                    // Apply plot die bonus
                    if (plotBonus > 0) {
                        finalResult.total += plotBonus;
                    }
                    
                    if (plotDieInfo) {
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown;
                    }
                }

                this.addToHistory(finalResult, label);

                if (showToast) {
                    this.showToast(finalResult, label);
                } else {
                    this.displayResult(finalResult, label);
                }

                // Reset toggles after integrated roll
                this.resetToggles();

                return finalResult;
            },

            showToast: function(result, label) {
                const toast = document.getElementById('rollToast');
                const title = document.getElementById('toastTitle');
                const resultElem = document.getElementById('toastResult');
                const breakdown = document.getElementById('toastBreakdown');

                title.textContent = label || 'Roll';
                
                // If this is a weapon attack with hit/graze/crit damage, show all values prominently
                if (result.hitDamage !== undefined && result.grazeDamage !== undefined && result.critDamage !== undefined) {
                    resultElem.innerHTML = `
                        <div style="font-size: 2em; font-weight: bold;">${result.total}</div>
                        <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                            Hit: ${result.hitDamage} dmg | Graze: ${result.grazeDamage} dmg | Crit ‚≠ê: ${result.critDamage} dmg
                        </div>
                    `;
                } else if (result.damageTotal !== undefined) {
                    resultElem.innerHTML = `${result.total} <span style="font-size: 0.7em; color: #999;">ATK</span> / ${result.damageTotal} <span style="font-size: 0.7em; color: #999;">DMG</span>`;
                } else {
                    resultElem.textContent = result.total;
                }
                
                breakdown.innerHTML = result.breakdown.replace(/<br>/g, ' ‚Ä¢ ');

                // Show toast (stays visible until manually dismissed)
                toast.classList.remove('hiding');
                toast.classList.add('show');
            },

            hideToast: function() {
                const toast = document.getElementById('rollToast');
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.classList.remove('show', 'hiding');
                }, 300);
            },

            rollAttribute: function(attrName, attrValue) {
                const label = attrName.charAt(0).toUpperCase() + attrName.slice(1) + ' Test';
                this.rollInline(`1d20+${attrValue}`, label);
            },

            rollDefense: function(defenseName, defenseValue) {
                const label = defenseName + ' Check';
                // For defense checks, just roll d20 (defense is the DC for opponents)
                this.rollInline('1d20', label);
            },

            rollRecovery: function(dieType) {
                this.rollInline(dieType, 'Recovery Roll');
            },

            rollWeaponAttack: function(weaponName, attackBonus, damage) {
                let plotDieInfo = '';
                let effectiveAdvantage = this.hasAdvantage;
                let effectiveDisadvantage = this.hasDisadvantage;

                // Roll plot die if enabled
                let plotBonus = 0;
                if (this.hasPlotDie) {
                    const plotRoll = Math.floor(Math.random() * 6) + 1;
                    if (plotRoll >= 5) {
                        // 5-6: Opportunity
                        plotDieInfo = 'üìñ Plot Die: ‚≠ê Opportunity!<br>';
                    } else if (plotRoll <= 2) {
                        // 1-2: Complication with bonus
                        plotBonus = plotRoll * 2; // +2 for roll of 1, +4 for roll of 2
                        plotDieInfo = `üìñ Plot Die: ‚ö†Ô∏è Complication! (+${plotBonus} bonus)<br>`;
                    } else {
                        // 3-4: Blank (no effect)
                        plotDieInfo = 'üìñ Plot Die: Blank (no effect)<br>';
                    }
                }

                // Roll attack (1d20 + bonus) with advantage/disadvantage
                let d20Roll, attackTotal, attackInfo;
                if (this.hasAdvantage || this.hasDisadvantage) {
                    const roll1 = Math.floor(Math.random() * 20) + 1;
                    const roll2 = Math.floor(Math.random() * 20) + 1;
                    
                    if (this.hasAdvantage) {
                        d20Roll = Math.max(roll1, roll2);
                        attackInfo = `‚¨ÜÔ∏è Advantage: [${roll1}, ${roll2}] ‚Üí ${d20Roll}`;
                    } else {
                        d20Roll = Math.min(roll1, roll2);
                        attackInfo = `‚¨áÔ∏è Disadvantage: [${roll1}, ${roll2}] ‚Üí ${d20Roll}`;
                    }
                    attackTotal = d20Roll + attackBonus + plotBonus;
                    if (plotBonus > 0) {
                        attackInfo += ` + ${attackBonus} + ${plotBonus}`;
                    } else {
                        attackInfo += ` + ${attackBonus}`;
                    }
                } else {
                    d20Roll = Math.floor(Math.random() * 20) + 1;
                    attackTotal = d20Roll + attackBonus + plotBonus;
                    if (plotBonus > 0) {
                        attackInfo = `1d20 (${d20Roll}) + ${attackBonus} + ${plotBonus}`;
                    } else {
                        attackInfo = `1d20 (${d20Roll}) + ${attackBonus}`;
                    }
                }
                
                // Roll damage
                const damageResult = this.parseDiceRoll(damage);
                
                const label = `${weaponName} Attack`;
                let breakdown = plotDieInfo + `<strong>Attack:</strong> ${attackInfo} = <strong>${attackTotal}</strong>`;
                
                if (damageResult) {
                    const hitDamage = damageResult.total + attackBonus; // Hit = dice + skill modifier
                    const grazeDamage = damageResult.total; // Graze = dice only
                    
                    // Calculate critical hit damage (maximize all dice)
                    const damageNotation = damage.toLowerCase().replace(/\s/g, '');
                    const damageMatch = damageNotation.match(/(\d+)?d(\d+)/);
                    let critDamage = attackBonus; // Start with modifier
                    if (damageMatch) {
                        const numDice = parseInt(damageMatch[1]) || 1;
                        const dieSize = parseInt(damageMatch[2]);
                        critDamage += numDice * dieSize; // All dice at maximum
                    }
                    
                    breakdown += `<br><strong>Damage (if hit):</strong> ${damageResult.breakdown.replace(/<br>/g, ' ')} + ${attackBonus} = <strong>${hitDamage}</strong>`;
                    breakdown += `<br><strong>Damage (if graze):</strong> ${damageResult.breakdown.replace(/<br>/g, ' ')} = <strong>${grazeDamage}</strong>`;
                    breakdown += `<br><strong>Damage (if crit ‚≠ê):</strong> Max dice + ${attackBonus} = <strong>${critDamage}</strong>`;
                } else {
                    breakdown += `<br><strong>Damage:</strong> ${damage}`;
                }
                
                const result = {
                    total: attackTotal,
                    damageTotal: damageResult ? damageResult.total : 0,
                    hitDamage: damageResult ? damageResult.total + attackBonus : 0,
                    grazeDamage: damageResult ? damageResult.total : 0,
                    critDamage: damageResult ? (() => {
                        const damageNotation = damage.toLowerCase().replace(/\s/g, '');
                        const damageMatch = damageNotation.match(/(\d+)?d(\d+)/);
                        if (damageMatch) {
                            const numDice = parseInt(damageMatch[1]) || 1;
                            const dieSize = parseInt(damageMatch[2]);
                            return numDice * dieSize + attackBonus;
                        }
                        return attackBonus;
                    })() : 0,
                    breakdown: breakdown,
                    diceRolls: [d20Roll, ...(damageResult ? damageResult.diceRolls : [])]
                };
                
                this.showToast(result, label);
                this.addToHistory(result, label);

                // Reset toggles after weapon attack
                this.resetToggles();
            },

            rollAttack: function(type, bonusStr) {
                const bonus = parseInt(bonusStr.replace('+', '')) || 0;
                const label = `${type} Attack Roll`;
                this.rollInline(`1d20+${bonus}`, label);
            },

            rollInitiative: function(bonusStr) {
                const bonus = parseInt(bonusStr.replace('+', '')) || 0;
                this.rollInline(`1d20+${bonus}`, 'Initiative');
            }
        };

        // Keyboard shortcut: Press 'D' to open dice roller
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
                // Don't trigger if typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                diceRoller.open();
            }
            // Press Escape to close
            if (e.key === 'Escape') {
                diceRoller.close();
            }
        });

        // Embedded rules data
        const COSMERE_RULES = {"version":"2.0","gameName":"Cosmere RPG - Stormlight","maxLevel":10,"attributes":{"list":[{"id":"strength","name":"Strength","abbr":"STR","category":"physical","description":"Physical power and resilience"},{"id":"speed","name":"Speed","abbr":"SPD","category":"physical","description":"Quickness and reflexes"},{"id":"intellect","name":"Intellect","abbr":"INT","category":"cognitive","description":"Applied intelligence and wit"},{"id":"willpower","name":"Willpower","abbr":"WIL","category":"cognitive","description":"Mental fortitude and determination"},{"id":"awareness","name":"Awareness","abbr":"AWA","category":"spiritual","description":"Perception and environmental awareness"},{"id":"presence","name":"Presence","abbr":"PRE","category":"spiritual","description":"Force of personality and charisma"}],"minValue":0,"maxValue":5,"startingTotal":12},"skills":{"list":[{"id":"agility","name":"Agility","category":"physical","attribute":"speed","description":"Acrobatics, climbing, and nimbleness"},{"id":"athletics","name":"Athletics","category":"physical","attribute":"strength","description":"Running, jumping, and physical prowess"},{"id":"heavy_weaponry","name":"Heavy Weaponry","category":"physical","attribute":"strength","description":"Large melee and ranged weapons"},{"id":"light_weaponry","name":"Light Weaponry","category":"physical","attribute":"speed","description":"Small melee and ranged weapons"},{"id":"stealth","name":"Stealth","category":"physical","attribute":"speed","description":"Hiding and moving undetected"},{"id":"crafting","name":"Crafting","category":"cognitive","attribute":"intellect","description":"Creating and repairing items"},{"id":"deduction","name":"Deduction","category":"cognitive","attribute":"intellect","description":"Logic and investigation"},{"id":"discipline","name":"Discipline","category":"cognitive","attribute":"willpower","description":"Self-control and composure"},{"id":"intimidation","name":"Intimidation","category":"cognitive","attribute":"willpower","description":"Threats and coercion"},{"id":"lore","name":"Lore","category":"cognitive","attribute":"intellect","description":"Knowledge and education"},{"id":"medicine","name":"Medicine","category":"cognitive","attribute":"intellect","description":"Healing and treating injuries"},{"id":"thievery","name":"Thievery","category":"physical","attribute":"speed","description":"Lockpicking and sleight of hand"},{"id":"perception","name":"Perception","category":"spiritual","attribute":"awareness","description":"Spotting details and danger"},{"id":"survival","name":"Survival","category":"spiritual","attribute":"awareness","description":"Wilderness skills and tracking"},{"id":"deception","name":"Deception","category":"spiritual","attribute":"presence","description":"Lying and misdirection"},{"id":"insight","name":"Insight","category":"spiritual","attribute":"awareness","description":"Reading people and motives"},{"id":"leadership","name":"Leadership","category":"spiritual","attribute":"presence","description":"Inspiring and commanding others"},{"id":"persuasion","name":"Persuasion","category":"spiritual","attribute":"presence","description":"Convincing and negotiating"}],"maxRanks":5},"defenses":{"physical":{"name":"Physical","base":10,"attributes":["strength","speed"]},"cognitive":{"name":"Cognitive","base":10,"attributes":["intellect","willpower"]},"spiritual":{"name":"Spiritual","base":10,"attributes":["awareness","presence"]}},"resources":{"health":{"baseValue":10,"perLevel":5,"attributeBonus":"strength"},"focus":{"baseValue":5,"perLevel":2,"attributeBonus":"willpower"},"investiture":{"baseValue":0,"perLevel":2,"note":"Radiant paths only"},"recoveryDie":{"progression":{"1":"1d6","4":"1d8","7":"1d10","10":"1d12"}}},"movement":{"baseSpeed":25,"note":"Base movement in feet, +5 per Speed"},"senses":{"baseRange":30,"note":"Base range in feet, +10 per Awareness"},"lifting":{"baseCapacity":100,"note":"Base capacity in lbs, +50 per Strength"},"heroicPaths":[{"id":"agent","name":"Agent","description":"Artists of duplicity and sabotage, Agents grasp the threads of fate in the palms of their hands","keyAttribute":"awareness","startingSkill":"insight","primarySkills":["stealth","thievery","deception","insight","deduction"],"keyTalent":{"id":"opportunist","name":"Opportunist","prerequisite":"none","activation":"special","description":"Once per round, when you roll a plot die, you can reroll that result. The original roll has no effect and you must use the new result."},"specialties":[{"id":"investigator","name":"Investigator","description":"Cultivate trustworthy instincts, learning to listen, collaborate, and pursue answers to questions others don't think to ask","talents":[{"id":"watchful_eye","name":"Watchful Eye","prerequisite":"Deduction 1+","activation":"reaction","description":"Use Opportunist on the plot die of a willing ally within 20 feet."},{"id":"get_em_talking","name":"Get 'Em Talking","prerequisite":"Insight 2+","activation":"2_actions","description":"Spend 1 focus to test Deduction vs. Spiritual to learn the target's motivation. During this scene, you can raise the stakes on tests to leverage this motivation."},{"id":"quick_analysis","name":"Quick Analysis","prerequisite":"Get 'Em Talking","activation":"free_action","description":"Spend 2 focus to gain momentum for cognitive tests with Use a Skill, Gain Advantage, or an Agent talent."},{"id":"baleful","name":"Baleful","prerequisite":"Get 'Em Talking","activation":"always","description":"To resist your influence, a character must spend additional focus equal to your tier."},{"id":"gather_evidence","name":"Gather Evidence","prerequisite":"Insight 2+, Quick Analysis","activation":"always","description":"Gain Legal Codes expertise. When you succeed on a cognitive test against a target, you become Focused until the end of your next turn."},{"id":"hardy_agent","name":"Hardy","prerequisite":"none","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"sleuths_instincts","name":"Sleuth's Instincts","prerequisite":"Deduction 3+","activation":"always","description":"Gain an advantage on cognitive tests against characters whose motivation you know. You know when those characters lie to you."},{"id":"close_the_case","name":"Close the Case","prerequisite":"Deduction 3+, Hardy","activation":"1_action","description":"Spend 3 focus to test Deduction vs. Cognitive, gaining an advantage if you know the target's motivation. On failure, the target gains an advantage against you. On success, they back down."}]},{"id":"spy","name":"Spy","description":"Plant themselves in sticky situations, ready to deflect or ease suspicion when it inevitably sweeps their way","talents":[{"id":"sure_outcome","name":"Sure Outcome","prerequisite":"Insight 2+","activation":"special","description":"When you use Opportunist, spend 2 focus to change opportunity to 4, or change any result to opportunity."},{"id":"plausible_excuse","name":"Plausible Excuse","prerequisite":"Deception 1+","activation":"free_action","description":"Gain Sleight of Hand expertise. When discovered skulking, spend 2 focus to feign innocence."},{"id":"collected_agent","name":"Collected","prerequisite":"none","activation":"always","description":"Increase your Cognitive and Spiritual defenses by 2."},{"id":"cover_story","name":"Cover Story","prerequisite":"none","activation":"always","description":"Gain a false identity and a relevant cultural expertise."},{"id":"subtle_takedown","name":"Subtle Takedown","prerequisite":"Insight 3+","activation":"1_action","description":"Make an unarmed attack with Insight vs. an unsuspecting target's Cognitive, raising the stakes. On a hit, they can't communicate."},{"id":"mighty_agent","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"mercurial_facade","name":"Mercurial Facade","prerequisite":"Deception 3+","activation":"1_action","description":"Disguise yourself using Deception without needing physical supplies. The first character to see through your disguise is Surprised."},{"id":"high_society_contacts_agent","name":"High Society Contacts","prerequisite":"Patron in high society","activation":"special","description":"Gain High Society expertise. Spend 2 focus to add opportunity to a test to interact in high society."}]},{"id":"thief","name":"Thief","description":"Train their bodies to keep pace with their quick minds, risking it all to swindle insurmountable odds","talents":[{"id":"risky_behavior","name":"Risky Behavior","prerequisite":"Insight 2+","activation":"special","description":"Spend 1 focus to raise the stakes on your test."},{"id":"cheap_shot","name":"Cheap Shot","prerequisite":"none","activation":"1_action","description":"Spend 1 focus to make an unarmed attack with Thievery vs. Cognitive, raising the stakes. On a hit, the target is Stunned."},{"id":"double_down","name":"Double Down","prerequisite":"none","activation":"special","description":"You can reroll again with Opportunist, but on complication, you lose 2 focus."},{"id":"surefooted_agent","name":"Surefooted","prerequisite":"none","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"underworld_contacts","name":"Underworld Contacts","prerequisite":"Patron or follower in criminal underworld","activation":"special","description":"Gain Criminal Groups expertise. Spend 2 focus to add opportunity to a social test against criminals."},{"id":"shadow_step","name":"Shadow Step","prerequisite":"Thievery 3+","activation":"special","description":"After you Disengage, spend 2 focus to test Thievery vs. each enemy's Cognitive to hide from them. You gain an advantage if in cover or obscured."},{"id":"fast_talker","name":"Fast Talker","prerequisite":"Insight 3+","activation":"free_action","description":"Spend 2 focus to gain momentum for spiritual tests with Use a Skill, Gain Advantage, or an Agent talent."},{"id":"tricksters_hand","name":"Trickster's Hand","prerequisite":"Thievery 3+","activation":"free_action","description":"Spend 2 focus to gain momentum for physical tests with Use a Skill, Gain Advantage, or an Agent talent."}]}]},{"id":"envoy","name":"Envoy","description":"Prominent organizations appoint Envoys who vie for resources, curry favor, or offer service on the organization's behalf","keyAttribute":"presence","startingSkill":"discipline","primarySkills":["discipline","leadership","persuasion","deception","lore"],"keyTalent":{"id":"rousing_presence","name":"Rousing Presence","prerequisite":"none","activation":"free_action","description":"Choose an ally you can influence. They become Determined until they benefit from that condition or until the scene ends."},"specialties":[{"id":"diplomat","name":"Diplomat","description":"Adept at navigating court politics, using what they learn to seek favorable treatment","talents":[{"id":"steadfast_challenge","name":"Steadfast Challenge","prerequisite":"Discipline 1+","activation":"1_action","description":"Spend 1 focus to test Discipline vs. an enemy's Spiritual. On success, they are Disoriented and gain a disadvantage on tests against you."},{"id":"collected_envoy","name":"Collected","prerequisite":"none","activation":"always","description":"Increase your Cognitive and Spiritual defenses by 2."},{"id":"withering_retort","name":"Withering Retort","prerequisite":"Discipline 2+, Steadfast Challenge","activation":"reaction","description":"Use your Steadfast Challenge before an attack and increase your deflect against the attack by your ranks in Discipline."},{"id":"well_dressed_envoy","name":"Well Dressed","prerequisite":"none","activation":"always","description":"Gain Fashion expertise. While wearing Presentable armor or fashionable clothing, gain an advantage on your first Deception, Leadership, or Persuasion test."},{"id":"calm_appeal","name":"Calm Appeal","prerequisite":"Discipline 2+, Withering Retort","activation":"special","description":"When your Steadfast Challenge makes a target Disoriented, spend 1 focus to pacify them. Resisting your Steadfast Challenge costs additional focus equal to your ranks in Discipline."},{"id":"high_society_contacts_envoy","name":"High Society Contacts","prerequisite":"Patron in high society, Well Dressed","activation":"special","description":"Gain High Society expertise. Spend 2 focus to add opportunity to a test to interact in high society."},{"id":"peaceful_solution","name":"Peaceful Solution","prerequisite":"Discipline 3+, Calm Appeal","activation":"special","description":"If all non-minion enemies are pacified, you ease tensions and end combat."},{"id":"practiced_oratory","name":"Practiced Oratory","prerequisite":"Persuasion 3+","activation":"special","description":"When you use Rousing Presence or Steadfast Challenge, spend focus up to your ranks in Persuasion to add that many targets."}]},{"id":"faithful","name":"Faithful","description":"Devote themselves to traditions of their faith, demonstrating convictions through word or deed","talents":[{"id":"customary_garb_envoy","name":"Customary Garb","prerequisite":"none","activation":"always","description":"While wearing Presentable armor or appropriate clothing, increase your Physical and Spiritual defenses by 2."},{"id":"galvanize","name":"Galvanize","prerequisite":"none","activation":"1_action","description":"An ally rolls their recovery die and recovers that much focus."},{"id":"devoted_presence","name":"Devoted Presence","prerequisite":"Lore 1+","activation":"special","description":"When you use Rousing Presence, spend 1 focus to remove Prone, Slowed, Stunned, and Surprised from your target."},{"id":"composed_envoy","name":"Composed","prerequisite":"none","activation":"always","description":"Increase your max and current focus by your tier."},{"id":"stalwart_presence","name":"Stalwart Presence","prerequisite":"Discipline 2+","activation":"special","description":"When you use Rousing Presence, spend 1 focus to increase one of the target's defenses by 2."},{"id":"applied_motivation","name":"Applied Motivation","prerequisite":"Discipline 2+","activation":"always","description":"When you cause a character to recover focus, they recover additional focus equal to half your ranks in Lore."},{"id":"sage_counsel","name":"Sage Counsel","prerequisite":"Lore 3+","activation":"special","description":"When you Aid a character, spend 1 focus to grant them Rousing Presence."},{"id":"inspired_zeal","name":"Inspired Zeal","prerequisite":"Discipline 3+","activation":"always","description":"When an ally uses Determined, choose other allies to recover 1 focus, up to your ranks in Discipline."}]},{"id":"mentor","name":"Mentor","description":"Devote themselves to their wards, patiently nurturing others toward greatness","talents":[{"id":"sound_advice","name":"Sound Advice","prerequisite":"none","activation":"special","description":"Spend 1 focus to use Rousing Presence on an ally who failed a skill test."},{"id":"practical_demonstration","name":"Practical Demonstration","prerequisite":"Leadership 1+","activation":"special","description":"When you Gain Advantage or hit with an attack, use your Rousing Presence as a free action."},{"id":"lessons_in_patience","name":"Lessons in Patience","prerequisite":"Discipline 2+","activation":"special","description":"Gain Motivational Speech expertise. When you use Rousing Presence, your target recovers 1 focus."},{"id":"mighty_envoy","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"instill_confidence","name":"Instill Confidence","prerequisite":"A companion","activation":"special","description":"Rousing Presence can make an ally Focused instead of Determined."},{"id":"guiding_oration","name":"Guiding Oration","prerequisite":"Leadership 2+","activation":"always","description":"After you Gain Advantage, an ally within 10 feet of your target gains an advantage on their next test against your target."},{"id":"foresight","name":"Foresight","prerequisite":"Discipline 3+","activation":"always","description":"Gain an additional action each turn."},{"id":"rallying_shout","name":"Rallying Shout","prerequisite":"Leadership 3+","activation":"special","description":"Rousing Presence can revive an Unconscious ally, and if they have 0 health, they recover health equal to their recovery die + your ranks in Leadership."}]}]},{"id":"hunter","name":"Hunter","description":"The thrill of the chase thrums in a Hunter's mind as they patiently surveil","keyAttribute":"awareness","startingSkill":"perception","primarySkills":["perception","stealth","survival","agility","light_weaponry"],"keyTalent":{"id":"seek_quarry","name":"Seek Quarry","prerequisite":"none","activation":"special","description":"After spending 1 minute mentally preparing, you choose a character who you can sense or who you've previously encountered. That character becomes your quarry. You gain an advantage on tests made to find, attack, or study your quarry."},"specialties":[{"id":"archer","name":"Archer","description":"Shape the battlefield before frontline confrontation, steadily unleashing a torrent of arrows","talents":[{"id":"tagging_shot","name":"Tagging Shot","prerequisite":"Perception 2+","activation":"1_action","description":"Move 5 feet and make a ranged attack. On a hit or a graze, the target becomes your quarry."},{"id":"combat_training_hunter","name":"Combat Training","prerequisite":"none","activation":"always","description":"Gain expertise in a weapon, an armor, and Military Life. Once per round, graze without spending focus."},{"id":"sharp_eye","name":"Sharp Eye","prerequisite":"Tagging Shot","activation":"special","description":"Observe a target then test Perception vs. Cognitive to learn their lowest attribute, lowest defense, or if their health, focus, or Investiture are below half."},{"id":"steady_aim","name":"Steady Aim","prerequisite":"Agility 1+, Combat Training","activation":"always","description":"Increase your weapon range by half and deal extra damage equal to your ranks in Perception."},{"id":"exploit_weakness","name":"Exploit Weakness","prerequisite":"Perception 3+, Sharp Eye","activation":"free_action","description":"Gain Advantage on your quarry without spending actions."},{"id":"backstep","name":"Backstep","prerequisite":"Agility 2+, Steady Aim","activation":"special","description":"After making a ranged attack, spend 2 focus to Disengage without spending actions, and Brace if you enter cover or obscured area."},{"id":"unrelenting_salvo","name":"Unrelenting Salvo","prerequisite":"Agility 3+, Hardy","activation":"always","description":"You can Strike your quarry more than once per turn with the same ranged weapon."},{"id":"hardy_hunter","name":"Hardy","prerequisite":"Steady Aim","activation":"always","description":"Gain +1 max health per level (including previous levels)."}]},{"id":"assassin","name":"Assassin","description":"Exploit weaknesses to quickly incapacitate their quarry","talents":[{"id":"startling_blow","name":"Startling Blow","prerequisite":"Stealth 1+","activation":"1_action","description":"Make an unarmed or improvised weapon attack vs. Cognitive. On a hit or graze, the target is Surprised."},{"id":"killing_edge","name":"Killing Edge","prerequisite":"Perception 2+","activation":"always","description":"Gain Knives and Slings expertises. These weapons gain the Deadly and Quickdraw expert traits."},{"id":"fatal_thrust","name":"Fatal Thrust","prerequisite":"Perception 3+","activation":"1_action","description":"Attack an unsuspecting target with a light melee weapon vs. Cognitive. Add 4d4 damage, and gain two advantages if the weapon is Discreet. Max damage rolls add a penalty to the injury roll."},{"id":"shadowing","name":"Shadowing","prerequisite":"Stealth 2+","activation":"always","description":"Your quarry gains a disadvantage to sense you, and you gain an advantage to avoid their notice. When you succeed vs. Spiritual while in cover or obscured, spend 3 focus to designate that target as your quarry."},{"id":"mighty_hunter","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"cold_eyes","name":"Cold Eyes","prerequisite":"none","activation":"always","description":"After you defeat your quarry, recover 1 focus and choose a new quarry."},{"id":"swift_strikes_hunter","name":"Swift Strikes","prerequisite":"none","activation":"special","description":"Spend 1 focus to make a second Strike with the same weapon."},{"id":"sidestep","name":"Sidestep","prerequisite":"Stealth 3+","activation":"always","description":"Gain an additional action to Dodge when you're not wearing armor with deflect of 2 or higher."}]},{"id":"tracker","name":"Tracker","description":"In untamed wilds, none are more capable, with trusty animal companions at their sides","talents":[{"id":"deadly_trap","name":"Deadly Trap","prerequisite":"Survival 1+","activation":"1_action","description":"Conceal a 5-foot entangling or impaling trap. Entangling Trap: Test Survival vs. Cognitive, roll 2d4 impact damage, target is Immobilized. Impaling Trap: Test Survival vs. Physical, roll 2d4 keen damage, target is Afflicted."},{"id":"animal_bond","name":"Animal Bond","prerequisite":"Animal companion","activation":"always","description":"While your companion is within 10 feet, your defenses increase by 1. Use free action to give your companion momentum or actions on your turn. They can use Track as free action to make a target your quarry."},{"id":"experienced_trapper","name":"Experienced Trapper","prerequisite":"Perception 2+","activation":"always","description":"You easily forage for characters up to your ranks in Survival. You can fashion natural tools using Survival. Your Deadly Traps increase to 2d6 damage and 2 rounds duration."},{"id":"protective_bond","name":"Protective Bond","prerequisite":"Animal Bond","activation":"always","description":"Your animal companion protects an ally within 30 feet of you, and that ally gains your Animal Bond bonus instead of you."},{"id":"hunters_edge","name":"Hunter's Edge","prerequisite":"Survival 3+","activation":"always","description":"Your animal companion gains an advantage against your quarry. Your Deadly Traps increase to 2d8 damage and 3 rounds duration."},{"id":"pack_hunting","name":"Pack Hunting","prerequisite":"Perception 3+","activation":"special","description":"Spend 1 focus to add your ranks in Survival to your ally's attack or damage roll against your quarry."},{"id":"surefooted_hunter","name":"Surefooted","prerequisite":"none","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"feral_connection","name":"Feral Connection","prerequisite":"Survival 2+","activation":"always","description":"Gain expertise in Animal Care. Your animal companion's health increases by 5 \u00d7 your tier, their defenses increase by 2, and their tests gain a bonus equal to your ranks in Survival."}]}]},{"id":"leader","name":"Leader","description":"Beacons of encouragement and direction, Leaders oversee the efforts of others","keyAttribute":"presence","startingSkill":"leadership","primarySkills":["leadership","persuasion","intimidation","athletics","heavy_weaponry"],"keyTalent":{"id":"decisive_command","name":"Decisive Command","prerequisite":"none","activation":"1_action","description":"Gain a command die (d4). Spend 1 focus to choose an ally you can influence within 20 feet. The next time they make a test before the end of their next turn, they can roll your command die and add it to one die roll from that test (other than the plot die)."},"specialties":[{"id":"champion","name":"Champion","description":"Inspiring others through unfaltering grit, ferociously charging their foes","talents":[{"id":"combat_coordination","name":"Combat Coordination","prerequisite":"Leadership 2+","activation":"special","description":"After you Strike, use Decisive Command as free action. If your Strike didn't hit, you also don't spend focus."},{"id":"valiant_intervention","name":"Valiant Intervention","prerequisite":"Athletics 1+","activation":"1_action","description":"Spend 1 focus to move 10 feet, then test Athletics vs. Spiritual to give a target a disadvantage on tests against your allies."},{"id":"imposing_posture","name":"Imposing Posture","prerequisite":"Athletics 2+, Combat Coordination","activation":"always","description":"After an enemy resists your influence while in your weapon's reach, they are Disoriented until the end of their next turn."},{"id":"hardy_leader","name":"Hardy","prerequisite":"Valiant Intervention","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"mighty_leader","name":"Mighty","prerequisite":"Imposing Posture","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"resolute_stand","name":"Resolute Stand","prerequisite":"Athletics 1+","activation":"special","description":"Valiant Intervention prevents Reactive Strikes. Spend focus up to your ranks in Leadership to add that many targets for Valiant Intervention."},{"id":"resilient_hero","name":"Resilient Hero","prerequisite":"Athletics 3+, Resolute Stand","activation":"reaction","description":"Once per scene, before your health drops to 0, it instead becomes equal to your Athletics modifier."},{"id":"demonstrative_command","name":"Demonstrative Command","prerequisite":"Leadership 2+, Resolute Stand","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Athletics, Agility, or Leadership d20 roll."}]},{"id":"officer","name":"Officer","description":"Coolly maintain order in utter chaos, orchestrating the march to victory","talents":[{"id":"composed_leader","name":"Composed","prerequisite":"none","activation":"always","description":"Increase your max and current focus by your tier."},{"id":"through_the_fray","name":"Through the Fray","prerequisite":"Persuasion 1+","activation":"free_action","description":"An ally within 20 feet can Disengage or Gain Advantage as free action."},{"id":"well_supplied","name":"Well Supplied","prerequisite":"Persuasion 2+","activation":"special","description":"Gain Military Logistics expertise. Spend 2 focus to add opportunity to your test to requisition resources."},{"id":"customary_garb_leader","name":"Customary Garb","prerequisite":"none","activation":"always","description":"While wearing Presentable armor or appropriate clothing, increase your Physical and Spiritual defenses by 2."},{"id":"relentless_march","name":"Relentless March","prerequisite":"Persuasion 3+","activation":"always","description":"Decisive Command increases your target's movement by 10 feet, and they ignore Exhausted, Slowed, and Surprised."},{"id":"confident_command","name":"Confident Command","prerequisite":"Leadership 2+","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Intimidation, Leadership, or Persuasion d20 roll."},{"id":"synchronized_assault","name":"Synchronized Assault","prerequisite":"Leadership 3+","activation":"2_actions","description":"Spend 2 focus to test Leadership vs. enemy's Cognitive. On success, allies up to your ranks in Leadership gain momentum for an additional Strike against the target. On failure, only one ally gains momentum."},{"id":"authority","name":"Authority","prerequisite":"Title granting you command of 5+ people","activation":"always","description":"Double the range of Leader talents that affect allies, and double the number of allies affected."}]},{"id":"politico","name":"Politico","description":"With a penchant for theatrics, chase favor and prestige while subtly undermining enemies","talents":[{"id":"cutthroat_tactics","name":"Cutthroat Tactics","prerequisite":"Deception 1+","activation":"special","description":"Your ally can raise the stakes instead of rolling your command die; if they roll complication, you recover 1 focus."},{"id":"tactical_ploy","name":"Tactical Ploy","prerequisite":"none","activation":"1_action","description":"Test Deception vs. Cognitive to make your target lose one action and gain a disadvantage on their next cognitive or spiritual test."},{"id":"rumormonger","name":"Rumormonger","prerequisite":"A patron","activation":"special","description":"Gain Scandal expertise. Spend 2 focus to add opportunity when you make a test to spread misinformation or gather rumors."},{"id":"well_dressed_leader","name":"Well Dressed","prerequisite":"none","activation":"always","description":"Gain Fashion expertise. While wearing Presentable armor or fashionable clothing, gain an advantage on your first Deception, Leadership, or Persuasion test."},{"id":"baleful_leader","name":"Baleful","prerequisite":"none","activation":"always","description":"To resist your influence, a character must spend additional focus equal to your tier."},{"id":"set_at_odds","name":"Set at Odds","prerequisite":"Leadership 3+","activation":"special","description":"Spend focus equal to the number of targets you want to seed division among. Test Leadership vs. their highest Spiritual to make them hostile to each other."},{"id":"shrewd_command","name":"Shrewd Command","prerequisite":"Leadership 2+","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Deception, Insight, or Leadership d20 roll."},{"id":"grand_deception","name":"Grand Deception","prerequisite":"Deception 3+","activation":"3_actions","description":"Spend 3 focus to test Deception (DC 15) to reveal a ruse that changes a detail."}]}]},{"id":"scholar","name":"Scholar","description":"Creativity, acumen, and patience are hallmarks of legendary Scholars","keyAttribute":"intellect","startingSkill":"lore","primarySkills":["lore","deduction","crafting","medicine"],"keyTalent":{"id":"erudition","name":"Erudition","prerequisite":"none","activation":"always","description":"Choose one cultural or utility expertise you don't already have, and choose two different cognitive skills that aren't surge skills. When you make a test, you count as having the chosen expertise and one additional rank of each chosen skill. After a long rest with library access, you can reassign these."},"specialties":[{"id":"artifabrian","name":"Artifabrian","description":"Combining science, engineering, and artistry, construct fabrials that perform precise functions","talents":[{"id":"efficient_engineer","name":"Efficient Engineer","prerequisite":"Crafting 1+","activation":"always","description":"Gain expertise in Armor Crafting, Equipment Crafting, or Weapon Crafting, and gain a fabrial. When crafting, your Opportunity range expands by 2 and your material cost is halved."},{"id":"prized_acquisition","name":"Prized Acquisition","prerequisite":"none","activation":"always","description":"Gain Fabrial Crafting expertise. Gain a special gem you can immediately use to craft a fabrial of your tier. You can reuse this gem for new fabrials."},{"id":"deep_study","name":"Deep Study","prerequisite":"Efficient Engineer","activation":"always","description":"Erudition grants you an additional cultural or utility expertise and two additional non-surge cognitive skills."},{"id":"inventive_design","name":"Inventive Design","prerequisite":"Crafting 2+, Prized Acquisition","activation":"always","description":"Your Prized Acquisition fabrial can have an effect 1 tier higher than the tier you're currently crafting."},{"id":"fine_handiwork","name":"Fine Handiwork","prerequisite":"Efficient Engineer","activation":"always","description":"When crafting, advanced features cost one upgrade instead of two."},{"id":"overcharge","name":"Overcharge","prerequisite":"Crafting 3+, Prized Acquisition","activation":"special","description":"Once per turn, you can raise the stakes on a fabrial attack, then spend opportunity to Strike with that fabrial as free action."},{"id":"experimental_tinkering","name":"Experimental Tinkering","prerequisite":"Fine Handiwork","activation":"always","description":"When crafting, your Opportunity range expands by 1 and your crafting time is halved. During a long rest, you can reconfigure your Prized Acquisition fabrial to a different fabrial."},{"id":"overwhelm_with_details","name":"Overwhelm with Details","prerequisite":"Lore 3+, Experimental Tinkering","activation":"special","description":"Spend 2 focus to use your Lore modifier on another cognitive or spiritual test."}]},{"id":"strategist","name":"Strategist","description":"Always three steps ahead, knowing timing is everything","talents":[{"id":"strategize","name":"Strategize","prerequisite":"none","activation":"1_action","description":"Test Deduction vs. Cognitive to learn one of target's defenses, health, focus, or Investiture. On opportunity, learn all."},{"id":"mind_and_body","name":"Mind and Body","prerequisite":"none","activation":"always","description":"Choose a physical skill. When you make a test with that skill, you can use your Intellect modifier instead of the usual attribute."},{"id":"know_your_moment","name":"Know Your Moment","prerequisite":"Lore 2+","activation":"always","description":"Gain +2 to initiative. When you succeed on Strategize, your target gains a disadvantage on their next test."},{"id":"deep_contemplation","name":"Deep Contemplation","prerequisite":"Deduction 2+","activation":"special","description":"Spend 2 focus and 1 minute to remove Confused and Disoriented from you and allies within 10 feet, and they gain momentum for their next cognitive test."},{"id":"turning_point","name":"Turning Point","prerequisite":"Deduction 3+","activation":"reaction","description":"After an ally within 20 feet fails a test, spend 3 focus to let them reroll, adding your Intellect modifier to one die."},{"id":"read_the_field","name":"Read the Field","prerequisite":"Lore 3+","activation":"2_actions","description":"Spend 2 focus to test Lore vs. Cognitive of all enemies within 30 feet. Those who fail are Surprised and grant advantage to your allies."}]},{"id":"surgeon","name":"Surgeon","description":"Apply their knowledge and empathy to heal the unwell and save lives","talents":[{"id":"field_medicine","name":"Field Medicine","prerequisite":"none","activation":"1_action","description":"Test Medicine (DC 10) to let an ally roll their recovery die and recover that much health. On opportunity, they also recover focus equal to your Intellect modifier."},{"id":"emotional_intelligence","name":"Emotional Intelligence","prerequisite":"none","activation":"always","description":"Choose Insight or Persuasion. When you make a test with that skill, you can use your Intellect modifier instead of the usual attribute."},{"id":"ongoing_care","name":"Ongoing Care","prerequisite":"Medicine 2+, Field Medicine","activation":"special","description":"When you use Field Medicine, spend 1 focus to also remove one condition or reduce injury level by 1."},{"id":"medical_expertise","name":"Medical Expertise","prerequisite":"Medicine 2+","activation":"always","description":"Gain three medical utility expertises. Your Medicine tests to treat injuries, diseases, or poisons expand Opportunity range by 2."},{"id":"resuscitate","name":"Resuscitate","prerequisite":"Medicine 3+, Ongoing Care","activation":"2_actions","description":"Spend 3 focus to revive an Unconscious ally. They recover health equal to their recovery die + your Intellect modifier."},{"id":"miraculous_recovery","name":"Miraculous Recovery","prerequisite":"Medicine 3+, Medical Expertise","activation":"special","description":"When you treat someone during a long rest, they recover an additional recovery die of health and remove one injury level."}]}]},{"id":"warrior","name":"Warrior","description":"Roshar is a world riven by conflict, and many of its people follow the path of the Warrior","keyAttribute":"strength","startingSkill":"athletics","primarySkills":["athletics","heavy_weaponry","light_weaponry","intimidation","leadership"],"keyTalent":{"id":"vigilant_stance","name":"Vigilant Stance","prerequisite":"none","activation":"free_action","description":"You learn to use stances. Enter Vigilant Stance: While in this stance, reduce the focus cost of your Dodge and Reactive Strike reactions by 1. Additionally, you can enter another stance you know as free action."},"specialties":[{"id":"duelist","name":"Duelist","description":"In the inner circles of the elite, contend for glory and political sway","talents":[{"id":"practiced_kata","name":"Practiced Kata","prerequisite":"none","activation":"always","description":"You can now use stances in conversations and endeavors, and unless Surprised, you can start each scene in Vigilant Stance. Spend 1 focus to enter a stance mid-conversation or mid-endeavor."},{"id":"flamestance","name":"Flamestance","prerequisite":"Intimidation 1+","activation":"1_action","description":"Enter Flamestance: You gain an advantage on Intimidation, and when only one enemy is in reach and no allies are, gain momentum to attack or Gain Advantage."},{"id":"ironstance","name":"Ironstance","prerequisite":"Athletics 2+, Practiced Kata","activation":"1_action","description":"Enter Ironstance: You gain an advantage on Insight, and when you're grazed or missed, you can make a Reactive Strike against your attacker."},{"id":"signature_weapon","name":"Signature Weapon","prerequisite":"Flamestance","activation":"always","description":"Gain a weapon expertise. Choose one of your weapon expertises, expanding its Opportunity range by 1 (2 at tier 3)."},{"id":"surefooted_warrior","name":"Surefooted","prerequisite":"Ironstance","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"feinting_strike","name":"Feinting Strike","prerequisite":"Intimidation 2+, Flamestance","activation":"2_actions","description":"Spend 2 focus to make a melee weapon attack vs. Cognitive. On a hit, your target loses one action and loses focus equal to your ranks in Intimidation. On a graze, they lose half as much focus."},{"id":"vinestance","name":"Vinestance","prerequisite":"Athletics 3+, Feinting Strike","activation":"1_action","description":"Enter Vinestance: Your Physical and Cognitive defenses increase by 1. After you're hit or grazed in melee, spend momentum to test Athletics vs. Cognitive to make attacker lose 1d4 focus and be pushed."},{"id":"wits_end","name":"Wit's End","prerequisite":"Intimidation 3+","activation":"1_action","description":"Spend 1 focus to move half your movement then make a melee weapon attack vs. Cognitive of a target who has 0 focus. This attack ignores deflect, deals an extra 4d6 damage, and can't graze."}]},{"id":"shardbearer","name":"Shardbearer","description":"Wield Shardblades and Shardplate to dominate the battlefield with mythic might","talents":[{"id":"shard_training","name":"Shard Training","prerequisite":"Access to a Shardblade and Shardplate","activation":"always","description":"Gain Shardplate expertise, and gain either Grandbow, Shardblade, or Warhammer expertise. Your Shardplate has 2 additional charges. Your Shardblade Strikes graze additional targets up to your ranks in the skill used."},{"id":"stonestance","name":"Stonestance","prerequisite":"none","activation":"1_action","description":"Enter Stonestance: Your deflect increases by 1, and enemies within your reach must spend an additional action to attack your allies who aren't in Stonestance."},{"id":"windstance","name":"Windstance","prerequisite":"Perception 1+","activation":"1_action","description":"Enter Windstance: Gain an advantage on Agility. While you can reach multiple enemies, use free action to gain momentum to Disengage or attack."},{"id":"mighty_warrior","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"shattering_blow","name":"Shattering Blow","prerequisite":"Perception 2+","activation":"special","description":"When you hit with a melee attack, spend 2 focus to deplete 1 charge from their armor, and each target you damage is pushed 5 feet."},{"id":"bloodstance","name":"Bloodstance","prerequisite":"Athletics 2+","activation":"1_action","description":"Enter Bloodstance: Your Opportunity range for attacks and physical tests expands by 2, but your Physical, Cognitive, and Spiritual defenses decrease by 2."},{"id":"precise_parry","name":"Precise Parry","prerequisite":"Perception 3+","activation":"reaction","description":"Before being hit in melee, spend 1 focus to attempt to turn it into a graze. Test Athletics (unarmed) or Light/Heavy Weaponry (armed) vs. triggering attack."},{"id":"meteoric_leap","name":"Meteoric Leap","prerequisite":"Athletics 3+","activation":"2_actions","description":"Spend 2 focus to leap a quarter of your movement and make unarmed attack vs. Physical of multiple targets, doubling damage and knocking weaker targets Prone. Gain an advantage in Shardplate."}]},{"id":"soldier","name":"Soldier","description":"The most common of fighting forces, mastering tactics to fight effectively in units","talents":[{"id":"cautious_advance","name":"Cautious Advance","prerequisite":"Discipline 1+","activation":"1_action","description":"Move up to half your movement, ignoring difficult terrain, then gain momentum to Brace or Gain Advantage."},{"id":"combat_training_warrior","name":"Combat Training","prerequisite":"none","activation":"always","description":"Gain expertise in a weapon, armor, and Military Life. Once per round, graze without spending focus."},{"id":"defensive_position","name":"Defensive Position","prerequisite":"Athletics 2+","activation":"always","description":"The Brace action adds two disadvantages to attacks against you, instead of one, and allies can Brace behind your shield."},{"id":"devastating_blow","name":"Devastating Blow","prerequisite":"Athletics 3+","activation":"1_action","description":"Make a melee weapon attack vs. Physical, rolling an extra 2d8 damage."},{"id":"formation_drills","name":"Formation Drills","prerequisite":"Discipline 2+","activation":"always","description":"Allies within 10 feet who Brace gain the benefits of your Defensive Position."},{"id":"hardy_warrior","name":"Hardy","prerequisite":"none","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"wary","name":"Wary","prerequisite":"Discipline 3+","activation":"always","description":"You can't be Surprised while you have focus. When you lose focus involuntarily, reduce the amount lost by your ranks in Discipline."},{"id":"swift_strikes_warrior","name":"Swift Strikes","prerequisite":"none","activation":"special","description":"Spend 1 focus to make a second Strike with the same weapon."}]}]}],"radiantOrders":[{"id":"windrunner","name":"Windrunners","description":"Protect those who cannot protect themselves","oaths":["Life before death","Strength before weakness","Journey before destination","I will protect those who cannot protect themselves","I will protect even those I hate, even if the one I hate most is myself"],"surges":["gravitation","adhesion"],"sprenType":"Honorspren","attributes":["strength","willpower"],"keyTalent":{"name":"First Ideal (Windrunner Key)","description":"Begin bonding an honorspren and gain Investiture"},"specialties":[{"name":"Honorspren Bond","description":"Talents unique to your bond with an honorspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Windrunner Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Adhesion and Gravitation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of windspren as Radiant Shardplate."},{"id":"reverse_lashing","name":"Reverse Lashing","prerequisite":"First Ideal","activation":"1_action","description":"Infuse yourself or an object with a mix of Adhesion and Gravitation, giving it a weak gravitational pull on specific objects within your gravitation rate distance."},{"id":"invested","name":"Invested","prerequisite":"Reverse Lashing","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges and the ability to Breathe Stormlight, Enhance, and Regenerate. You can have a maximum number of squires up to twice your level."}]}]},{"id":"skybreaker","name":"Skybreakers","description":"Enforce the law and strive for justice","oaths":["Life before death","Strength before weakness","Journey before destination","I will follow the law","I am the law"],"surges":["gravitation","division"],"sprenType":"Highspren","attributes":["awareness","presence"],"keyTalent":{"name":"First Ideal (Skybreaker Key)","description":"Begin bonding a highspren and gain Investiture"},"specialties":[{"name":"Highspren Bond","description":"Talents unique to your bond with a highspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Skybreaker Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Division and Gravitation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of luckspren as Radiant Shardplate."},{"id":"soaring_destruction","name":"Soaring Destruction","prerequisite":"First Ideal","activation":"special","description":"After you Move while maintaining a Basic Lashing on yourself, spend 1 focus to gain an action which can be used only for Division or one of its talents."},{"id":"invested","name":"Invested","prerequisite":"Soaring Destruction","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges and the ability to Breathe Stormlight, Enhance, and Regenerate. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"dustbringer","name":"Dustbringers","description":"Great power requires strong discipline","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek mastery","I will use my power wisely"],"surges":["division","abrasion"],"sprenType":"Ashspren","attributes":["intellect","willpower"],"keyTalent":{"name":"First Ideal (Dustbringer Key)","description":"Begin bonding an ashspren and gain Investiture"},"specialties":[{"name":"Ashspren Bond","description":"Talents unique to your bond with an ashspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Dustbringer Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Abrasion and Division surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of flamespren as Radiant Shardplate."},{"id":"searing_dust_storm","name":"Searing Dust Storm","prerequisite":"First Ideal","activation":"special","description":"Spend Investiture to kick up an obscuring cloud of dust as you Move. Enemies in this cloud take extra damage equal to your ranks in Discipline."},{"id":"invested","name":"Invested","prerequisite":"Searing Dust Storm","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"edgedancer","name":"Edgedancers","description":"Remember and serve those who others forget","oaths":["Life before death","Strength before weakness","Journey before destination","I will remember those who have been forgotten","I will listen to those who have been ignored"],"surges":["abrasion","progression"],"sprenType":"Cultivationspren","attributes":["speed","awareness"],"keyTalent":{"name":"First Ideal (Edgedancer Key)","description":"Begin bonding a cultivationspren and gain Investiture"},"specialties":[{"name":"Cultivationspren Bond","description":"Talents unique to your bond with a cultivationspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Edgedancer Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Abrasion and Progression surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of lifespren as Radiant Shardplate."},{"id":"edgedancers_grace","name":"Edgedancer's Grace","prerequisite":"First Ideal","activation":"special","description":"After you start your turn with 1 Investiture or more, you gain an additional action, which you can use only to Avoid Danger or Dodge. If you use the Dodge reaction in this way, ignore its focus cost."},{"id":"invested","name":"Invested","prerequisite":"Edgedancer's Grace","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"truthwatcher","name":"Truthwatchers","description":"Search for fundamental truth and share it","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek truth","I will share truth"],"surges":["progression","illumination"],"sprenType":"Mistspren","attributes":["intellect","awareness"],"keyTalent":{"name":"First Ideal (Truthwatcher Key)","description":"Begin bonding a mistspren and gain Investiture"},"specialties":[{"name":"Mistspren Bond","description":"Talents unique to your bond with a mistspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Truthwatcher Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Progression and Illumination surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of gloryspren as Radiant Shardplate."},{"id":"healing_burst","name":"Healing Burst","prerequisite":"First Ideal","activation":"1_action","description":"Spend Investiture to create a burst of healing light. Allies within your Progression range can spend a Recovery Die to heal."},{"id":"invested","name":"Invested","prerequisite":"Healing Burst","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"lightweaver","name":"Lightweavers","description":"Separate truth from lies","oaths":["Life before death","Strength before weakness","Journey before destination","I will speak my truth","I will accept who I am"],"surges":["illumination","transformation"],"sprenType":"Cryptic","attributes":["presence","intellect"],"keyTalent":{"name":"First Ideal (Lightweaver Key)","description":"Begin bonding a cryptic and gain Investiture"},"specialties":[{"name":"Cryptic Bond","description":"Talents unique to your bond with a cryptic companion","talents":[{"id":"first_ideal","name":"First Ideal (Lightweaver Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Illumination and Transformation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of creationspren as Radiant Shardplate."},{"id":"lightweaving","name":"Lightweaving","prerequisite":"First Ideal","activation":"1_action","description":"Create illusions of light and sound. Spend Investiture to create increasingly complex and believable illusions."},{"id":"invested","name":"Invested","prerequisite":"Lightweaving","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"elsecaller","name":"Elsecallers","description":"Strive to reach your true potential","oaths":["Life before death","Strength before weakness","Journey before destination","I will reach my potential","I will seek self-mastery"],"surges":["transformation","transportation"],"sprenType":"Inkspren","attributes":["intellect","willpower"],"keyTalent":{"name":"First Ideal (Elsecaller Key)","description":"Begin bonding an inkspren and gain Investiture"},"specialties":[{"name":"Inkspren Bond","description":"Talents unique to your bond with an inkspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Elsecaller Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Transformation and Transportation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of logicspren as Radiant Shardplate."},{"id":"elsecalling","name":"Elsecalling","prerequisite":"First Ideal","activation":"1_action","description":"Use Transportation to teleport yourself and others. Spend Investiture to travel greater distances or bring more companions."},{"id":"invested","name":"Invested","prerequisite":"Elsecalling","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"willshaper","name":"Willshapers","description":"Seek freedom and choice for all peoples","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek freedom for those in bondage","I will give others freedom to choose"],"surges":["transportation","cohesion"],"sprenType":"Lightspren","attributes":["presence","awareness"],"keyTalent":{"name":"First Ideal (Willshaper Key)","description":"Begin bonding a lightspren and gain Investiture"},"specialties":[{"name":"Lightspren Bond","description":"Talents unique to your bond with a lightspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Willshaper Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Cohesion and Transportation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of joyspren as Radiant Shardplate."},{"id":"stone_shaping","name":"Stone Shaping","prerequisite":"First Ideal","activation":"1_action","description":"Use Cohesion to shape and manipulate stone and earth. Spend Investiture to create walls, tunnels, or other structures."},{"id":"invested","name":"Invested","prerequisite":"Stone Shaping","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"stoneward","name":"Stonewards","description":"Be the support on which others can depend","oaths":["Life before death","Strength before weakness","Journey before destination","I will be there when I'm needed","I will stand firm"],"surges":["cohesion","tension"],"sprenType":"Peakspren","attributes":["strength","willpower"],"keyTalent":{"name":"First Ideal (Stoneward Key)","description":"Begin bonding a peakspren and gain Investiture"},"specialties":[{"name":"Peakspren Bond","description":"Talents unique to your bond with a peakspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Stoneward Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Cohesion and Tension surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of gloryspren as Radiant Shardplate."},{"id":"stone_stance","name":"Stone Stance","prerequisite":"First Ideal","activation":"free_action","description":"Use Cohesion to root yourself in place. While in Stone Stance, you cannot be moved against your will and gain bonus to resist being knocked down."},{"id":"invested","name":"Invested","prerequisite":"Stone Stance","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]}],"advancement":{"levelProgression":[{"level":1,"tier":1,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":2,"tier":1,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":3,"tier":1,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":4,"tier":2,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":5,"tier":2,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":6,"tier":2,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":7,"tier":3,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":8,"tier":3,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":9,"tier":3,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":10,"tier":3,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0}]},"ancestries":["Human","Singer"],"cultures":["Alethi","Azish","Veden","Thaylen","Kharbranthian","Unkalaki","Listener","Wayfarer","High Society","Military Life"],"weapons":{"light":[{"id":"javelin","name":"Javelin","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Thrown [30/120]","Indirect"],"weight":2,"price":20},{"id":"knife","name":"Knife","skill":"light_weaponry","damage":"1d4","damageType":"keen","range":"Melee","traits":["Discreet","Offhand","Thrown [20/60]"],"weight":1,"price":8},{"id":"mace","name":"Mace","skill":"light_weaponry","damage":"1d6","damageType":"impact","range":"Melee","traits":["Momentum"],"weight":3,"price":20},{"id":"rapier","name":"Rapier","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Quickdraw","Defensive"],"weight":2,"price":100},{"id":"shortspear","name":"Shortspear","skill":"light_weaponry","damage":"1d8","damageType":"keen","range":"Melee","traits":["Two-Handed","Unique: loses Two-Handed trait"],"weight":3,"price":10},{"id":"sidesword","name":"Sidesword","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Quickdraw","Offhand"],"weight":2,"price":40},{"id":"staff","name":"Staff","skill":"light_weaponry","damage":"1d6","damageType":"impact","range":"Melee","traits":["Discreet","Two-Handed","Defensive"],"weight":4,"price":1},{"id":"shortbow","name":"Shortbow","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Ranged [80/320]","traits":["Two-Handed","Quickdraw"],"weight":2,"price":80},{"id":"sling","name":"Sling","skill":"light_weaponry","damage":"1d4","damageType":"impact","range":"Ranged [30/120]","traits":["Discreet","Indirect"],"weight":1,"price":2}],"heavy":[{"id":"axe","name":"Axe","skill":"heavy_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Thrown [20/60]","Offhand"],"weight":2,"price":20},{"id":"greatsword","name":"Greatsword","skill":"heavy_weaponry","damage":"1d10","damageType":"keen","range":"Melee","traits":["Two-Handed","Deadly"],"weight":7,"price":200},{"id":"hammer","name":"Hammer","skill":"heavy_weaponry","damage":"1d10","damageType":"impact","range":"Melee","traits":["Two-Handed","Momentum"],"weight":8,"price":40},{"id":"longspear","name":"Longspear","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Melee [+5]","traits":["Two-Handed","Defensive"],"weight":9,"price":15},{"id":"longsword","name":"Longsword","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Melee","traits":["Quickdraw","Two-Handed","Unique: loses Two-Handed trait"],"weight":3,"price":60},{"id":"poleaxe","name":"Poleaxe","skill":"heavy_weaponry","damage":"1d10","damageType":"keen","range":"Melee","traits":["Two-Handed","Unique: Melee [+5]"],"weight":5,"price":40},{"id":"shield","name":"Shield","skill":"heavy_weaponry","damage":"1d4","damageType":"impact","range":"Melee","traits":["Defensive","Offhand"],"weight":2,"price":10},{"id":"crossbow","name":"Crossbow","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Ranged [100/400]","traits":["Loaded [1]","Two-Handed","Deadly"],"weight":7,"price":200},{"id":"longbow","name":"Longbow","skill":"heavy_weaponry","damage":"1d6","damageType":"keen","range":"Ranged [150/600]","traits":["Two-Handed","Indirect"],"weight":3,"price":100}],"special":[{"id":"unarmed","name":"Unarmed Attack","skill":"athletics","damage":"Variable","damageType":"impact","range":"Melee","traits":["Always Available","Momentum","Offhand"],"weight":0,"price":0},{"id":"improvised","name":"Improvised Weapon","skill":"variable","damage":"Variable","damageType":"variable","range":"Variable","traits":["Fragile"],"weight":0,"price":0}]},"armor":[{"id":"uniform","name":"Uniform","deflect":0,"traits":["Presentable"],"expertTraits":[],"weight":5,"price":40,"strengthRequired":0},{"id":"leather","name":"Leather","deflect":1,"traits":[],"expertTraits":["Presentable"],"weight":10,"price":60,"strengthRequired":0},{"id":"chain","name":"Chain","deflect":2,"traits":["Cumbersome [3]"],"expertTraits":["Loses Cumbersome"],"weight":25,"price":80,"strengthRequired":3},{"id":"breastplate","name":"Breastplate","deflect":2,"traits":["Cumbersome [3]"],"expertTraits":["Presentable"],"weight":30,"price":120,"strengthRequired":3},{"id":"half_plate","name":"Half Plate","deflect":3,"traits":["Cumbersome [4]"],"expertTraits":["Cumbersome [3] instead"],"weight":40,"price":400,"strengthRequired":4},{"id":"full_plate","name":"Full Plate","deflect":4,"traits":["Cumbersome [5]"],"expertTraits":[],"weight":55,"price":1600,"strengthRequired":5}],"currency":{"denominations":[{"id":"chip","name":"Chip","value":0.05},{"id":"mark","name":"Mark","value":1},{"id":"broam","name":"Broam","value":20}]},"equipment":[{"name":"Alcohol (1 serving)","weight":0.2,"price":0.5,"category":"Consumables"},{"name":"Alcohol (bottle)","weight":3,"price":10,"category":"Consumables"},{"name":"Anesthetic (5 doses)","weight":1.5,"price":75,"category":"Medical"},{"name":"Antiseptic (potent, 5 doses)","weight":1,"price":50,"category":"Medical"},{"name":"Antiseptic (weak, 5 doses)","weight":1,"price":25,"category":"Medical"},{"name":"Backpack","weight":5,"price":8,"category":"Containers"},{"name":"Barrel","weight":70,"price":15,"category":"Containers"},{"name":"Blanket","weight":2,"price":2,"category":"Camping"},{"name":"Book (reference)","weight":3,"price":100,"category":"Tools"},{"name":"Bottle (crem)","weight":3,"price":0.5,"category":"Containers"},{"name":"Bottle (glass)","weight":2,"price":1,"category":"Containers"},{"name":"Bucket","weight":2,"price":1,"category":"Containers"},{"name":"Candle","weight":0.2,"price":0.2,"category":"Light"},{"name":"Case (leather)","weight":1,"price":4,"category":"Containers"},{"name":"Chain (thick, 10 feet)","weight":10,"price":20,"category":"Tools"},{"name":"Chain (thin, 1 foot)","weight":0.5,"price":20,"category":"Tools"},{"name":"Chest","weight":25,"price":30,"category":"Containers"},{"name":"Clothing (common)","weight":3,"price":2,"category":"Clothing"},{"name":"Clothing (fine)","weight":6,"price":100,"category":"Clothing"},{"name":"Clothing (ragged)","weight":1.5,"price":0.5,"category":"Clothing"},{"name":"Crowbar","weight":3,"price":10,"category":"Tools"},{"name":"Ear trumpet","weight":1,"price":50,"category":"Tools"},{"name":"Flask or tankard","weight":1,"price":1,"category":"Containers"},{"name":"Flint and steel","weight":1.5,"price":4,"category":"Tools"},{"name":"Food (ration, 1 day)","weight":0.5,"price":0.2,"category":"Consumables"},{"name":"Food (street, 1 day)","weight":1.5,"price":3,"category":"Consumables"},{"name":"Food (fine, 1 day)","weight":0.5,"price":25,"category":"Consumables"},{"name":"Grappling hook","weight":4,"price":10,"category":"Tools"},{"name":"Hammer (handheld)","weight":3,"price":4,"category":"Tools"},{"name":"Ink (1-ounce bottle)","weight":0.2,"price":40,"category":"Writing"},{"name":"Ink pen","weight":0.1,"price":0.1,"category":"Writing"},{"name":"Jug or pitcher","weight":4,"price":2,"category":"Containers"},{"name":"Ladder (10-foot)","weight":20,"price":5,"category":"Tools"},{"name":"Lantern (oil)","weight":2,"price":20,"category":"Light"},{"name":"Lantern (sphere)","weight":2,"price":20,"category":"Light"},{"name":"Lock and key","weight":1,"price":50,"category":"Tools"},{"name":"Lockpick","weight":0.5,"price":5,"category":"Tools"},{"name":"Magnifying lens","weight":0.2,"price":400,"category":"Tools"},{"name":"Manacles","weight":6,"price":10,"category":"Tools"},{"name":"Mirror (handheld)","weight":2,"price":25,"category":"Tools"},{"name":"Musical instrument","weight":5,"price":20,"category":"Tools"},{"name":"Net (hunting)","weight":5,"price":4,"category":"Tools"},{"name":"Net (fishing)","weight":15,"price":10,"category":"Tools"},{"name":"Oil (1 flask)","weight":1,"price":1,"category":"Consumables"},{"name":"Paper or parchment (1 sheet)","weight":0.1,"price":0.5,"category":"Writing"},{"name":"Perfume (1 vial)","weight":0.5,"price":20,"category":"Consumables"},{"name":"Pick (mining)","weight":10,"price":10,"category":"Tools"},{"name":"Poison (weak, 1 dose)","weight":0.2,"price":20,"category":"Consumables"},{"name":"Poison (effectual, 1 dose)","weight":0.2,"price":50,"category":"Consumables"},{"name":"Poison (potent, 1 dose)","weight":0.2,"price":120,"category":"Consumables"},{"name":"Pot (iron)","weight":10,"price":8,"category":"Camping"},{"name":"Pouch","weight":1,"price":1,"category":"Containers"},{"name":"Pulley system","weight":12,"price":100,"category":"Tools"},{"name":"Rope (50 feet)","weight":5,"price":30,"category":"Tools"},{"name":"Sack","weight":0.5,"price":0.2,"category":"Containers"},{"name":"Scale","weight":3,"price":20,"category":"Tools"},{"name":"Shovel","weight":5,"price":8,"category":"Tools"},{"name":"Soap","weight":0.1,"price":1,"category":"Consumables"},{"name":"Spyglass","weight":1,"price":500,"category":"Tools"},{"name":"Surgical supplies","weight":3,"price":20,"category":"Medical"},{"name":"Tent (two-person)","weight":20,"price":10,"category":"Camping"},{"name":"Treatment (medical, 1 dose)","weight":0.2,"price":10,"category":"Medical"},{"name":"Tuning fork","weight":0.5,"price":50,"category":"Tools"},{"name":"Unencased gem (infused)","weight":0.01,"price":2,"category":"Consumables"},{"name":"Vial (glass)","weight":0.2,"price":4,"category":"Containers"},{"name":"Waterskin","weight":1,"price":1,"category":"Camping"},{"name":"Wax (1 block)","weight":0.5,"price":2,"category":"Consumables"},{"name":"Whetstone","weight":1,"price":0.2,"category":"Tools"}],"startingKits":[{"id":"academic","name":"Academic Kit","weapons":["One knife, sling, or staff"],"armor":"uniform","equipment":["Backpack","Common clothing","Ink pen","Bottle of ink","10 sheets of paper","3 empty vials","Block of wax","Reference book (topic of choice)","1 dose of weak poison"],"currency":{"dice":"3d12","type":"marks"},"bonuses":{"expertise":"Literature (or cultural/utility expertise if already known)"},"description":"For scholars and students"},{"id":"artisan","name":"Artisan Kit","weapons":["One hammer or light weapon (your choice)"],"armor":"leather","equipment":["Chest","Common clothing","Surgical supplies","5 doses of weak antiseptic","Ink pen","Bottle of ink","5 sheets of parchment","5 candles","Flint and steel","3 empty glass bottles","Tuning fork","Musical instrument (of choice)","Scale"],"currency":{"dice":"4d8","type":"marks"},"description":"For craftsmen and artisans"},{"id":"military","name":"Military Kit","weapons":["Two non-special weapons"],"armor":"uniform and chain","equipment":["Backpack","Common clothing","Waterskin","Flint and steel","Whetstone","Blanket","10 days of food rations"],"currency":{"dice":"2d6","type":"marks"},"description":"For soldiers and guards"},{"id":"courtier","name":"Courtier Kit","weapons":["One sidesword, greatsword, longsword, or longbow"],"armor":"none","equipment":["Alcohol (bottle of violet wine)","Fine clothing"],"currency":{"dice":"4d20","type":"marks"},"bonuses":{"connection":"Patron of noble house (provides accommodations and standard of living)"},"description":"For nobles and diplomats"},{"id":"prisoner","name":"Prisoner Kit","weapons":[],"armor":"none","equipment":["Manacles","Ragged clothing"],"currency":{"dice":"0","type":"marks"},"bonuses":{"connection":"Radiant spren (choose spren type with GM, gain 2 progress boxes on 'Speak the First Ideal' goal if you choose this Order's key talent)"},"description":"For characters starting in captivity"},{"id":"underworld","name":"Underworld Kit","weapons":["Two light weapons"],"armor":"leather","equipment":["Backpack","Common clothing","Alcohol (bottle of Horneater white)","Crowbar","Lockpick","50 feet of rope","Flint and steel","Oil lantern","Flask of oil","5 days of street food"],"currency":{"dice":"1d20","type":"marks"},"description":"For thieves and criminals"}],"conditions":[{"id":"blinded","name":"Blinded","description":"Cannot see. Attacks against you gain advantage, your attacks gain disadvantage."},{"id":"deafened","name":"Deafened","description":"Cannot hear. Disadvantage on Perception tests that rely on hearing."},{"id":"frightened","name":"Frightened","description":"Disadvantage on attacks and tests while source of fear is in line of sight."},{"id":"immobilized","name":"Immobilized","description":"Speed becomes 0. Cannot Move or use movement."},{"id":"prone","name":"Prone","description":"Melee attacks against you gain advantage. Ranged attacks gain disadvantage. Moving requires half movement to stand."},{"id":"restrained","name":"Restrained","description":"Speed becomes 0. Attacks gain disadvantage. Attacks against you gain advantage."},{"id":"slowed","name":"Slowed","description":"Movement is halved."},{"id":"stunned","name":"Stunned","description":"Cannot take actions or reactions. Attacks against you gain advantage."},{"id":"unconscious","name":"Unconscious","description":"Cannot take actions. Drop items. Attacks against you gain advantage and auto-crit within 5 feet."}],"surges":{"abrasion":{"name":"Abrasion","attribute":"speed","orders":["dustbringer","edgedancer"],"description":"Alters the frictional force on an object's surface","baseAbility":"Spend 1 Investiture or more to infuse an object or surface, making it frictionless. Alternatively, infuse yourself to use Skate (move fast in straight line) and Slide (squeeze through spaces easier).","talents":[{"id":"frictionless_motion","name":"Frictionless Motion","prerequisite":"Speak the First Ideal","activation":"always","description":"While infused with Abrasion, your movement rate increases by 10 feet, and you ignore the Slowed condition when imposed by difficult terrain, climbing, crawling, and swimming."},{"id":"reverse_abrasion","name":"Reverse Abrasion","prerequisite":"Speak the First Ideal","activation":"1_action","description":"You can increase friction instead of reducing it. Infused targets give an advantage on Agility and Athletics tests and ignore Slowed conditions from surfaces."},{"id":"graceful_skating","name":"Graceful Skating","prerequisite":"Frictionless Motion","activation":"free_action","description":"When you Skate, you aren't restricted to moving in a straight line."},{"id":"stormlight_reclamation","name":"Stormlight Reclamation","prerequisite":"Reverse Abrasion","activation":"free_action","description":"At the start of your turn, you can end any number of infusions within your reach to regain their remaining Investiture."},{"id":"slippery_target","name":"Slippery Target","prerequisite":"Graceful Skating","activation":"always","description":"While infused with Abrasion, attacks can't graze you and Reactive Strikes against you gain a disadvantage."},{"id":"distant_surgebinding","name":"Distant Surgebinding","prerequisite":"Reverse Abrasion","activation":"always","description":"You can use your surges and their talents as though your reach is 20 feet, and you don't need to touch the target."},{"id":"slick_combatant","name":"Slick Combatant","prerequisite":"Slippery Target","activation":"special","description":"While infused with Abrasion, you can interrupt a Move with other actions. Once per round, deal extra damage (scaling with Abrasion ranks) on a mid-movement attack."},{"id":"smooth_operator","name":"Smooth Operator","prerequisite":"Distant Surgebinding or Slippery Target","activation":"always","description":"While you have Investiture, you are infused with Abrasion without spending Investiture, and it costs you 1 fewer focus to Skate."}]},"adhesion":{"name":"Adhesion","attribute":"presence","orders":["bondsmith","windrunner"],"description":"Binds things together through Full Lashing","baseAbility":"Spend 1 Investiture to perform a Full Lashing, sticking two objects or an object to a surface together. The objects must be within reach and 5 feet of each other.","talents":[{"id":"binding_strike","name":"Binding Strike","prerequisite":"Speak the First Ideal","activation":"special","description":"After hitting with a melee attack, spend 2 focus or an Opportunity to use Adhesion without spending an action. Automatically succeed on the test."},{"id":"stormlight_reclamation_adhesion","name":"Stormlight Reclamation","prerequisite":"Speak the First Ideal","activation":"free_action","description":"At the start of your turn, you can end any number of infusions within your reach to regain their remaining Investiture."},{"id":"binding_shot","name":"Binding Shot","prerequisite":"Binding Strike","activation":"special","description":"You can use Binding Strike when you hit with a ranged attack at any distance."},{"id":"adhesive_trap","name":"Adhesive Trap","prerequisite":"Binding Shot","activation":"1_action","description":"Infuse a surface with Adhesion. Characters who touch it become Fully Lashed to it automatically."},{"id":"distant_surgebinding_adhesion","name":"Distant Surgebinding","prerequisite":"Stormlight Reclamation","activation":"always","description":"Use your surges and their talents as though your reach is 20 feet, and you don't need to touch the target."},{"id":"extended_adhesion","name":"Extended Adhesion","prerequisite":"Distant Surgebinding","activation":"always","description":"Full Lashings expend 1 Investiture per number of rounds equal to your ranks in Adhesion (e.g., 3 ranks = every 3 rounds)."},{"id":"superior_bond","name":"Superior Bond","prerequisite":"Adhesive Trap or Extended Adhesion","activation":"always","description":"Automatically succeed on opposed tests to maintain Full Lashings against characters with Strength no higher than your ranks in Adhesion."},{"id":"living_adhesion","name":"Living Adhesion","prerequisite":"Extended Adhesion","activation":"1_action","description":"You can use Adhesion on characters. When Lashed to something larger, they become Restrained, gain disadvantage on physical tests, and attacks against them gain advantage."}]},"cohesion":{"name":"Cohesion","attribute":"willpower","orders":["stoneward","willshaper"],"description":"Mold stone as if it were clay (Stoneshaping)","baseAbility":"Spend 1 Investiture to infuse stone within reach, making it moldable and soft like clay. You can reshape it immediately or with additional actions for intricate work.","talents":[{"id":"stone_spear","name":"Stone Spear","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 Investiture to make a ranged Cohesion attack vs. Physical of a target within 60 feet, rolling 2d4 impact damage (scales with ranks)."},{"id":"memories_of_stone","name":"Memories of Stone","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 Investiture to communicate with stone you're touching, gaining visions of its history and memories."},{"id":"sinkhole","name":"Sinkhole","prerequisite":"Stone Spear","activation":"1_action","description":"Spend 1 Investiture to test Cohesion vs. Cognitive of targets on stone ground. On success, they sink and become Immobilized."},{"id":"tunneling","name":"Tunneling","prerequisite":"Sinkhole","activation":"1_action","description":"Spend 1 Investiture to move through stone as if through difficult terrain, leaving a 5-foot tunnel behind you."},{"id":"through_the_stone","name":"Through the Stone","prerequisite":"Sinkhole","activation":"always","description":"Use your surges and their talents as though your reach is 20 feet, as long as there's a stone surface between you and your target."},{"id":"true_stoneshaping","name":"True Stoneshaping","prerequisite":"Cohesion 2+, Tunneling","activation":"always","description":"Intricately and extensively shape stone without using additional actions or time."},{"id":"flowing_earth","name":"Flowing Earth","prerequisite":"True Stoneshaping","activation":"special","description":"After using Cohesion, shape the stone beneath your feet, pushing yourself in any direction up to 5 feet \u00d7 your ranks in Cohesion."},{"id":"unbound_cohesion","name":"Unbound Cohesion","prerequisite":"Cohesion 4+, Through the Stone","activation":"always","description":"Use Cohesion on any solid material that isn't alive, Invested, or infused with Stormlight."}]},"division":{"name":"Division","attribute":"intellect","orders":["dustbringer","skybreaker"],"description":"Destroy and decay targets, causing them to crumble or burn","baseAbility":"Target a character (melee Division attack vs. Spiritual for 3d4 spirit damage, scales with ranks), or destroy an object/area (spend 1+ Investiture to destroy/decay materials).","talents":[{"id":"bodily_decay","name":"Bodily Decay","prerequisite":"Speak the First Ideal","activation":"special","description":"When you hit with a Division attack, you can spend an Opportunity to cause one target to suffer an injury."},{"id":"eroding_escape","name":"Eroding Escape","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 or more Investiture to end that many effects inflicting the Restrained or Immobilized condition."},{"id":"igniting_division","name":"Igniting Division","prerequisite":"Bodily Decay","activation":"special","description":"When you use Division, spend 1 or more Investiture to light the target's space on fire, dealing ongoing damage equal to your Division modifier."},{"id":"spark_sending","name":"Spark Sending","prerequisite":"Eroding Escape","activation":"always","description":"When there's a solid surface between you and target, use Division as though your reach is 20 feet."},{"id":"gout_of_flame","name":"Gout of Flame","prerequisite":"Igniting Division","activation":"1_action","description":"Spend 3 Investiture to make a Division attack vs. Physical against each target in an area one size larger than normal."},{"id":"inescapable_spark","name":"Inescapable Spark","prerequisite":"Spark Sending","activation":"always","description":"Spark Sending extends to your spren bond range. You don't need line of effect when you can sense your target, and they can't Brace against your Division."},{"id":"devastating_division","name":"Devastating Division","prerequisite":"Gout of Flame","activation":"always","description":"When you roll damage for Division or its talents, roll an additional damage die of the same size."}]},"gravitation":{"name":"Gravitation","attribute":"awareness","orders":["windrunner","skybreaker"],"description":"Manipulate gravity through Basic and Reverse Lashings","baseAbility":"Spend 1 Investiture to perform a Basic Lashing (change gravity direction for yourself or target) or Reverse Lashing (make yourself a source of gravity, pulling nearby objects).","talents":[{"id":"flying_ace","name":"Flying Ace","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Fly up to your gravitation rate (permanently increases to 40 feet). Spend 1 focus to make a melee weapon attack during this flight."},{"id":"gravitational_slam","name":"Gravitational Slam","prerequisite":"Speak the First Ideal","activation":"special","description":"Use a Basic Lashing to collide a target with a solid surface, dealing 1d4 impact damage per 10 feet moved (scales with ranks). Target can Avoid Danger to halve damage."},{"id":"stable_flight","name":"Stable Flight","prerequisite":"Flying Ace","activation":"always","description":"While maintaining a Basic Lashing on yourself, your ranged attacks don't gain disadvantage due to flying or unstable footing."},{"id":"multiple_lashings","name":"Multiple Lashings","prerequisite":"Gravitational Slam","activation":"special","description":"When you move an unwilling character with Gravitation, infuse Investiture up to your ranks in Gravitation to prolong the effect."},{"id":"group_flight","name":"Group Flight","prerequisite":"Stable Flight","activation":"special","description":"When you use a Basic Lashing out of combat, infuse additional characters up to your ranks in Gravitation without spending additional Investiture."},{"id":"lashing_shot","name":"Lashing Shot","prerequisite":"Gravitational Slam","activation":"1_action","description":"Propel an object at a target, making a ranged Gravitation attack vs. Physical, rolling 2d4 impact damage (scales with ranks)."},{"id":"master_of_the_skies","name":"Master of the Skies","prerequisite":"Group Flight or Lashing Shot","activation":"always","description":"While you have 1 Investiture or more, you gain the benefits of being infused with Gravitation without spending Investiture."}]},"illumination":{"name":"Illumination","attribute":"presence","orders":["lightweaver","truthwatcher"],"description":"Create convincing visual and auditory illusions (Lightweaving)","baseAbility":"Spend 1 Investiture to Lightweave an illusion in a space within spren bond range (simple: 1 per 10 min, complex: 1 per round). Can also create an illusory disguise on yourself while having Investiture.","talents":[{"id":"distracting_illusion","name":"Distracting Illusion","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 Investiture to Lightweave an illusion of yourself or an ally. Until an attack misses the target, attacks against them gain disadvantage and can't graze."},{"id":"lingering_lightweavings","name":"Lingering Lightweavings","prerequisite":"Speak the First Ideal","activation":"1_action","description":"You can infuse an illusion in a sphere. The illusion moves with the sphere, expending 1 Investiture per rounds equal to your ranks in Illumination."},{"id":"disorienting_flash","name":"Disorienting Flash","prerequisite":"Distracting Illusion","activation":"1_action","description":"Spend 1 Investiture to project light in an area, testing Illumination vs. Cognitive of each character to make them Disoriented."},{"id":"stormlight_reclamation_illumination","name":"Stormlight Reclamation","prerequisite":"Distracting Illusion","activation":"free_action","description":"End Illumination infusions within spren bond range and recover their remaining Investiture."},{"id":"spiritual_illumination","name":"Spiritual Illumination","prerequisite":"Disorienting Flash","activation":"1_action","description":"Spend 2 Investiture to cause an ally to become Determined and Focused."},{"id":"multiplicative_lightweaving","name":"Multiplicative Lightweaving","prerequisite":"Stormlight Reclamation","activation":"special","description":"You can Lightweave additional illusions, up to your ranks in Illumination, with no additional Investiture."},{"id":"painful_truth","name":"Painful Truth","prerequisite":"Spiritual Illumination","activation":"1_action","description":"Spend 2 Investiture and test Illumination vs. Spiritual of a target. On success, they are Slowed and must Move away on their next turn or spend focus to avoid doing so."},{"id":"endless_illusions","name":"Endless Illusions","prerequisite":"Multiplicative Lightweaving or Painful Truth","activation":"always","description":"While you have Investiture, Illumination infusions in your spren bond range don't expend Investiture."}]},"progression":{"name":"Progression","attribute":"awareness","orders":["edgedancer","truthwatcher"],"description":"Encourage growth and healing in living things","baseAbility":"Spend Investiture to use Growth (rapidly grow plants) or Regrowth (heal living beings). Regenerate action: recover health equal to your Progression modifier.","talents":[{"id":"injury_regrowth","name":"Injury Regrowth","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 2 Investiture to cause a target to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"explosive_growth","name":"Explosive Growth","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 Investiture to explosively grow plants in an area. Make a Progression attack vs. Physical of each chosen character, rolling 2d4 impact or keen damage (scales with ranks)."},{"id":"swift_regeneration","name":"Swift Regeneration","prerequisite":"Progression 2+, Injury Regrowth","activation":"special","description":"When you Regenerate, recover health equal to 1d6 + your Progression modifier (scales with ranks). While you have Investiture, you and your Regrowth targets can add your Progression modifier to injury rolls."},{"id":"overgrowth","name":"Overgrowth","prerequisite":"Explosive Growth","activation":"special","description":"When you infuse Growth into a plant, test Progression (DC 15) to cause it to grow much larger and stronger than its species' normal limits."},{"id":"extended_regrowth","name":"Extended Regrowth","prerequisite":"Swift Regeneration","activation":"always","description":"Your Regrowth infusions only expend 1 Investiture per rounds equal to your ranks in Progression."},{"id":"reliable_progression","name":"Reliable Progression","prerequisite":"Progression 2+, Overgrowth","activation":"always","description":"When you roll a Progression die, if the result is lower than your ranks in Progression, change the result to equal your ranks."},{"id":"from_the_brink","name":"From the Brink","prerequisite":"Progression 3+, Extended Regrowth","activation":"1_action","description":"Spend 3 Investiture to restore life to a willing character who died within the last minute. They return Unconscious with 0 health."},{"id":"font_of_life","name":"Font of Life","prerequisite":"Extended Regrowth or Reliable Progression","activation":"always","description":"It costs you one Opportunity fewer to use Progression and its talents."}]},"tension":{"name":"Tension","attribute":"strength","orders":["bondsmith","stoneward"],"description":"Alter the rigidity of soft materials, making them firm like steel","baseAbility":"Spend 1 Investiture to infuse a soft object, making it completely rigid. Can grant Hardened Defense (+2 Physical defense) or temporarily create weapons from cloth/rope.","talents":[{"id":"tension_parry","name":"Tension Parry","prerequisite":"Speak the First Ideal","activation":"reaction","description":"Spend 2 focus to flare Tension in your clothing or a held object, causing an attack to miss."},{"id":"stormlight_reclamation_tension","name":"Stormlight Reclamation","prerequisite":"Speak the First Ideal","activation":"free_action","description":"End Tension infusions within reach and recover their remaining Investiture."},{"id":"rigged_weaponry","name":"Rigged Weaponry","prerequisite":"Tension Parry","activation":"special","description":"Spend 1 Investiture to increase your melee weapon's reach by 10 feet. When you hit with a melee attack, spend an Opportunity or 2 focus to infuse Tension into an object the target is holding."},{"id":"extended_tension","name":"Extended Tension","prerequisite":"Stormlight Reclamation","activation":"always","description":"Your Tension infusions only expend 1 Investiture per rounds equal to your ranks in Tension. While you have Investiture, you can freely maintain Tension infusions on objects you're holding."},{"id":"surface_tension","name":"Surface Tension","prerequisite":"Rigged Weaponry","activation":"1_action","description":"Use Tension to increase a liquid's surface tension and walk on it like solid ground."},{"id":"cloth_mastery","name":"Cloth Mastery","prerequisite":"Tension 2+, Extended Tension","activation":"always","description":"Use Tension to instantly create intricate and complex objects."},{"id":"fine_control","name":"Fine Control","prerequisite":"Cloth Mastery","activation":"special","description":"Spend Investiture to infuse an object you can control with Opportunities while touching it. It can move up to 25 feet along surfaces, perform tasks, and make attacks using your Tension (2d4 impact damage, scales with ranks)."},{"id":"clothsmith","name":"Clothsmith","prerequisite":"Fine Control or Surface Tension","activation":"always","description":"Your Hardened Defense effect increases the target's Physical defense by 4 instead of 2. When you temporarily create a weapon with Tension, it gains an extra d4 damage die."}]},"transformation":{"name":"Transformation","attribute":"willpower","orders":["lightweaver","elsecaller"],"description":"Transform matter from one Essence to another (Soulcasting)","baseAbility":"Spend Investiture to transform non-living objects between Essences (Clear Air, Liquid, Wood/Grain, Flesh/Bone, Stone). More distant transformations cost more and have higher DCs. Can also create Soulcast Defense to deflect attacks.","talents":[{"id":"essence_essence","name":"Essence to Essence","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Reduce the Investiture cost of Soulcasting by 1 when transforming between Essences that are adjacent on the list."},{"id":"living_soulcasting","name":"Living Soulcasting","prerequisite":"Speak the First Ideal","activation":"1_action","description":"Spend 1 Investiture and make a melee Transformation attack vs. Spiritual of a living organism, rolling 3d4 spirit damage (scales with ranks). The target dies if reduced to 0 health."},{"id":"soulcast_parry","name":"Soulcast Parry","prerequisite":"Living Soulcasting","activation":"reaction","description":"You can use Soulcast Defense on melee weapon attacks."},{"id":"bloodcasting","name":"Bloodcasting","prerequisite":"Essence to Essence","activation":"1_action","description":"Spend 1 Investiture and test Transformation (DC 15) to cleanse all poison from the target and reduce one injury's recovery time by 5 days."},{"id":"distant_surgebinding_transformation","name":"Distant Surgebinding","prerequisite":"Soulcast Parry","activation":"always","description":"Use your surges and their talents as though your reach is 20 feet."},{"id":"flamecasting","name":"Flamecasting","prerequisite":"Soulcast Parry","activation":"1_action","description":"You gain 'Flame' as a sixth category (DC 30 to transform stone to flame). When Soulcasting flames, attack each character within 5 feet using Transformation vs. Physical, rolling 2d4 energy damage (scales with ranks)."},{"id":"persistent_transformation","name":"Persistent Transformation","prerequisite":"Transformation 2+, Distant Surgebinding","activation":"always","description":"When transforming non-living objects, your max DC is 15. You can reattempt Soulcasting, but on success, must spend 1 additional Investiture per recent failure."},{"id":"expansive_transmuter","name":"Expansive Transmuter","prerequisite":"Flamecasting","activation":"always","description":"Soulcasting non-living material costs 2 fewer Investiture."}]},"transportation":{"name":"Transportation","attribute":"intellect","orders":["elsecaller","willshaper"],"description":"Peer into and travel through the Cognitive Realm (Shadesmar)","baseAbility":"Peer into the Cognitive Realm to sense nearby flames (indicating living beings), Invested objects, and the environment. Can attempt Realmic Step to teleport short distances.","talents":[{"id":"cognitive_farsight","name":"Cognitive Farsight","prerequisite":"Speak the First Ideal","activation":"always","description":"You can spot things in the Cognitive Realm up to a distance equal to 3 \u00d7 your spren bond range. While you have Investiture, you can identify north and the direction to the nearest settlement."},{"id":"realmic_evasion","name":"Realmic Evasion","prerequisite":"Speak the Second Ideal","activation":"reaction","description":"Before you're hit by an attack, spend 1 Investiture and test Transportation (DC equals triggering attack). On failure, the attack grazes. On success, the attack misses."},{"id":"cognitive_vision","name":"Cognitive Vision","prerequisite":"Cognitive Farsight","activation":"special","description":"When you use Transportation to look into the Cognitive Realm, you can learn an enemy's intent by testing Transportation vs. Cognitive, and you can learn about your immediate environment."},{"id":"realmic_step","name":"Realmic Step","prerequisite":"Realmic Evasion","activation":"1_action","description":"Test Transportation (DC 15) and spend 2 Investiture to transport yourself to a space within spren bond range."},{"id":"shared_transportation","name":"Shared Transportation","prerequisite":"Transportation 4+, Realmic Step","activation":"special","description":"When you transport yourself, spend 1 Investiture or more to bring that many additional characters with you."},{"id":"elsecalling","name":"Elsecalling","prerequisite":"Speak the Third Ideal, Realmic Step","activation":"1_action","description":"Spend 1 Investiture to transport yourself from the Physical to the Cognitive Realm, or test Transportation (DC 20) and spend 2 Investiture to transport from the Cognitive to the Physical Realm."},{"id":"elsegate","name":"Elsegate","prerequisite":"Speak the Fourth Ideal, Shared Transportation","activation":"special","description":"Transport yourself and up to ten companions to an Oathgate or permanent perpendicularity you've visited before."},{"id":"realmwalker","name":"Realmwalker","prerequisite":"Elsecalling or Cognitive Vision","activation":"always","description":"When you test Transportation for a talent, you automatically succeed."}]}}};

        const app = {
            rules: null,
            characters: [],
            currentCharacter: null,

            init: async function() {
                await this.loadRules();
                this.loadFromLocalStorage();
                this.renderCharacterList();
                
                if (this.characters.length === 0) {
                    this.createNewCharacter();
                } else {
                    this.loadCharacter(this.characters[0].id);
                }
            },

            loadRules: async function() {
                // Load embedded rules (single source of truth)
                this.rules = COSMERE_RULES;
                console.log('Rules loaded:', this.rules);
            },


            createNewCharacter: function() {
                const newChar = {
                    id: Date.now().toString(),
                    name: 'New Character',
                    playerName: '',
                    ancestry: this.rules.ancestries[0],
                    culture: this.rules.cultures[0],
                    attributes: {
                        strength: 2,
                        speed: 2,
                        intellect: 2,
                        willpower: 2,
                        awareness: 2,
                        presence: 2
                    },
                    skills: {},
                    currentHealth: 12, // Base 10 + Str 2
                    currentFocus: 7,   // Base 5 + Wil 2
                    currentInvestiture: 0, // No Radiant path yet
                    deflect: 0,
                    paths: [], // Multi-path system
                    talents: [],
                    surgeRanks: {}, // {surgeId: rank}
                    surgeTalents: [], // Selected surge talents
                    expertises: [],
                    purpose: '',
                    obstacle: '',
                    goals: [], // Array of {text: string, milestones: [bool, bool, bool]}
                    notes: '',
                    // Equipment & Combat
                    startingKit: null,
                    weapons: [],
                    equippedArmor: null,
                    inventory: [],
                    currency: {chips: 0, marks: 0, broams: 0},
                    // Injuries & Conditions
                    injuries: {temporary: [], permanent: []},
                    conditions: [],
                    // Connections
                    connections: [],
                    // Character Details
                    characterDetails: {
                        age: '',
                        gender: '',
                        height: '',
                        weight: '',
                        appearance: '',
                        backstory: ''
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Initialize all skills to rank 0
                this.rules.skills.list.forEach(skill => {
                    newChar.skills[skill.id] = 0;
                });

                this.characters.push(newChar);
                this.loadCharacter(newChar.id);
                
                // Set current resources to match calculated max values for new character
                if (this.currentCharacter) {
                    this.currentCharacter.currentHealth = this.currentCharacter.maxHealth;
                    this.currentCharacter.currentFocus = this.currentCharacter.maxFocus;
                    this.currentCharacter.currentInvestiture = this.currentCharacter.maxInvestiture || 0;
                    this.renderCharacterSheet(); // Re-render with corrected values
                }
                
                this.saveToLocalStorage();
            },

            loadCharacter: function(charId) {
                this.currentCharacter = this.characters.find(c => c.id === charId);
                if (this.currentCharacter) {
                    this.renderCharacterSheet();
                    this.updatePointTrackers();
                    this.validateCharacter();
                    this.renderCharacterList();
                    document.getElementById('characterSheetSection').classList.remove('hidden');
                }
            },

            renderCharacterList: function() {
                const container = document.getElementById('characterListItems');
                container.innerHTML = '';

                this.characters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    if (this.currentCharacter && char.id === this.currentCharacter.id) {
                        card.classList.add('active');
                    }
                    card.onclick = () => this.loadCharacter(char.id);
                    
                    // Calculate total level from paths
                    const charLevel = char.paths ? char.paths.reduce((sum, path) => {
                        if (path.level === undefined) throw new Error(`Path has undefined level in character ${char.id}`);
                        return sum + path.level;
                    }, 0) : 0;
                    
                    // Build paths display
                    let pathsDisplay = 'No Paths';
                    if (char.paths && char.paths.length > 0) {
                        pathsDisplay = char.paths
                            .filter(p => p.level > 0)
                            .map(p => {
                                const pathData = p.type === 'heroic' 
                                    ? this.rules.heroicPaths.find(hp => hp.id === p.id)
                                    : this.rules.radiantOrders.find(ro => ro.id === p.id);
                                const pathName = pathData ? pathData.name : p.id;
                                return `${pathName} ${p.level}`;
                            })
                            .join(' ‚Ä¢ ') || 'No Paths';
                    }
                    
                    card.innerHTML = `
                        <h3>${char.name || 'Unnamed Character'}</h3>
                        <p>Level ${charLevel} - ${pathsDisplay}</p>
                        <p>${char.ancestry} ‚Ä¢ ${char.culture}</p>
                    `;
                    
                    container.appendChild(card);
                });
            },

            renderCharacterSheet: function() {
                const char = this.currentCharacter;
                
                // Basic info
                document.getElementById('characterName').value = char.name || '';
                document.getElementById('playerName').value = char.playerName || '';
                const totalLevel = this.getTotalLevel();
                document.getElementById('characterLevel').textContent = totalLevel;
                
                // Tier
                const levelData = this.rules.advancement.levelProgression.find(l => l.level === totalLevel);
                const tierNames = ['Local Heroes', 'Regional Heroes', 'World Shapers'];
                const tierIndex = totalLevel <= 3 ? 0 : (totalLevel <= 6 ? 1 : 2);
                document.getElementById('characterTier').textContent = tierNames[tierIndex];
                
                // Ancestry dropdown
                const ancestrySelect = document.getElementById('ancestry');
                ancestrySelect.innerHTML = this.rules.ancestries.map(a => 
                    `<option value="${a}" ${char.ancestry === a ? 'selected' : ''}>${a}</option>`
                ).join('');
                
                // Culture dropdown
                const cultureSelect = document.getElementById('culture');
                cultureSelect.innerHTML = this.rules.cultures.map(c => 
                    `<option value="${c}" ${char.culture === c ? 'selected' : ''}>${c}</option>`
                ).join('');
                
                // Attributes
                document.getElementById('strength').value = char.attributes.strength;
                document.getElementById('speed').value = char.attributes.speed;
                document.getElementById('intellect').value = char.attributes.intellect;
                document.getElementById('willpower').value = char.attributes.willpower;
                document.getElementById('awareness').value = char.attributes.awareness;
                document.getElementById('presence').value = char.attributes.presence;
                
                // Skills
                this.renderSkills('physical');
                this.renderSkills('cognitive');
                this.renderSkills('spiritual');
                
                // Resources
                document.getElementById('currentHealth').value = char.currentHealth;
                document.getElementById('currentFocus').value = char.currentFocus;
                document.getElementById('currentInvestiture').value = char.currentInvestiture;
                document.getElementById('deflect').value = char.deflect;
                
                // Purpose and Obstacle
                document.getElementById('purpose').value = char.purpose || '';
                document.getElementById('obstacle').value = char.obstacle || '';
                
                // Goals
                this.renderGoals();
                
                // Notes
                document.getElementById('notes').value = char.notes || '';
                
                // Paths and Talents
                this.renderPathsAndTalents();
                
                // Surges
                this.renderSurges();
                
                // Expertises
                this.renderExpertises();
                
                // Equipment
                this.renderWeapons();
                this.renderArmorOptions();
                if (char.equippedArmor) {
                    document.getElementById('equippedArmor').value = char.equippedArmor;
                    this.equipArmor(char.equippedArmor);
                }
                this.renderInventory();
                
                // Starting Kit
                this.renderStartingKitOptions();
                if (char.startingKit) {
                    document.getElementById('startingKit').value = char.startingKit;
                    this.showStartingKitDetails(char.startingKit);
                }
                
                // Currency
                document.getElementById('chips').value = char.currency?.chips || 0;
                document.getElementById('marks').value = char.currency?.marks || 0;
                document.getElementById('broams').value = char.currency?.broams || 0;
                this.updateCurrency();
                
                // Injuries & Conditions
                this.renderInjuries();
                this.renderConditions();
                
                // Connections
                this.renderConnections();
                
                // Character Details
                document.getElementById('characterAge').value = char.characterDetails?.age || '';
                document.getElementById('characterGender').value = char.characterDetails?.gender || '';
                document.getElementById('characterHeight').value = char.characterDetails?.height || '';
                document.getElementById('characterWeight').value = char.characterDetails?.weight || '';
                document.getElementById('characterAppearance').value = char.characterDetails?.appearance || '';
                document.getElementById('characterBackstory').value = char.characterDetails?.backstory || '';
                
                // Path Levels Display
                const pathLevelsDisplay = document.getElementById('pathLevelsDisplay');
                if (char.paths && char.paths.length > 0) {
                    const pathLevels = char.paths
                        .filter(p => p.level > 0)
                        .map(p => {
                            const pathData = this.getPathData(p);
                            return `${pathData.name}: Level ${p.level}`;
                        })
                        .join(' | ');
                    pathLevelsDisplay.textContent = pathLevels || 'No path levels yet';
                } else {
                    pathLevelsDisplay.textContent = 'No paths selected';
                }
                
                // Recalculate all derived values                
                this.recalculateAll();
                this.updateCombatPlayDisplay();
            },

            renderSkills: function(category) {
                const container = document.getElementById(`${category}Skills`);
                const skills = this.rules.skills.list.filter(s => s.category === category);
                
                container.innerHTML = skills.map(skill => {
                    const rank = this.currentCharacter.skills[skill.id];
                    const attr = this.currentCharacter.attributes[skill.attribute];
                    if (rank === undefined) throw new Error(`Skill ${skill.id} is undefined`);
                    if (attr === undefined) throw new Error(`Attribute ${skill.attribute} is undefined`);
                    const modifier = attr + rank;
                    
                    return `
                        <div class="skill-row">
                            <div>
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-attr">(${skill.attribute.toUpperCase().substring(0,3)})</div>
                            </div>
                            <input type="number" class="skill-rank" 
                                   data-skill-id="${skill.id}"
                                   value="${rank}" 
                                   min="0" 
                                   max="${this.rules.skills.maxRanks}"
                                   oninput="app.updateSkill('${skill.id}', this.value)"
                                   title="${skill.description}">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="skill-modifier" title="Modifier = ${skill.attribute.toUpperCase().substring(0,3)} (${attr}) + Rank (${rank})">+${modifier}</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollInline('1d20+${modifier}', '${skill.name} Test')"
                                        title="Roll ${skill.name} test (1d20+${modifier})">üé≤</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateSkill: function(skillId, value) {
                const newValue = parseInt(value) || 0;
                // Enforce maximum rank
                if (newValue > this.rules.skills.maxRanks) {
                    this.currentCharacter.skills[skillId] = this.rules.skills.maxRanks;
                    // Update the input field to reflect the cap
                    const input = document.querySelector(`input.skill-rank[data-skill-id="${skillId}"]`);
                    if (input) {
                        input.value = this.rules.skills.maxRanks;
                    }
                } else {
                    this.currentCharacter.skills[skillId] = newValue;
                }
                this.recalculateAll();
                this.updateCharacter();
            },

            renderPathsAndTalents: function() {
                // Populate dropdown options
                const heroicOptions = document.getElementById('heroicPathOptions');
                const radiantOptions = document.getElementById('radiantOrderOptions');
                
                if (heroicOptions) {
                    heroicOptions.innerHTML = this.rules.heroicPaths.map(p => 
                        `<option value="heroic:${p.id}">${p.name}</option>`
                    ).join('');
                }
                
                if (radiantOptions) {
                    radiantOptions.innerHTML = this.rules.radiantOrders.map(o => 
                        `<option value="radiant:${o.id}">${o.name}</option>`
                    ).join('');
                }

                // Initialize paths array if needed
                if (!this.currentCharacter.paths) {
                    this.currentCharacter.paths = [];
                    // Migrate old heroicPath/radiantOrder if they exist
                    if (this.currentCharacter.heroicPath) {
                        this.currentCharacter.paths.push({type: 'heroic', id: this.currentCharacter.heroicPath});
                    }
                    if (this.currentCharacter.radiantOrder) {
                        this.currentCharacter.paths.push({type: 'radiant', id: this.currentCharacter.radiantOrder});
                    }
                }

                // Render each selected path
                const container = document.getElementById('pathsAndTalentsContainer');
                if (!container) return;
                
                if (this.currentCharacter.paths.length === 0) {
                    container.innerHTML = '<div class="help-text">No paths selected. Use the dropdown below to add a path.</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.paths.map((pathRef, index) => {
                    const pathData = this.getPathData(pathRef);
                    if (!pathData) return '';

                    return this.renderPathWithTalents(pathRef, pathData, index);
                }).join('');
            },

            getPathData: function(pathRef) {
                if (pathRef.type === 'heroic') {
                    return this.rules.heroicPaths.find(p => p.id === pathRef.id);
                } else if (pathRef.type === 'radiant') {
                    return this.rules.radiantOrders.find(o => o.id === pathRef.id);
                }
                return null;
            },

            renderSurges: function() {
                const surgesSection = document.getElementById('surgesSection');
                const surgesContainer = document.getElementById('surgesContainer');
                
                // Check if character has a Radiant Order
                const radiantPath = this.currentCharacter.paths.find(p => p.type === 'radiant');
                if (!radiantPath) {
                    surgesSection.style.display = 'none';
                    return;
                }
                
                surgesSection.style.display = 'block';
                
                const radiantOrder = this.rules.radiantOrders.find(o => o.id === radiantPath.id);
                if (!radiantOrder || !radiantOrder.surges) {
                    surgesContainer.innerHTML = '<div class="help-text">No surges found for this order.</div>';
                    return;
                }
                
                // Initialize surgeRanks if needed
                if (!this.currentCharacter.surgeRanks) {
                    this.currentCharacter.surgeRanks = {};
                }
                if (!this.currentCharacter.surgeTalents) {
                    this.currentCharacter.surgeTalents = [];
                }
                
                let html = '';
                radiantOrder.surges.forEach(surgeId => {
                    const surgeData = this.rules.surges[surgeId];
                    if (!surgeData) return;
                    
                    const currentRank = this.currentCharacter.surgeRanks[surgeId] ?? 0; // 0 is valid for unleveled
                    const attribute = this.rules.attributes.list.find(a => a.id === surgeData.attribute);
                    const attributeValue = this.currentCharacter.attributes[surgeData.attribute];
                    if (attributeValue === undefined) throw new Error(`Attribute ${surgeData.attribute} is undefined`);
                    const surgeModifier = attributeValue + currentRank;
                    
                    html += `
                        <div class="surge-card" style="border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 8px 0; color: var(--primary-color);">
                                        ${surgeData.name} (${attribute ? attribute.name : surgeData.attribute})
                                        <button class="roll-inline" onclick="diceRoller.rollInline('1d20+${surgeModifier}', '${surgeData.name} Test', true)" title="${surgeData.name} Test (1d20 + ${surgeModifier})">
                                            üé≤
                                        </button>
                                    </h3>
                                    <p style="margin: 5px 0; color: var(--text-secondary); font-size: 0.9em;">${surgeData.description}</p>
                                    <div style="font-size: 0.85em; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                                        <strong>Base Ability:</strong> ${surgeData.baseAbility}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px; padding: 4px 10px; background: linear-gradient(135deg, #6200ea, #b388ff); color: white; border-radius: 20px; font-weight: bold; font-size: 0.9em; margin-left: 10px;">
                                    <button onclick="app.changeSurgeRank('${surgeId}', -1)" 
                                            style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                            ${currentRank <= 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚àí</button>
                                    <span style="min-width: 60px; text-align: center;">Rank ${currentRank}</span>
                                    <button onclick="app.changeSurgeRank('${surgeId}', 1)" 
                                            style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                            ${currentRank >= 5 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>+</button>
                                </div>
                            </div>
                    `;
                    
                    // Show talents if surge has rank > 0
                    if (currentRank > 0 && surgeData.talents && surgeData.talents.length > 0) {
                        html += `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <h4 style="margin: 0 0 10px 0; font-size: 0.95em;">Surge Talents:</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                        `;
                        
                        surgeData.talents.forEach(talent => {
                            const talentId = `surge_${surgeId}_${talent.id}`;
                            const isSelected = this.currentCharacter.surgeTalents.includes(talentId);
                            
                            const activationIcons = {
                                '1_action': '‚ö°',
                                'free_action': '‚≠ê',
                                'reaction': 'üõ°Ô∏è',
                                'always': '‚àû',
                                'special': '‚óÜ'
                            };
                            const activationIcon = activationIcons[talent.activation] || '‚óè';
                            
                            html += `
                                <div class="talent-card-inline" 
                                     style="border: 2px solid ${isSelected ? 'var(--success-color)' : 'var(--border-color)'};
                                            background: ${isSelected ? '#e8f5e9' : 'white'};
                                            padding: 10px;
                                            border-radius: 4px;
                                            font-size: 0.85em;
                                            cursor: pointer;"
                                     onclick="app.toggleSurgeTalent('${talentId}')">
                                    <div style="font-weight: bold; margin-bottom: 4px;">
                                        ${activationIcon} ${talent.name}
                                        ${isSelected ? ' <span style="color: var(--success-color);">‚úì</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">
                                        <em>Prerequisite: ${talent.prerequisite}</em>
                                    </div>
                                    <div style="line-height: 1.3;">
                                        ${talent.description}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                surgesContainer.innerHTML = html;
            },

            changeSurgeRank: function(surgeId, delta) {
                if (!this.currentCharacter.surgeRanks) {
                    this.currentCharacter.surgeRanks = {};
                }
                
                const currentRank = this.currentCharacter.surgeRanks[surgeId] ?? 0; // 0 is valid for unleveled
                const newRank = Math.max(0, Math.min(5, currentRank + delta));
                
                this.currentCharacter.surgeRanks[surgeId] = newRank;
                this.updatePointTrackers(); // Update skill rank tracking
                this.validateCharacter();
                this.renderSurges();
                this.updateCharacter();
            },

            toggleSurgeTalent: function(talentId) {
                if (!this.currentCharacter.surgeTalents) {
                    this.currentCharacter.surgeTalents = [];
                }
                
                const index = this.currentCharacter.surgeTalents.indexOf(talentId);
                if (index >= 0) {
                    this.currentCharacter.surgeTalents.splice(index, 1);
                } else {
                    this.currentCharacter.surgeTalents.push(talentId);
                }
                
                this.updatePointTrackers(); // Update talent point tracking
                this.validateCharacter();
                this.renderSurges();
                this.updateCharacter();
            },

            renderPathWithTalents: function(pathRef, pathData, index) {
                const expandedId = `path-${index}`;
                const isExpanded = this.expandedPaths && this.expandedPaths[expandedId];
                const pathLevel = pathRef.level || 0;

                let html = `
                    <div class="path-section" style="border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <h3 style="margin: 0; color: var(--primary-color);">
                                        ${pathRef.type === 'heroic' ? '‚öîÔ∏è' : '‚ú®'} ${pathData.name}
                                    </h3>
                                    <div style="display: flex; align-items: center; gap: 5px; padding: 4px 10px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                        <button onclick="app.changePathLevel(${index}, -1)" 
                                                style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                                ${pathLevel <= 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚àí</button>
                                        <span style="min-width: 60px; text-align: center;">Level ${pathLevel}</span>
                                        <button onclick="app.changePathLevel(${index}, 1)" 
                                                style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                                ${pathLevel >= 10 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>+</button>
                                    </div>
                                </div>
                                <p style="margin: 5px 0; color: var(--text-secondary); font-size: 0.9em;">${pathData.description}</p>
                `;

                if (pathRef.type === 'heroic' && pathData.keyTalent) {
                    html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Key Talent:</strong> ${pathData.keyTalent.name} - ${pathData.keyTalent.description}</div>`;
                }

                if (pathRef.type === 'radiant') {
                    html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Surges:</strong> ${pathData.surges.join(', ')}</div>`;
                    if (pathData.oaths && pathData.oaths.length > 0) {
                        html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Ideals:</strong></div>`;
                        html += `<ul style="margin: 5px 0; padding-left: 20px; font-size: 0.85em;">`;
                        pathData.oaths.forEach(oath => {
                            html += `<li style="font-style: italic; margin: 2px 0;">"${oath}"</li>`;
                        });
                        html += `</ul>`;
                    }
                }

                html += `
                            </div>
                            <div style="display: flex; gap: 10px; align-items: start;">
                                ${pathLevel > 0 ? `<button onclick="app.togglePathTalents('${expandedId}')" style="padding: 5px 15px;">
                                    ${isExpanded ? '‚ñº Hide' : '‚ñ∂ Show'} Talents
                                </button>` : ''}
                                <button onclick="app.removePath(${index})" class="danger" style="padding: 5px 10px;">√ó</button>
                            </div>
                        </div>
                `;

                // Show talents if expanded and path has levels
                if (isExpanded && pathData.specialties && pathLevel > 0) {
                    html += this.renderPathTalentsSection(pathData, pathRef.id, pathLevel);
                }

                html += `</div>`;
                return html;
            },

            renderPathTalentsSection: function(pathData, pathId, pathLevel) {
                // Note: Talent points are GLOBAL (from total character level), not per-path
                // The global talent point counter at the top of the sheet tracks all talent usage

                let html = `
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                `;

                pathData.specialties.forEach(specialty => {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 10px 0 8px 0; color: var(--secondary-color);">${specialty.name}</h4>
                            <p style="margin: 0 0 10px 0; font-size: 0.85em; color: var(--text-secondary);">${specialty.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                    `;

                    specialty.talents.forEach(talent => {
                        const talentId = `${pathId}_${talent.id}`;
                        const isSelected = this.currentCharacter.talents.includes(talentId);

                        const activationIcons = {
                            '1_action': '‚ñ∂',
                            '2_actions': '‚ñ∂‚ñ∂',
                            '3_actions': '‚ñ∂‚ñ∂‚ñ∂',
                            'free_action': '‚óÜ',
                            'reaction': '‚Üª',
                            'special': '‚òÖ',
                            'always': '‚àû'
                        };
                        const activationIcon = activationIcons[talent.activation] || '‚òÖ';

                        html += `
                            <div class="talent-card-inline" 
                                 style="border: 2px solid ${isSelected ? 'var(--success-color)' : 'var(--border-color)'};
                                        background: ${isSelected ? '#e8f5e9' : 'white'};
                                        padding: 10px;
                                        border-radius: 4px;
                                        font-size: 0.85em;
                                        cursor: pointer;"
                                 onclick="app.toggleTalent('${talentId}')">
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${activationIcon} ${talent.name}
                                    ${isSelected ? ' <span style="color: var(--success-color);">‚úì</span>' : ''}
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">
                                    <em>Prerequisite: ${talent.prerequisite}</em>
                                </div>
                                <div style="line-height: 1.3;">
                                    ${talent.description}
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                return html;
            },

            togglePathTalents: function(pathId) {
                if (!this.expandedPaths) this.expandedPaths = {};
                this.expandedPaths[pathId] = !this.expandedPaths[pathId];
                this.renderPathsAndTalents();
            },

            toggleTalent: function(talentId) {
                if (!this.currentCharacter.talents) {
                    this.currentCharacter.talents = [];
                }

                const index = this.currentCharacter.talents.indexOf(talentId);
                if (index > -1) {
                    // Remove talent
                    this.currentCharacter.talents.splice(index, 1);
                } else {
                    // Add talent
                    this.currentCharacter.talents.push(talentId);
                }

                this.updatePointTrackers(); // Update talent point tracking
                this.validateCharacter();
                this.renderPathsAndTalents();
                this.updateCharacter();
            },

            addPath: function(value) {
                if (!value) return;
                
                const [type, id] = value.split(':');
                const pathType = type === 'heroic' ? 'heroic' : 'radiant';
                
                // Check if already added
                const exists = this.currentCharacter.paths.some(p => p.type === pathType && p.id === id);
                if (exists) {
                    alert('This path is already added!');
                    return;
                }
                
                // Check if trying to add a radiant order before having any levels
                if (pathType === 'radiant' && this.getTotalLevel() < 1) {
                    alert('You must have at least 1 level before adding a Radiant Order.');
                    return;
                }
                
                // Check if trying to add a second radiant order
                if (pathType === 'radiant') {
                    const hasRadiant = this.currentCharacter.paths.some(p => p.type === 'radiant');
                    if (hasRadiant) {
                        alert('You can only have one Radiant Order! Remove your current order first.');
                        return;
                    }
                }
                
                const pathRef = {type: pathType, id: id, level: 0};
                this.currentCharacter.paths.push(pathRef);
                
                // Grant starting skill rank if this is the first heroic path at character creation
                if (pathType === 'heroic' && this.getTotalLevel() === 0) {
                    const pathData = this.rules.heroicPaths.find(p => p.id === id);
                    if (pathData && pathData.startingSkill) {
                        const skillId = pathData.startingSkill;
                        // Only grant if they don't already have ranks in this skill
                        if (!this.currentCharacter.skills[skillId]) {
                            this.currentCharacter.skills[skillId] = 1;
                        }
                    }
                }
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            changePathLevel: function(pathIndex, delta) {
                const path = this.currentCharacter.paths[pathIndex];
                if (!path) return;
                
                if (path.level === undefined) throw new Error(`Path ${pathId} has undefined level`);
                const newLevel = path.level + delta;
                if (newLevel < 0 || newLevel > 10) return;
                
                path.level = newLevel;
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            getTotalLevel: function() {
                if (!this.currentCharacter.paths) return 0;
                const total = this.currentCharacter.paths.reduce((sum, path) => {
                    if (path.level === undefined) throw new Error(`Path ${path.id} has undefined level`);
                    return sum + path.level;
                }, 0);
                return total;
            },

            removePath: function(index) {
                if (!confirm('Remove this path? All associated talents will be lost.')) return;
                
                const pathRef = this.currentCharacter.paths[index];
                
                // Remove talents associated with this path
                const pathId = pathRef.id;
                this.currentCharacter.talents = this.currentCharacter.talents.filter(t => 
                    !t.startsWith(pathId + '_')
                );
                
                this.currentCharacter.paths.splice(index, 1);
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            renderExpertises: function() {
                const container = document.getElementById('expertiseList');
                const expertises = this.currentCharacter.expertises || [];
                
                const tags = expertises.map((exp, index) => `
                    <div class="expertise-tag">
                        ${exp}
                        <button class="expertise-remove" onclick="app.removeExpertise(${index})">√ó</button>
                    </div>
                `).join('');
                
                container.innerHTML = tags + `
                    <button class="add-expertise" onclick="app.addExpertise()">+ Add Expertise</button>
                `;
            },

            addExpertise: function() {
                const expertise = prompt('Enter expertise name:');
                if (expertise && expertise.trim()) {
                    this.currentCharacter.expertises.push(expertise.trim());
                    this.renderExpertises();
                    this.updateCharacter();
                }
            },

            removeExpertise: function(index) {
                this.currentCharacter.expertises.splice(index, 1);
                this.renderExpertises();
                this.updateCharacter();
            },

            recalculateAll: function() {
                const char = this.currentCharacter;
                const totalLevel = this.getTotalLevel();
                
                // Defenses
                const physicalDefense = 10 + char.attributes.strength + char.attributes.speed;
                const cognitiveDefense = 10 + char.attributes.intellect + char.attributes.willpower;
                const spiritualDefense = 10 + char.attributes.awareness + char.attributes.presence;
                
                document.getElementById('physicalDefense').textContent = physicalDefense;
                document.getElementById('cognitiveDefense').textContent = cognitiveDefense;
                document.getElementById('spiritualDefense').textContent = spiritualDefense;
                
                // Resources
                const maxHealth = this.rules.resources.health.baseValue + (totalLevel * this.rules.resources.health.perLevel);
                const maxFocus = this.rules.resources.focus.baseValue + (totalLevel * this.rules.resources.focus.perLevel);
                
                document.getElementById('maxHealth').textContent = maxHealth;
                document.getElementById('maxFocus').textContent = maxFocus;
                
                // Investiture (only for Radiants)
                const hasRadiant = char.paths && char.paths.some(p => p.type === 'radiant' && p.level > 0);
                if (hasRadiant) {
                    const maxInvestiture = this.rules.resources.investiture.baseValue + (totalLevel * this.rules.resources.investiture.perLevel);
                    document.getElementById('maxInvestiture').textContent = maxInvestiture;
                } else {
                    document.getElementById('maxInvestiture').textContent = '‚Äî';
                }
                
                // Recovery Die
                let recoveryDie = '1d6';
                for (const [level, die] of Object.entries(this.rules.resources.recoveryDie.progression).reverse()) {
                    if (totalLevel >= parseInt(level)) {
                        recoveryDie = die;
                        break;
                    }
                }
                document.getElementById('recoveryDie').textContent = recoveryDie;
                
                // Movement
                const movement = this.rules.movement.baseSpeed + (char.attributes.speed * 5);
                document.getElementById('movement').textContent = movement + ' ft';
                
                // Senses
                const senses = this.rules.senses.baseRange + (char.attributes.awareness * 10);
                document.getElementById('sensesRange').textContent = senses + ' ft';
                
                // Lifting
                const lifting = this.rules.lifting.baseCapacity + (char.attributes.strength * 50);
                document.getElementById('liftingCapacity').textContent = lifting + ' lbs';
                
                // Update skill modifiers
                this.renderSkills('physical');
                this.renderSkills('cognitive');
                this.renderSkills('spiritual');
                
                // Combat stats
                this.calculateAttackBonuses();
                this.calculateInitiative();
                
                // Update point trackers and validation
                this.updatePointTrackers();
                this.validateCharacter();
                this.updateCombatPlayDisplay();
            },

            updatePointTrackers: function() {
                const char = this.currentCharacter;
                const totalLevel = this.getTotalLevel();
                
                // Calculate available attribute points (12 base + increases from leveling)
                let totalAttributePoints = this.rules.attributes.startingTotal;
                for (let i = 1; i <= totalLevel; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData && levelData.attributeIncreases) {
                        totalAttributePoints += levelData.attributeIncreases;
                    }
                }
                
                // Calculate used attribute points
                const usedAttributePoints = Object.values(char.attributes).reduce((sum, val) => sum + val, 0);
                const remainingAttributePoints = totalAttributePoints - usedAttributePoints;
                
                // Store for use by validateCharacter()
                this.cachedPointData = {
                    totalAttributePoints,
                    usedAttributePoints,
                    remainingAttributePoints,
                    totalSkillRanks: 0,
                    usedSkillRanks: 0,
                    remainingSkillRanks: 0
                };
                
                // Update attribute tracker UI
                document.getElementById('attributePointsUsed').textContent = usedAttributePoints;
                document.getElementById('attributePointsTotal').textContent = totalAttributePoints;
                document.getElementById('attributePointsRemaining').textContent = remainingAttributePoints + ' remaining';
                
                const attrRemainingElem = document.getElementById('attributePointsRemaining');
                attrRemainingElem.classList.remove('over', 'complete');
                if (remainingAttributePoints < 0) {
                    attrRemainingElem.classList.add('over');
                } else if (remainingAttributePoints === 0) {
                    attrRemainingElem.classList.add('complete');
                }
                
                // Update attribute progress bar
                const attrProgress = Math.min((usedAttributePoints / totalAttributePoints) * 100, 100);
                const attrProgressBar = document.getElementById('attributeProgressBar');
                attrProgressBar.style.width = attrProgress + '%';
                attrProgressBar.classList.remove('over', 'complete');
                if (remainingAttributePoints < 0) {
                    attrProgressBar.classList.add('over');
                } else if (remainingAttributePoints === 0) {
                    attrProgressBar.classList.add('complete');
                }
                
                // Calculate available skill ranks (from leveling)
                let totalSkillRanks = 0;
                for (let i = 1; i <= totalLevel; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData && levelData.skillRankIncreases) {
                        totalSkillRanks += levelData.skillRankIncreases;
                    }
                }
                
                // Calculate used skill ranks (including surge ranks)
                const regularSkillRanks = Object.values(char.skills).reduce((sum, rank) => sum + rank, 0);
                const surgeRanks = char.surgeRanks ? Object.values(char.surgeRanks).reduce((sum, rank) => sum + rank, 0) : 0;
                const usedSkillRanks = regularSkillRanks + surgeRanks;
                const remainingSkillRanks = totalSkillRanks - usedSkillRanks;
                
                // Update cached values for use by validateCharacter()
                this.cachedPointData.totalSkillRanks = totalSkillRanks;
                this.cachedPointData.usedSkillRanks = usedSkillRanks;
                this.cachedPointData.remainingSkillRanks = remainingSkillRanks;
                
                // Update skill tracker UI
                document.getElementById('skillRanksUsed').textContent = `${usedSkillRanks} (${regularSkillRanks} skills + ${surgeRanks} surges)`;
                document.getElementById('skillRanksTotal').textContent = totalSkillRanks;
                document.getElementById('skillRanksRemaining').textContent = remainingSkillRanks + ' remaining';
                
                const skillRemainingElem = document.getElementById('skillRanksRemaining');
                skillRemainingElem.classList.remove('over', 'complete');
                if (remainingSkillRanks < 0) {
                    skillRemainingElem.classList.add('over');
                } else if (remainingSkillRanks === 0 && totalSkillRanks > 0) {
                    skillRemainingElem.classList.add('complete');
                }
                
                // Update skill progress bar
                const skillProgress = totalSkillRanks > 0 ? Math.min((usedSkillRanks / totalSkillRanks) * 100, 100) : 0;
                const skillProgressBar = document.getElementById('skillProgressBar');
                skillProgressBar.style.width = skillProgress + '%';
                skillProgressBar.classList.remove('over', 'complete');
                if (remainingSkillRanks < 0) {
                    skillProgressBar.classList.add('over');
                } else if (remainingSkillRanks === 0 && totalSkillRanks > 0) {
                    skillProgressBar.classList.add('complete');
                }
                
                // Calculate available talent points (from total character level)
                // Talent points are GLOBAL, not per-path
                // Each level grants 1 talent point
                let totalTalentPoints = 0;
                
                for (let i = 1; i <= totalLevel; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData && levelData.talentPoints) {
                        totalTalentPoints += levelData.talentPoints;
                    }
                }
                
                // Add ancestry bonus talents (at levels 1, 6, 11, 16, 21)
                const ancestryBonusLevels = [1, 6, 11, 16, 21];
                let ancestryBonusTalents = 0;
                for (const bonusLevel of ancestryBonusLevels) {
                    if (totalLevel >= bonusLevel) {
                        // Singers get Change Form automatically at level 1, plus 1 bonus talent
                        // Humans get 1 bonus talent
                        // All ancestries get 1 bonus talent at 6, 11, 16, 21
                        if (char.ancestry === 'Singer' && bonusLevel === 1) {
                            ancestryBonusTalents += 2; // Change Form + 1 form talent
                        } else {
                            ancestryBonusTalents += 1;
                        }
                    }
                }
                totalTalentPoints += ancestryBonusTalents;
                
                // Calculate used talent points (path talents + surge talents)
                const pathTalents = char.talents ? char.talents.length : 0;
                const surgeTalents = char.surgeTalents ? char.surgeTalents.length : 0;
                const usedTalentPoints = pathTalents + surgeTalents;
                const remainingTalentPoints = totalTalentPoints - usedTalentPoints;
                
                // Store for use by validation
                this.cachedPointData.totalTalentPoints = totalTalentPoints;
                this.cachedPointData.usedTalentPoints = usedTalentPoints;
                this.cachedPointData.remainingTalentPoints = remainingTalentPoints;
                
                // Update talent points display (new tracker UI at top)
                document.getElementById('talentPointsUsed').textContent = usedTalentPoints;
                document.getElementById('talentPointsTotal').textContent = totalTalentPoints;
                document.getElementById('talentPointsRemaining').textContent = remainingTalentPoints + ' remaining';
                
                const talentRemainingElem = document.getElementById('talentPointsRemaining');
                talentRemainingElem.classList.remove('over', 'complete');
                if (remainingTalentPoints < 0) {
                    talentRemainingElem.classList.add('over');
                } else if (remainingTalentPoints === 0 && totalTalentPoints > 0) {
                    talentRemainingElem.classList.add('complete');
                }
                
                // Update talent progress bar
                const talentProgress = totalTalentPoints > 0 ? Math.min((usedTalentPoints / totalTalentPoints) * 100, 100) : 0;
                const talentProgressBar = document.getElementById('talentProgressBar');
                talentProgressBar.style.width = talentProgress + '%';
                talentProgressBar.classList.remove('over', 'complete');
                if (remainingTalentPoints < 0) {
                    talentProgressBar.classList.add('over');
                } else if (remainingTalentPoints === 0 && totalTalentPoints > 0) {
                    talentProgressBar.classList.add('complete');
                }
                
                // Update breakdown help text
                const baseTalentPoints = totalTalentPoints - ancestryBonusTalents;
                const breakdownText = ancestryBonusTalents > 0 
                    ? `${baseTalentPoints} from levels + ${ancestryBonusTalents} from ancestry (${pathTalents} path + ${surgeTalents} surge selected)`
                    : `${baseTalentPoints} from levels (${pathTalents} path + ${surgeTalents} surge selected)`;
                document.getElementById('talentPointsBreakdown').textContent = breakdownText;
                
                // Also update old display if it exists (for backwards compatibility)
                const talentPointsElem = document.getElementById('talentPoints');
                if (talentPointsElem) {
                    if (totalTalentPoints === 0) {
                        talentPointsElem.textContent = `No talents available (Level up to gain talent points)`;
                        talentPointsElem.style.color = 'inherit';
                    } else {
                        let breakdown = ancestryBonusTalents > 0 
                            ? `${usedTalentPoints}/${totalTalentPoints} used (${baseTalentPoints} level + ${ancestryBonusTalents} ancestry | ${pathTalents} path + ${surgeTalents} surge) - ${remainingTalentPoints} remaining`
                            : `${usedTalentPoints}/${totalTalentPoints} used (${pathTalents} path + ${surgeTalents} surge) - ${remainingTalentPoints} remaining`;
                        talentPointsElem.textContent = breakdown;
                        talentPointsElem.style.color = remainingTalentPoints < 0 ? 'var(--error-color)' : 
                                                       remainingTalentPoints === 0 ? 'var(--success-color)' : 
                                                       'inherit';
                    }
                }
            },

            validateCharacter: function() {
                const char = this.currentCharacter;
                const issues = [];
                const warnings = [];
                
                // Validate character name
                if (!char.name || char.name.trim() === '' || char.name === 'New Character') {
                    issues.push('Please enter a character name');
                }
                
                // Use cached point data from updatePointTrackers() - SINGLE SOURCE OF TRUTH
                if (!this.cachedPointData) {
                    // Initialize if not yet set
                    this.cachedPointData = {
                        totalAttributePoints: 0,
                        usedAttributePoints: 0,
                        remainingAttributePoints: 0,
                        totalSkillRanks: 0,
                        usedSkillRanks: 0,
                        remainingSkillRanks: 0
                    };
                }
                
                const { totalAttributePoints, usedAttributePoints, remainingAttributePoints } = this.cachedPointData;
                
                // Validate attribute points
                if (remainingAttributePoints < 0) {
                    issues.push(`You have used ${-remainingAttributePoints} too many attribute points`);
                } else if (remainingAttributePoints > 0) {
                    warnings.push(`You have ${remainingAttributePoints} unspent attribute points`);
                }
                
                // Check for attributes over maximum
                for (const [attr, value] of Object.entries(char.attributes)) {
                    if (value > this.rules.attributes.maxValue) {
                        issues.push(`${attr.charAt(0).toUpperCase() + attr.slice(1)} cannot exceed ${this.rules.attributes.maxValue}`);
                    }
                }
                
                // Validate skill ranks using cached data
                const { totalSkillRanks, usedSkillRanks, remainingSkillRanks } = this.cachedPointData;
                
                if (remainingSkillRanks < 0) {
                    issues.push(`You have used ${-remainingSkillRanks} too many skill ranks`);
                } else if (remainingSkillRanks > 0 && totalSkillRanks > 0) {
                    warnings.push(`You have ${remainingSkillRanks} unspent skill ranks`);
                }
                
                // Check for skills over maximum
                for (const [skillId, rank] of Object.entries(char.skills)) {
                    if (rank > this.rules.skills.maxRanks) {
                        const skill = this.rules.skills.list.find(s => s.id === skillId);
                        issues.push(`${skill.name} cannot exceed ${this.rules.skills.maxRanks} ranks`);
                    }
                }
                
                // Validate talent points using cached data
                if (this.cachedPointData.totalTalentPoints !== undefined) {
                    const { totalTalentPoints, usedTalentPoints, remainingTalentPoints } = this.cachedPointData;
                    
                    if (remainingTalentPoints < 0) {
                        issues.push(`You have used ${-remainingTalentPoints} too many talent points (Level up to gain more)`);
                    } else if (remainingTalentPoints > 0 && totalTalentPoints > 0) {
                        warnings.push(`You have ${remainingTalentPoints} unspent talent points`);
                    }
                }
                
                // Validate heroic path selection
                const hasHeroicPath = char.paths && char.paths.some(p => p.type === 'heroic' && (p.level || 0) > 0);
                if (!hasHeroicPath) {
                    warnings.push('Consider selecting a Heroic Path');
                }
                
                // Validate purpose and obstacle (recommended but not required)
                if (!char.purpose || char.purpose.trim() === '') {
                    warnings.push('Consider adding a Purpose for your character');
                }
                
                if (!char.obstacle || char.obstacle.trim() === '') {
                    warnings.push('Consider adding an Obstacle for your character');
                }
                
                // Update validation summary
                this.renderValidationSummary(issues, warnings);
                
                // Update character complete badge
                const isComplete = issues.length === 0 && warnings.length <= 2; // Allow missing purpose/obstacle
                const badge = document.getElementById('characterCompleteBadge');
                if (isComplete) {
                    badge.textContent = '‚úì Character Complete';
                    badge.className = 'character-complete-badge complete';
                } else {
                    badge.textContent = '‚ö† Incomplete';
                    badge.className = 'character-complete-badge incomplete';
                }
            },

            renderValidationSummary: function(issues, warnings) {
                const container = document.getElementById('validationSummary');
                
                if (issues.length === 0 && warnings.length === 0) {
                    container.innerHTML = `
                        <div class="validation-warning success">
                            <span class="validation-icon">‚úì</span>
                            <div class="validation-message">
                                <strong>Character is ready to play!</strong> All required fields are complete.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Show errors
                if (issues.length > 0) {
                    html += `
                        <div class="validation-warning error">
                            <span class="validation-icon">‚ö†</span>
                            <div class="validation-message">
                                <strong>Issues to fix:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Show warnings
                if (warnings.length > 0) {
                    html += `
                        <div class="validation-warning">
                            <span class="validation-icon">‚Ñπ</span>
                            <div class="validation-message">
                                <strong>Recommendations:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${warnings.map(warning => `<li>${warning}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            },

            updateAttributeValue: function(attrName, value) {
                this.currentCharacter.attributes[attrName] = parseInt(value) || 0;
                this.recalculateAll();
                this.updateCharacter();
            },

            updateCharacter: function() {
                const char = this.currentCharacter;
                
                char.name = document.getElementById('characterName').value;
                char.playerName = document.getElementById('playerName').value;
                char.ancestry = document.getElementById('ancestry').value;
                char.culture = document.getElementById('culture').value;
                
                char.attributes.strength = parseInt(document.getElementById('strength').value) || 0;
                char.attributes.speed = parseInt(document.getElementById('speed').value) || 0;
                char.attributes.intellect = parseInt(document.getElementById('intellect').value) || 0;
                char.attributes.willpower = parseInt(document.getElementById('willpower').value) || 0;
                char.attributes.awareness = parseInt(document.getElementById('awareness').value) || 0;
                char.attributes.presence = parseInt(document.getElementById('presence').value) || 0;
                
                char.currentHealth = parseInt(document.getElementById('currentHealth').value) || 0;
                char.currentFocus = parseInt(document.getElementById('currentFocus').value) || 0;
                char.currentInvestiture = parseInt(document.getElementById('currentInvestiture').value) || 0;
                char.deflect = parseInt(document.getElementById('deflect').value) || 0;
                
                char.purpose = document.getElementById('purpose').value;
                char.obstacle = document.getElementById('obstacle').value;
                char.notes = document.getElementById('notes').value;
                
                // Character details
                if (!char.characterDetails) char.characterDetails = {};
                char.characterDetails.age = document.getElementById('characterAge').value;
                char.characterDetails.gender = document.getElementById('characterGender').value;
                char.characterDetails.height = document.getElementById('characterHeight').value;
                char.characterDetails.weight = document.getElementById('characterWeight').value;
                char.characterDetails.appearance = document.getElementById('characterAppearance').value;
                char.characterDetails.backstory = document.getElementById('characterBackstory').value;
                
                char.updatedAt = new Date().toISOString();
                
                this.renderCharacterList();
                this.saveToLocalStorage();
            },



            checkTalentPrerequisite: function(talent, pathId) {
                if (talent.prerequisite === 'none') return true;

                const char = this.currentCharacter;
                const prereq = talent.prerequisite;

                // Check for skill rank requirements (e.g., "Deduction 1+")
                const skillRankMatch = prereq.match(/(\w+)\s+(\d+)\+/);
                if (skillRankMatch) {
                    const skillName = skillRankMatch[1];
                    const requiredRank = parseInt(skillRankMatch[2]);
                    
                    // Find skill by name
                    const skill = this.rules.skills.list.find(s => 
                        s.name.toLowerCase() === skillName.toLowerCase() || 
                        s.id === skillName.toLowerCase().replace(/\s+/g, '_')
                    );
                    
                    if (skill) {
                        const currentRank = char.skills[skill.id] || 0;
                        if (currentRank < requiredRank) return false;
                    }
                }

                // Check for other talent requirements
                const talentMatch = prereq.match(/([A-Z][^,]+)/g);
                if (talentMatch) {
                    for (const talentName of talentMatch) {
                        const cleanName = talentName.trim();
                        // Check if it's a talent name (not a skill rank requirement)
                        if (!cleanName.match(/\d+\+$/)) {
                            // Find talent by name across all paths
                            let found = false;
                            this.rules.heroicPaths.forEach(path => {
                                path.specialties.forEach(spec => {
                                    if (spec.talents.some(t => {
                                        const fullTalentId = `${path.id}_${t.id}`;
                                        return t.name === cleanName && char.talents.includes(fullTalentId);
                                    })) {
                                        found = true;
                                    }
                                });
                            });
                            if (!found) return false;
                        }
                    }
                }

                return true;
            },

            toggleTalent: function(talentId) {
                if (!this.currentCharacter.talents) {
                    this.currentCharacter.talents = [];
                }

                const index = this.currentCharacter.talents.indexOf(talentId);
                if (index > -1) {
                    // Remove talent
                    this.currentCharacter.talents.splice(index, 1);
                } else {
                    // Add talent
                    this.currentCharacter.talents.push(talentId);
                }

                // Full re-render to ensure all derived values update (some talents may affect stats)
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            deleteCurrentCharacter: function() {
                if (confirm(`Are you sure you want to delete ${this.currentCharacter.name}? This cannot be undone.`)) {
                    this.characters = this.characters.filter(c => c.id !== this.currentCharacter.id);
                    this.saveToLocalStorage();
                    
                    if (this.characters.length > 0) {
                        this.loadCharacter(this.characters[0].id);
                    } else {
                        this.currentCharacter = null;
                        document.getElementById('characterSheetSection').classList.add('hidden');
                        this.createNewCharacter();
                    }
                    
                    this.renderCharacterList();
                }
            },

            saveToLocalStorage: function() {
                try {
                    localStorage.setItem('cosmereCharacters', JSON.stringify(this.characters));
                    console.log('Saved to localStorage');
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    alert('Error saving to local storage. Your browser may have storage disabled.');
                }
            },

            loadFromLocalStorage: function() {
                try {
                    const saved = localStorage.getItem('cosmereCharacters');
                    if (saved) {
                        this.characters = JSON.parse(saved);
                        console.log('Loaded from localStorage');
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            },

            exportToFile: async function() {
                if (!this.currentCharacter) return;
                
                const dataStr = JSON.stringify(this.currentCharacter, null, 2);
                const totalLevel = this.getTotalLevel();
                const defaultFileName = `${this.currentCharacter.name.replace(/[^a-z0-9]/gi, '_')}_Lv${totalLevel}.json`;
                
                // Try to use File System Access API (Chrome, Edge, Opera)
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: defaultFileName,
                            types: [{
                                description: 'Character JSON',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        
                        const writable = await handle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                        
                        console.log('Character exported successfully');
                        return;
                    } catch (err) {
                        // User cancelled or error occurred
                        if (err.name !== 'AbortError') {
                            console.error('Export error:', err);
                        }
                        return;
                    }
                }
                
                // Fallback for browsers without File System Access API
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = defaultFileName;
                link.click();
                
                URL.revokeObjectURL(url);
            },

            importFromFile: function() {
                document.getElementById('fileInput').click();
            },

            handleFileImport: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const character = JSON.parse(e.target.result);
                        
                        // Generate new ID to avoid conflicts
                        character.id = Date.now().toString();
                        character.updatedAt = new Date().toISOString();
                        
                        this.characters.push(character);
                        this.loadCharacter(character.id);
                        this.saveToLocalStorage();
                        
                        alert('Character imported successfully!');
                    } catch (error) {
                        console.error('Error importing character:', error);
                        alert('Error importing character. Make sure the file is a valid character JSON.');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            },

            // ========== EQUIPMENT & COMBAT FUNCTIONS ==========
            
            addWeapon: function() {
                // Open weapon selection modal
                this.renderWeaponModal();
                document.getElementById('weaponModal').classList.add('active');
            },

            closeWeaponModal: function() {
                document.getElementById('weaponModal').classList.remove('active');
            },

            renderWeaponModal: function() {
                const renderWeaponList = (weapons, containerId) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = weapons.map(weapon => `
                        <div class="weapon-option" onclick="app.selectWeapon('${weapon.id}', '${containerId.includes('light') ? 'light' : 'heavy'}')">
                            <div class="weapon-option-name">${weapon.name}</div>
                            <div class="weapon-option-stats">
                                ${weapon.damage} ${weapon.damageType} | ${weapon.range}<br>
                                ${weapon.price} mk | ${weapon.weight} lbs
                            </div>
                            ${weapon.traits && weapon.traits.length > 0 ? 
                                `<div style="font-size: 0.75em; margin-top: 4px; color: #666;">${weapon.traits.slice(0, 2).join(', ')}</div>` 
                                : ''}
                        </div>
                    `).join('');
                };

                renderWeaponList(this.rules.weapons.light, 'lightWeaponsList');
                renderWeaponList(this.rules.weapons.heavy, 'heavyWeaponsList');
            },

            filterWeapons: function(searchTerm) {
                const term = searchTerm.toLowerCase();
                
                const filterList = (weapons, containerId) => {
                    const filtered = weapons.filter(w => 
                        w.name.toLowerCase().includes(term) || 
                        w.damageType.toLowerCase().includes(term) ||
                        (w.traits && w.traits.some(t => t.toLowerCase().includes(term)))
                    );
                    
                    const container = document.getElementById(containerId);
                    if (filtered.length === 0) {
                        container.innerHTML = '<div class="help-text">No weapons found</div>';
                    } else {
                        container.innerHTML = filtered.map(weapon => `
                            <div class="weapon-option" onclick="app.selectWeapon('${weapon.id}', '${containerId.includes('light') ? 'light' : 'heavy'}')">
                                <div class="weapon-option-name">${weapon.name}</div>
                                <div class="weapon-option-stats">
                                    ${weapon.damage} ${weapon.damageType} | ${weapon.range}<br>
                                    ${weapon.price} mk | ${weapon.weight} lbs
                                </div>
                                ${weapon.traits && weapon.traits.length > 0 ? 
                                    `<div style="font-size: 0.75em; margin-top: 4px; color: #666;">${weapon.traits.slice(0, 2).join(', ')}</div>` 
                                    : ''}
                            </div>
                        `).join('');
                    }
                };

                filterList(this.rules.weapons.light, 'lightWeaponsList');
                filterList(this.rules.weapons.heavy, 'heavyWeaponsList');
            },

            selectWeapon: function(weaponId, category) {
                const weapon = this.rules.weapons[category].find(w => w.id === weaponId);
                if (!weapon) return;
                
                if (!this.currentCharacter.weapons) this.currentCharacter.weapons = [];
                this.currentCharacter.weapons.push({...weapon, equipped: true});
                
                this.closeWeaponModal();
                this.renderWeapons();
                this.calculateAttackBonuses();
                this.updateCharacter();
            },

            removeWeapon: function(index) {
                if (!confirm('Remove this weapon?')) return;
                this.currentCharacter.weapons.splice(index, 1);
                this.renderWeapons();
                this.calculateAttackBonuses();
                this.updateCharacter();
            },

            renderWeapons: function() {
                const container = document.getElementById('weaponsList');
                if (!this.currentCharacter.weapons || this.currentCharacter.weapons.length === 0) {
                    container.innerHTML = '<div class="help-text">No weapons equipped. Click "Add Weapon" to equip a weapon.</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.weapons.map((weapon, index) => {
                    const skillData = this.rules.skills.list.find(s => s.id === weapon.skill);
                    if (!skillData) throw new Error(`Weapon skill ${weapon.skill} not found in rules`);
                    const skillName = skillData.name;
                    const skillRank = this.currentCharacter.skills[weapon.skill];
                    if (skillRank === undefined) throw new Error(`Skill rank for ${weapon.skill} is undefined`);
                    const attr = skillData.attribute;
                    const attrValue = this.currentCharacter.attributes[attr];
                    if (attrValue === undefined) throw new Error(`Attribute ${attr} is undefined`);
                    const attackBonus = attrValue + skillRank;
                    
                    return `
                        <div class="item-card">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">${weapon.name}</div>
                                <div class="item-details">
                                    <div class="item-stat">
                                        <div class="item-stat-label">Damage</div>
                                        <div class="item-stat-value">${weapon.damage} ${weapon.damageType}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Range</div>
                                        <div class="item-stat-value">${weapon.range}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Attack Bonus</div>
                                        <div class="item-stat-value">+${attackBonus}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Skill</div>
                                        <div class="item-stat-value">${skillName}</div>
                                    </div>
                                </div>
                                ${weapon.traits && weapon.traits.length > 0 ? 
                                    `<div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                                        <strong>Traits:</strong> ${weapon.traits.join(', ')}
                                    </div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollWeaponAttack(\`${weapon.name}\`, ${attackBonus}, \`${weapon.damage}\`)"
                                        title="Roll attack">üé≤</button>
                                <button onclick="app.removeWeapon(${index})" class="danger">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            equipArmor: function(armorId) {
                this.currentCharacter.equippedArmor = armorId || null;
                const armor = armorId ? this.rules.armor.find(a => a.id === armorId) : null;
                
                const details = document.getElementById('armorDetails');
                if (armor) {
                    document.getElementById('armorDeflect').textContent = armor.deflect;
                    document.getElementById('armorWeight').textContent = armor.weight;
                    document.getElementById('armorTraits').textContent = armor.traits.join(', ') || 'None';
                    details.style.display = 'block';
                } else {
                    details.style.display = 'none';
                }
                
                this.recalculateAll();
                this.updateCharacter();
            },

            renderArmorOptions: function() {
                const select = document.getElementById('equippedArmor');
                
                // Only show armor that's in the inventory
                const armorInInventory = this.rules.armor.filter(armor => {
                    if (!this.currentCharacter.inventory) return false;
                    // Check if this armor is in inventory (case-insensitive match)
                    return this.currentCharacter.inventory.some(item => 
                        item.name.toLowerCase() === armor.name.toLowerCase() ||
                        item.name.toLowerCase().includes(armor.name.toLowerCase())
                    );
                });
                
                if (armorInInventory.length === 0) {
                    select.innerHTML = '<option value="">None (add armor to inventory first)</option>';
                } else {
                    select.innerHTML = '<option value="">None</option>' + 
                        armorInInventory.map(armor => 
                            `<option value="${armor.id}" ${this.currentCharacter.equippedArmor === armor.id ? 'selected' : ''}>
                                ${armor.name} (Deflect ${armor.deflect})
                            </option>`
                        ).join('');
                }
            },

            renderStartingKitOptions: function() {
                const select = document.getElementById('startingKit');
                if (!this.rules.startingKits) return;
                
                select.innerHTML = '<option value="">-- Choose a Starting Kit --</option>' + 
                    this.rules.startingKits.map(kit => 
                        `<option value="${kit.id}" ${this.currentCharacter.startingKit === kit.id ? 'selected' : ''}>
                            ${kit.name}
                        </option>`
                    ).join('');
            },

            selectStartingKit: function(kitId) {
                if (!kitId) {
                    this.currentCharacter.startingKit = null;
                    document.getElementById('startingKitDetails').style.display = 'none';
                    this.updateCharacter();
                    return;
                }
                
                const kit = this.rules.startingKits.find(k => k.id === kitId);
                if (!kit) return;
                
                // Ask for confirmation before applying kit
                if (this.currentCharacter.startingKit && this.currentCharacter.startingKit !== kitId) {
                    if (!confirm('Changing your starting kit will not automatically remove previously added items. Continue?')) {
                        document.getElementById('startingKit').value = this.currentCharacter.startingKit || '';
                        return;
                    }
                }
                
                this.currentCharacter.startingKit = kitId;
                
                // Roll for currency
                if (kit.currency && kit.currency.dice !== "0") {
                    const dice = kit.currency.dice; // e.g. "3d12"
                    const [count, sides] = dice.split('d').map(Number);
                    let total = 0;
                    for (let i = 0; i < count; i++) {
                        total += Math.floor(Math.random() * sides) + 1;
                    }
                    this.currentCharacter.currency.marks = total;
                    document.getElementById('marks').value = total;
                }
                
                // Apply bonus expertises
                if (kit.bonuses && kit.bonuses.expertise) {
                    const exp = kit.bonuses.expertise.split(' (')[0]; // e.g. "Literature" from "Literature (or ...)"
                    if (!this.currentCharacter.expertises.includes(exp)) {
                        this.currentCharacter.expertises.push(exp);
                    }
                }
                
                // Add connection note if applicable
                if (kit.bonuses && kit.bonuses.connection) {
                    const connection = {
                        name: kit.name + ' Connection',
                        description: kit.bonuses.connection,
                        relationship: 'Patron/Bond'
                    };
                    if (!this.currentCharacter.connections) {
                        this.currentCharacter.connections = [];
                    }
                    // Check if not already added
                    const exists = this.currentCharacter.connections.some(c => c.name === connection.name);
                    if (!exists) {
                        this.currentCharacter.connections.push(connection);
                    }
                }
                
                // Add definitive equipment to inventory
                if (!this.currentCharacter.inventory) {
                    this.currentCharacter.inventory = [];
                }
                if (kit.equipment && kit.equipment.length > 0) {
                    for (const item of kit.equipment) {
                        // Skip if it's a placeholder or already in inventory
                        if (!this.currentCharacter.inventory.some(i => i.name === item)) {
                            this.currentCharacter.inventory.push({
                                name: item,
                                quantity: 1,
                                weight: 0, // Kit items don't specify weight
                                description: `From ${kit.name}`
                            });
                        }
                    }
                }
                
                // Add armor to inventory
                if (kit.armor && kit.armor !== 'none') {
                    const armorItems = kit.armor.split(' and ');
                    for (const armorName of armorItems) {
                        const armorId = armorName.trim().toLowerCase().replace(' ', '_');
                        if (!this.currentCharacter.inventory.some(i => i.name === armorName.trim())) {
                            const capitalizedName = armorName.trim().charAt(0).toUpperCase() + armorName.trim().slice(1);
                            // Get weight from armor definition if available
                            const armorDef = this.rules.armor.find(a => a.id === armorId);
                            const weight = armorDef ? armorDef.weight : 0;
                            this.currentCharacter.inventory.push({
                                name: capitalizedName,
                                quantity: 1,
                                weight: weight,
                                description: `Armor from ${kit.name}`
                            });
                        }
                    }
                }
                
                // Handle weapons - trigger weapon selection for choices
                if (kit.weapons && kit.weapons.length > 0) {
                    let weaponMessage = 'Your starting kit includes:\n\n';
                    for (const weaponText of kit.weapons) {
                        weaponMessage += `‚Ä¢ ${weaponText}\n`;
                    }
                    weaponMessage += '\nUse the "+ Add Weapon" button below to add your weapons.';
                    
                    // Count how many weapon choices need to be made
                    const choiceCount = kit.weapons.reduce((count, text) => {
                        if (text.toLowerCase().includes('two ')) return count + 2;
                        if (text.toLowerCase().includes('one ')) return count + 1;
                        return count + 1;
                    }, 0);
                    
                    alert(weaponMessage);
                }
                
                this.showStartingKitDetails(kitId);
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            showStartingKitDetails: function(kitId) {
                const kit = this.rules.startingKits.find(k => k.id === kitId);
                if (!kit) {
                    document.getElementById('startingKitDetails').style.display = 'none';
                    return;
                }
                
                const detailsDiv = document.getElementById('startingKitDetails');
                detailsDiv.style.display = 'block';
                
                let html = `<p style="margin: 0 0 10px 0; font-style: italic;">${kit.description}</p>`;
                
                if (kit.weapons && kit.weapons.length > 0) {
                    html += `<div><strong>Weapons:</strong> ${kit.weapons.join(', ')}</div>`;
                }
                
                if (kit.armor && kit.armor !== 'none') {
                    html += `<div><strong>Armor:</strong> ${kit.armor}</div>`;
                }
                
                if (kit.equipment && kit.equipment.length > 0) {
                    html += `<div><strong>Equipment:</strong> ${kit.equipment.join(', ')}</div>`;
                }
                
                if (kit.currency) {
                    html += `<div><strong>Currency:</strong> Roll ${kit.currency.dice} ${kit.currency.type}</div>`;
                }
                
                if (kit.bonuses) {
                    if (kit.bonuses.expertise) {
                        html += `<div><strong>Bonus:</strong> ${kit.bonuses.expertise}</div>`;
                    }
                    if (kit.bonuses.connection) {
                        html += `<div><strong>Connection:</strong> ${kit.bonuses.connection}</div>`;
                    }
                }
                
                detailsDiv.innerHTML = html;
            },

            calculateAttackBonuses: function() {
                // Melee attack = STR or SPD + Light/Heavy Weaponry skill
                const str = this.currentCharacter.attributes.strength;
                const spd = this.currentCharacter.attributes.speed;
                const lightWeap = this.currentCharacter.skills.light_weaponry;
                const heavyWeap = this.currentCharacter.skills.heavy_weaponry;
                if (str === undefined || spd === undefined || lightWeap === undefined || heavyWeap === undefined) {
                    throw new Error('Required attributes or skills undefined in calculateAttackBonuses');
                }
                
                const meleeBonus = Math.max(str + lightWeap, str + heavyWeap, spd + lightWeap);
                const rangedBonus = Math.max(spd + lightWeap, str + heavyWeap);
                
                document.getElementById('meleeAttack').textContent = `+${meleeBonus}`;
                document.getElementById('rangedAttack').textContent = `+${rangedBonus}`;
            },

            calculateInitiative: function() {
                const awa = this.currentCharacter.attributes.awareness;
                const spd = this.currentCharacter.attributes.speed;
                if (awa === undefined || spd === undefined) {
                    throw new Error('Awareness or Speed undefined in calculateInitiative');
                }
                const initiative = awa + spd;
                document.getElementById('initiative').textContent = `+${initiative}`;
            },

            addInventoryItem: function() {
                // Open item selection modal
                this.renderItemList();
                document.getElementById('itemModal').classList.add('active');
            },

            closeItemModal: function() {
                document.getElementById('itemModal').classList.remove('active');
            },

            renderItemList: function() {
                if (!this.rules.equipment) return;
                
                const container = document.getElementById('itemsList');
                const categories = {};
                
                // Group items by category
                this.rules.equipment.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });
                
                // Render by category
                let html = '';
                Object.keys(categories).sort().forEach(category => {
                    html += `<h4 style="margin-top: 15px; color: var(--secondary-color);">${category}</h4>`;
                    html += categories[category].map(item => `
                        <div class="weapon-option" onclick="app.selectItem('${item.name}', ${item.weight}, ${item.price})">
                            <div class="weapon-option-name">${item.name}</div>
                            <div class="weapon-option-stats">
                                Weight: ${item.weight} lbs | Price: ${item.price} mk
                            </div>
                        </div>
                    `).join('');
                });
                
                container.innerHTML = html;
            },

            filterItems: function(searchTerm) {
                const items = document.querySelectorAll('#itemsList .weapon-option');
                const term = searchTerm.toLowerCase();
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'block' : 'none';
                });
                
                // Show/hide category headers
                const headers = document.querySelectorAll('#itemsList h4');
                headers.forEach(header => {
                    const nextItems = [];
                    let sibling = header.nextElementSibling;
                    while (sibling && sibling.tagName !== 'H4') {
                        if (sibling.classList.contains('weapon-option') && sibling.style.display !== 'none') {
                            nextItems.push(sibling);
                        }
                        sibling = sibling.nextElementSibling;
                    }
                    header.style.display = nextItems.length > 0 ? 'block' : 'none';
                });
            },

            selectItem: function(name, weight, price) {
                const quantity = parseInt(prompt('Quantity:', '1')) || 1;
                
                if (!this.currentCharacter.inventory) this.currentCharacter.inventory = [];
                this.currentCharacter.inventory.push({
                    name: name,
                    quantity: quantity,
                    weight: weight,
                    description: `${price} mk each`
                });
                
                this.closeItemModal();
                this.renderInventory();
                this.renderArmorOptions();
                this.updateCharacter();
            },

            addCustomItem: function() {
                const name = prompt('Item name:');
                if (!name) return;
                const quantity = parseInt(prompt('Quantity:', '1')) || 1;
                const weight = parseFloat(prompt('Weight (lbs):', '0')) || 0;
                const description = prompt('Description (optional):', '') || '';
                
                if (!this.currentCharacter.inventory) this.currentCharacter.inventory = [];
                this.currentCharacter.inventory.push({name, quantity, weight, description});
                
                this.closeItemModal();
                this.renderInventory();
                this.renderArmorOptions();
                this.updateCharacter();
            },

            removeInventoryItem: function(index) {
                if (!confirm('Remove this item?')) return;
                this.currentCharacter.inventory.splice(index, 1);
                this.renderInventory();
                this.renderArmorOptions(); // Update armor dropdown
                this.updateCharacter();
            },

            toggleInventory: function() {
                const content = document.getElementById('inventoryContent');
                const icon = document.getElementById('inventoryToggleIcon');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.textContent = '‚ñº';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '‚ñ∂';
                    icon.style.transform = 'rotate(-90deg)';
                }
            },

            renderInventory: function() {
                const container = document.getElementById('inventoryList');
                if (!this.currentCharacter.inventory || this.currentCharacter.inventory.length === 0) {
                    container.innerHTML = '<div class="help-text">No items in inventory.</div>';
                    return;
                }

                let totalWeight = 0;
                container.innerHTML = this.currentCharacter.inventory.map((item, index) => {
                    const itemWeight = item.weight ?? 0; // Some items legitimately have no weight
                    const itemQuantity = item.quantity ?? 1; // Default quantity is 1
                    totalWeight += itemWeight * itemQuantity;
                    return `
                        <div class="item-card">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${item.name} ${itemQuantity > 1 ? `(√ó${itemQuantity})` : ''}</div>
                                ${item.description ? `<div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">${item.description}</div>` : ''}
                                ${itemWeight > 0 ? `<div style="font-size: 0.85em; margin-top: 4px;">Weight: ${itemWeight * itemQuantity} lbs</div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button onclick="app.removeInventoryItem(${index})" class="danger">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('') + `<div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: bold;">Total Weight: ${totalWeight.toFixed(1)} lbs</div>`;
            },

            updateCurrency: function() {
                const chips = parseFloat(document.getElementById('chips').value) || 0;
                const marks = parseFloat(document.getElementById('marks').value) || 0;
                const broams = parseFloat(document.getElementById('broams').value) || 0;
                
                this.currentCharacter.currency = {chips, marks, broams};
                
                const totalMarks = (chips * 0.05) + marks + (broams * 20);
                document.getElementById('totalMarks').textContent = totalMarks.toFixed(2);
                
                this.updateCharacter();
            },

            // ========== INJURIES & CONDITIONS FUNCTIONS ==========
            
            addInjury: function(type) {
                const description = prompt(`Enter ${type} injury description:`);
                if (!description) return;
                
                if (!this.currentCharacter.injuries) {
                    this.currentCharacter.injuries = {temporary: [], permanent: []};
                }
                
                this.currentCharacter.injuries[type].push({description, date: new Date().toLocaleDateString()});
                this.renderInjuries();
                this.updateCharacter();
            },

            removeInjury: function(type, index) {
                if (!confirm('Remove this injury?')) return;
                this.currentCharacter.injuries[type].splice(index, 1);
                this.renderInjuries();
                this.updateCharacter();
            },

            renderInjuries: function() {
                ['temporary', 'permanent'].forEach(type => {
                    const container = document.getElementById(`${type}Injuries`);
                    const injuries = this.currentCharacter.injuries?.[type] || [];
                    
                    if (injuries.length === 0) {
                        container.innerHTML = `<div class="help-text">No ${type} injuries</div>`;
                        return;
                    }
                    
                    container.innerHTML = injuries.map((injury, index) => `
                        <div class="injury-card">
                            <div>
                                <div style="font-weight: bold;">${injury.description}</div>
                                <div style="font-size: 0.85em; margin-top: 4px;">Date: ${injury.date}</div>
                            </div>
                            <button onclick="app.removeInjury('${type}', ${index})" class="danger">√ó</button>
                        </div>
                    `).join('');
                });
            },

            addCondition: function() {
                this.renderConditionSelectionModal();
                document.getElementById('conditionModal').classList.add('active');
            },

            renderConditionSelectionModal: function() {
                const container = document.getElementById('conditionSelectionList');
                const conditions = this.rules.conditions || [];
                
                container.innerHTML = conditions.map(condition => `
                    <div class="weapon-option" onclick="app.selectCondition('${condition.id}')">
                        <div class="weapon-option-name">${condition.name}</div>
                        <div class="weapon-option-stats">${condition.description}</div>
                    </div>
                `).join('');
            },

            selectCondition: function(conditionId) {
                const condition = this.rules.conditions.find(c => c.id === conditionId);
                if (!condition) return;
                
                if (!this.currentCharacter.conditions) {
                    this.currentCharacter.conditions = [];
                }
                
                // Check if already added
                if (this.currentCharacter.conditions.some(c => c.name === condition.name)) {
                    alert('This condition is already active');
                    return;
                }
                
                this.currentCharacter.conditions.push({
                    ...condition,
                    applied: new Date().toLocaleDateString()
                });
                
                this.closeConditionModal();
                this.renderConditions();
                this.updateCharacter();
            },

            closeConditionModal: function() {
                document.getElementById('conditionModal').classList.remove('active');
            },

            filterConditions: function(searchTerm) {
                const container = document.getElementById('conditionSelectionList');
                const conditions = this.rules.conditions || [];
                const term = searchTerm.toLowerCase();
                
                const filtered = conditions.filter(condition => 
                    condition.name.toLowerCase().includes(term) ||
                    condition.description.toLowerCase().includes(term)
                );
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="help-text">No conditions found matching your search</div>';
                    return;
                }
                
                container.innerHTML = filtered.map(condition => `
                    <div class="weapon-option" onclick="app.selectCondition('${condition.id}')">
                        <div class="weapon-option-name">${condition.name}</div>
                        <div class="weapon-option-stats">${condition.description}</div>
                    </div>
                `).join('');
            },

            removeCondition: function(index) {
                if (!confirm('Remove this condition?')) return;
                this.currentCharacter.conditions.splice(index, 1);
                this.renderConditions();
                this.updateCharacter();
            },

            renderConditions: function() {
                const container = document.getElementById('conditionsList');
                if (!this.currentCharacter.conditions || this.currentCharacter.conditions.length === 0) {
                    container.innerHTML = '<div class="help-text">No active conditions</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.conditions.map((condition, index) => `
                    <div class="condition-card">
                        <div>
                            <div style="font-weight: bold;">${condition.name}</div>
                            <div style="font-size: 0.9em; margin-top: 4px;">${condition.description}</div>
                            <div style="font-size: 0.85em; margin-top: 4px;">Applied: ${condition.applied}</div>
                        </div>
                        <button onclick="app.removeCondition(${index})" class="danger">√ó</button>
                    </div>
                `).join('');
            },

            // ========== CONNECTIONS FUNCTIONS ==========
            
            addConnection: function() {
                if (!this.currentCharacter.connections) this.currentCharacter.connections = [];
                this.currentCharacter.connections.push({
                    name: '',
                    relationship: 'Acquaintance',
                    description: ''
                });
                this.renderConnections();
                this.updateCharacter();
            },

            removeConnection: function(index) {
                if (!confirm('Remove this connection?')) return;
                this.currentCharacter.connections.splice(index, 1);
                this.renderConnections();
                this.updateCharacter();
            },

            updateConnectionField: function(index, field, value) {
                this.currentCharacter.connections[index][field] = value;
                this.updateCharacter();
            },

            renderGoals: function() {
                const container = document.getElementById('goalsList');
                if (!this.currentCharacter.goals) {
                    this.currentCharacter.goals = [];
                }
                
                if (this.currentCharacter.goals.length === 0) {
                    container.innerHTML = '<div class="help-text">No goals added yet. Click "+ Add Goal" to create one.</div>';
                    return;
                }
                
                container.innerHTML = this.currentCharacter.goals.map((goal, goalIndex) => `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" 
                                   value="${goal.text || ''}" 
                                   placeholder="Enter your goal..." 
                                   style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                                   oninput="app.updateGoalText(${goalIndex}, this.value)">
                            <button onclick="app.removeGoal(${goalIndex})" 
                                    style="padding: 8px 12px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <strong style="font-size: 0.9em;">Milestones:</strong>
                            ${[0, 1, 2].map(milestoneIndex => `
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" 
                                           ${goal.milestones && goal.milestones[milestoneIndex] ? 'checked' : ''}
                                           onchange="app.toggleMilestone(${goalIndex}, ${milestoneIndex})"
                                           style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 0.9em;">${milestoneIndex + 1}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            addGoal: function() {
                if (!this.currentCharacter.goals) {
                    this.currentCharacter.goals = [];
                }
                this.currentCharacter.goals.push({
                    text: '',
                    milestones: [false, false, false]
                });
                this.renderGoals();
                this.updateCharacter();
            },

            removeGoal: function(index) {
                if (!confirm('Remove this goal?')) return;
                this.currentCharacter.goals.splice(index, 1);
                this.renderGoals();
                this.updateCharacter();
            },

            updateGoalText: function(index, text) {
                this.currentCharacter.goals[index].text = text;
                this.updateCharacter();
            },

            toggleMilestone: function(goalIndex, milestoneIndex) {
                const goal = this.currentCharacter.goals[goalIndex];
                if (!goal.milestones) {
                    goal.milestones = [false, false, false];
                }
                goal.milestones[milestoneIndex] = !goal.milestones[milestoneIndex];
                this.updateCharacter();
            },

            renderConnections: function() {
                const container = document.getElementById('connectionsList');
                if (!this.currentCharacter.connections) {
                    this.currentCharacter.connections = [];
                }
                
                if (this.currentCharacter.connections.length === 0) {
                    container.innerHTML = '<div class="help-text">No connections tracked yet. Click "+ Add Connection" to create one.</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.connections.map((conn, index) => `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" 
                                   value="${conn.name || ''}" 
                                   placeholder="Connection name..." 
                                   style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-weight: bold;"
                                   oninput="app.updateConnectionField(${index}, 'name', this.value)">
                            <button onclick="app.removeConnection(${index})" 
                                    style="padding: 8px 12px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-size: 0.9em; margin-bottom: 4px; font-weight: bold;">Relationship:</label>
                            <select style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                                    onchange="app.updateConnectionField(${index}, 'relationship', this.value)">
                                <option value="Acquaintance" ${conn.relationship === 'Acquaintance' ? 'selected' : ''}>Acquaintance</option>
                                <option value="Ally" ${conn.relationship === 'Ally' ? 'selected' : ''}>Ally</option>
                                <option value="Enemy" ${conn.relationship === 'Enemy' ? 'selected' : ''}>Enemy</option>
                                <option value="Family" ${conn.relationship === 'Family' ? 'selected' : ''}>Family</option>
                                <option value="Friend" ${conn.relationship === 'Friend' ? 'selected' : ''}>Friend</option>
                                <option value="Mentor" ${conn.relationship === 'Mentor' ? 'selected' : ''}>Mentor</option>
                                <option value="Patron" ${conn.relationship === 'Patron' ? 'selected' : ''}>Patron</option>
                                <option value="Rival" ${conn.relationship === 'Rival' ? 'selected' : ''}>Rival</option>
                                <option value="Spren Bond" ${conn.relationship === 'Spren Bond' ? 'selected' : ''}>Spren Bond</option>
                                <option value="Other" ${conn.relationship === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.9em; margin-bottom: 4px; font-weight: bold;">Description:</label>
                            <textarea style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; min-height: 60px; font-family: inherit;"
                                      placeholder="Describe this connection..."
                                      oninput="app.updateConnectionField(${index}, 'description', this.value)">${conn.description || ''}</textarea>
                        </div>
                    </div>
                `).join('');
            },

            // Toggle Combat & Play section
            toggleCombatPlay: function() {
                const header = document.querySelector('.combat-play-header');
                const content = document.getElementById('combatPlayContent');
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            },

            // Toggle collapsible sections within Combat & Play
            toggleSection: function(sectionId) {
                const content = document.getElementById(sectionId + 'Content');
                const indicator = document.getElementById(sectionId + 'Indicator');
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    indicator.textContent = '‚ñº';
                } else {
                    content.classList.add('collapsed');
                    indicator.textContent = '‚ñ∂';
                }
            },

            // Update Combat & Play display values
            updateCombatPlayDisplay: function() {
                if (!this.currentCharacter) return;
                
                const char = this.currentCharacter;
                
                // Update attributes
                document.getElementById('playStrength').textContent = char.attributes.strength;
                document.getElementById('playSpeed').textContent = char.attributes.speed;
                document.getElementById('playIntellect').textContent = char.attributes.intellect;
                document.getElementById('playWillpower').textContent = char.attributes.willpower;
                document.getElementById('playAwareness').textContent = char.attributes.awareness;
                document.getElementById('playPresence').textContent = char.attributes.presence;
                
                // Update defenses
                document.getElementById('playPhysicalDefense').textContent = char.physicalDefense;
                document.getElementById('playCognitiveDefense').textContent = char.cognitiveDefense;
                document.getElementById('playSpiritualDefense').textContent = char.spiritualDefense;
                
                // Update combat stats
                const initiativeElem = document.getElementById('initiative');
                const meleeElem = document.getElementById('meleeAttack');
                const rangedElem = document.getElementById('rangedAttack');
                
                document.getElementById('playInitiative').textContent = initiativeElem ? initiativeElem.textContent : '+0';
                document.getElementById('playMeleeAttack').textContent = meleeElem ? meleeElem.textContent : '+0';
                document.getElementById('playRangedAttack').textContent = rangedElem ? rangedElem.textContent : '+0';
                
                // Update resources
                document.getElementById('playMaxHealth').textContent = char.maxHealth;
                document.getElementById('playMaxFocus').textContent = char.maxFocus;
                document.getElementById('playMaxInvestiture').textContent = char.maxInvestiture;
                document.getElementById('playDeflect').textContent = char.deflect;
                document.getElementById('playRecoveryDie').textContent = char.recoveryDie;
                document.getElementById('playMovement').textContent = char.movement;
                
                // Sync current values
                document.getElementById('playCurrentHealth').value = char.currentHealth;
                document.getElementById('playCurrentFocus').value = char.currentFocus;
                document.getElementById('playCurrentInvestiture').value = char.currentInvestiture;
                
                // Update skills list
                this.renderPlaySkills();
                
                // Update weapons list
                this.renderPlayWeapons();
            },

            // Render skills for Combat & Play section
            renderPlaySkills: function() {
                const container = document.getElementById('playSkillsList');
                if (!container || !this.currentCharacter) return;
                
                const allSkills = this.rules.skills.list || [];
                const physicalSkills = allSkills.filter(s => s.category === 'physical');
                const cognitiveSkills = allSkills.filter(s => s.category === 'cognitive');
                const spiritualSkills = allSkills.filter(s => s.category === 'spiritual');
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        ${this.renderPlaySkillCategory('Physical', physicalSkills)}
                        ${this.renderPlaySkillCategory('Cognitive', cognitiveSkills)}
                        ${this.renderPlaySkillCategory('Spiritual', spiritualSkills)}
                    </div>
                `;
            },

            renderPlaySkillCategory: function(category, skills) {
                return `
                    <div class="play-card">
                        <div class="play-card-header">${category}</div>
                        ${skills.map(skill => {
                            const rank = this.currentCharacter.skills[skill.id];
                            const attr = this.currentCharacter.attributes[skill.attribute];
                            if (rank === undefined) throw new Error(`Skill ${skill.id} is undefined`);
                            if (attr === undefined) throw new Error(`Attribute ${skill.attribute} is undefined`);
                            const modifier = attr + rank;
                            return `
                                <div class="play-stat-row">
                                    <span class="play-stat-label">${skill.name}</span>
                                    <span class="play-stat-value">
                                        <span>+${modifier}</span>
                                        <button class="play-dice-btn" 
                                                onclick="diceRoller.rollInline('1d20+${modifier}', '${skill.name} Test')"
                                                title="Roll ${skill.name} test">üé≤</button>
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            // Render weapons for Combat & Play section
            renderPlayWeapons: function() {
                const container = document.getElementById('playWeaponsList');
                if (!container || !this.currentCharacter) return;
                
                if (!this.currentCharacter.weapons || this.currentCharacter.weapons.length === 0) {
                    container.innerHTML = '<div class="help-text">No weapons equipped.</div>';
                    return;
                }
                
                container.innerHTML = this.currentCharacter.weapons.map(weapon => {
                    const skillData = this.rules.skills.list.find(s => s.id === weapon.skill);
                    if (!skillData) throw new Error(`Weapon skill ${weapon.skill} not found in rules`);
                    const skillRank = this.currentCharacter.skills[weapon.skill];
                    if (skillRank === undefined) throw new Error(`Skill rank for ${weapon.skill} is undefined`);
                    const attr = skillData.attribute;
                    const attrValue = this.currentCharacter.attributes[attr];
                    if (attrValue === undefined) throw new Error(`Attribute ${attr} is undefined`);
                    const attackBonus = attrValue + skillRank;
                    
                    return `
                        <div class="play-stat-row" style="flex-wrap: wrap;">
                            <span class="play-stat-label" style="flex: 1; min-width: 150px;">
                                <strong>${weapon.name}</strong><br>
                                <span style="font-size: 0.85em; color: #999;">${weapon.damage} ${weapon.damageType} | ${weapon.range}</span>
                            </span>
                            <span class="play-stat-value">
                                <span>+${attackBonus}</span>
                                <button class="play-dice-btn" 
                                        onclick="diceRoller.rollWeaponAttack(\`${weapon.name}\`, ${attackBonus}, \`${weapon.damage}\`)"
                                        title="Roll attack">üé≤</button>
                            </span>
                        </div>
                    `;
                }).join('');
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>

