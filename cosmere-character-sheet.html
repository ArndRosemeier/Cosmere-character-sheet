<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmere RPG Character Sheet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #7d3c3c;
            --accent-color: #d4af37;
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --border-color: #ddd;
            --text-primary: #333;
            --text-secondary: #666;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --physical-color: #c44444;
            --cognitive-color: #4472c4;
            --spiritual-color: #70ad47;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            background-color: var(--accent-color);
            color: var(--text-primary);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.primary {
            background-color: var(--success-color);
            color: white;
        }

        button.danger {
            background-color: var(--danger-color);
            color: white;
        }

        .character-list {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .character-list h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .character-list-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .character-card {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .character-card.active {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.1);
        }

        .character-card h3 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .character-card p {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .sheet-container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sheet-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-column {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .stat-column.physical {
            border-color: var(--physical-color);
            background-color: rgba(196, 68, 68, 0.05);
        }

        .stat-column.cognitive {
            border-color: var(--cognitive-color);
            background-color: rgba(68, 114, 196, 0.05);
        }

        .stat-column.spiritual {
            border-color: var(--spiritual-color);
            background-color: rgba(112, 173, 71, 0.05);
        }

        .stat-column h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.3em;
            padding-bottom: 10px;
            border-bottom: 2px solid currentColor;
        }

        .stat-column.physical h3 {
            color: var(--physical-color);
        }

        .stat-column.cognitive h3 {
            color: var(--cognitive-color);
        }

        .stat-column.spiritual h3 {
            color: var(--spiritual-color);
        }

        .attribute-box,
        .defense-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .attribute-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .attribute-label {
            font-weight: 600;
            font-size: 1.1em;
        }

        .attribute-value {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            background-color: var(--bg-primary);
            padding: 10px;
            border-radius: 4px;
        }

        .defense-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-primary);
            border-radius: 4px;
        }

        .defense-label {
            font-weight: 600;
        }

        .defense-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .skills-section {
            margin-bottom: 20px;
        }

        .skill-row {
            display: grid;
            grid-template-columns: 2fr 80px 80px;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .skill-row:hover {
            background-color: var(--bg-primary);
        }

        .skill-name {
            font-weight: 500;
        }

        .skill-attr {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .skill-rank {
            width: 70px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .skill-modifier {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            padding: 6px;
            background-color: var(--bg-primary);
            border-radius: 4px;
        }

        .resources-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .resource-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .resource-label {
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text-secondary);
        }

        .resource-values {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .resource-current,
        .resource-max {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .resource-current {
            width: 80px;
        }

        .resource-max {
            width: 80px;
            background-color: var(--bg-primary);
        }

        .paths-section {
            margin-bottom: 30px;
        }

        .path-selector {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .path-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .path-card {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .path-card:hover {
            border-color: var(--primary-color);
        }

        .path-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.1);
        }

        .path-card h4 {
            margin-bottom: 5px;
        }

        .path-card p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .notes-section {
            margin-top: 30px;
        }

        .notes-area {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }

        .level-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .level-display {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        @media print {
            header, .header-controls, .character-list, button {
                display: none;
            }
            
            .sheet-container {
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .sheet-header {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                flex-direction: column;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .auto-calc {
            color: var(--success-color);
            font-style: italic;
        }

        .validation-warning {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-warning.error {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .validation-warning.success {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .validation-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .validation-message {
            flex-grow: 1;
        }

        .point-tracker {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .point-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .point-tracker-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .point-tracker-values {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .points-used {
            color: var(--primary-color);
        }

        .points-total {
            color: var(--text-secondary);
        }

        .points-remaining {
            padding: 5px 15px;
            border-radius: 20px;
            background-color: var(--bg-primary);
        }

        .points-remaining.over {
            background-color: #f8d7da;
            color: #dc3545;
        }

        .points-remaining.complete {
            background-color: #d4edda;
            color: #28a745;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.3s ease;
        }

        .progress-fill.over {
            background: linear-gradient(90deg, #dc3545, #ff6b6b);
        }

        .progress-fill.complete {
            background: linear-gradient(90deg, #28a745, #4caf50);
        }

        .validation-summary {
            margin-bottom: 20px;
        }

        .character-complete-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .character-complete-badge.incomplete {
            background-color: #fff3cd;
            color: #856404;
        }

        .character-complete-badge.complete {
            background-color: #d4edda;
            color: #155724;
        }

        .help-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 5px;
        }

        .expertises-section {
            margin-bottom: 20px;
        }

        .expertise-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .expertise-tag {
            padding: 8px 15px;
            background-color: var(--accent-color);
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expertise-remove {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            font-size: 1.2em;
            width: 20px;
            height: 20px;
        }

        .add-expertise {
            padding: 8px 15px;
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
        }

        .add-expertise:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Dice Roller Styles */
        .dice-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
            z-index: 999;
        }

        .dice-toggle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            border: 2px solid #ddd;
            font-size: 1.3em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            opacity: 0.7;
        }

        .dice-toggle:hover {
            transform: scale(1.05);
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .dice-toggle.active {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border-color: var(--accent-color);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transform: scale(1.1);
        }

        .dice-fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .dice-fab:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .dice-roller-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .dice-roller-modal.active {
            display: flex;
        }

        .talent-card, .talent-card-inline {
            transition: all 0.2s ease;
        }

        .talent-card:hover:not([style*="cursor: not-allowed"]),
        .talent-card-inline:hover:not([style*="cursor: not-allowed"]) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
            border-color: var(--primary-color) !important;
        }

        /* Equipment & Combat Styles */
        .equipment-section, .injuries-section, .connections-section, .character-details-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item-card {
            padding: 12px;
            background: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 15px;
        }

        .item-details {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .item-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .item-stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .item-stat-value {
            font-weight: bold;
            color: var(--text-primary);
        }

        .item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .currency-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .currency-input label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .currency-input input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100px;
        }

        .injuries-list, .conditions-list, .connections-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .injury-card, .condition-card, .connection-card {
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .condition-card {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .connection-card {
            background: #d1ecf1;
            border-color: #0c5460;
        }

        .armor-selector select {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
        }

        .weapon-selection-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .weapon-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .weapon-option:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .weapon-option-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .weapon-option-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .dice-roller-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .dice-roller-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .dice-roller-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .dice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .dice-button {
            padding: 15px;
            border: 2px solid var(--primary-color);
            background: white;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dice-button:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .dice-button:active {
            transform: translateY(0);
        }

        .modifier-section {
            margin-bottom: 20px;
        }

        .modifier-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modifier-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }

        .skill-quick-roll {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .skill-roll-btn {
            padding: 10px;
            border: 2px solid var(--accent-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .skill-roll-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .skill-roll-name {
            font-weight: bold;
            font-size: 0.9em;
        }

        .skill-roll-modifier {
            font-size: 1.1em;
            color: var(--success-color);
        }

        .roll-result {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .roll-result-total {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .roll-result-breakdown {
            font-size: 1em;
            opacity: 0.9;
        }

        .roll-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
        }

        .roll-history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .roll-history-item:last-child {
            border-bottom: none;
        }

        .roll-history-item strong {
            color: var(--primary-color);
        }

        .plot-die-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-color);
        }

        .plot-die-result {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .plot-die-icon {
            font-size: 2em;
        }

        /* Inline Dice Roller Icons */
        .inline-dice-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 8px;
            transition: all 0.2s;
            opacity: 0.7;
            vertical-align: middle;
        }

        .inline-dice-btn:hover {
            opacity: 1;
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .inline-dice-btn:active {
            transform: scale(0.95);
        }

        .inline-dice-btn.large {
            width: 32px;
            height: 32px;
            font-size: 1.1em;
        }

        .defense-row .inline-dice-btn,
        .resource-box .inline-dice-btn {
            margin-left: 10px;
        }

        .skill-row .inline-dice-btn {
            margin-left: 5px;
        }

        .attribute-box .inline-dice-btn {
            margin-left: 10px;
        }

        /* Toast notification for quick rolls */
        .roll-toast {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
        }

        .roll-toast.show {
            display: flex;
        }

        .roll-toast-content {
            position: relative;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 500px;
            animation: slideDown 0.3s ease;
        }

        .roll-toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
            transition: background 0.2s;
        }

        .roll-toast-close:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .roll-toast-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            padding-right: 30px;
        }

        .roll-toast-result {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .roll-toast-breakdown {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }

        .roll-toast.hiding .roll-toast-content {
            animation: slideOut 0.3s ease;
        }

        .roll-toast.hiding {
            animation: slideOut 0.3s ease;
        }

        @media (max-width: 768px) {
            .dice-controls {
                bottom: 20px;
                right: 20px;
                gap: 8px;
            }

            .dice-toggle {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }

            .dice-fab {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .dice-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .roll-toast {
                padding: 10px;
            }

            .roll-toast-content {
                min-width: 0;
                width: 100%;
                max-width: calc(100vw - 20px);
            }

            .inline-dice-btn {
                width: 20px;
                height: 20px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cosmere RPG Character Sheet</h1>
            <p>Stormlight Archive - Plotweaver System v1.01</p>
            <div class="header-controls">
                <button onclick="app.createNewCharacter()">‚ú® New Character</button>
                <button onclick="app.saveToLocalStorage()">üíæ Save</button>
                <button onclick="app.exportToFile()">üì• Export</button>
                <button onclick="app.importFromFile()">üì§ Import</button>
                <button onclick="app.reloadRules()">üîÑ Reload Rules</button>
                <button class="danger" onclick="app.deleteCurrentCharacter()">üóëÔ∏è Delete Character</button>
            </div>
        </header>

        <div id="characterListSection" class="character-list">
            <h2>Your Characters</h2>
            <div id="characterListItems" class="character-list-items"></div>
        </div>

        <div id="characterSheetSection" class="sheet-container hidden">
            <div class="level-section">
                <div class="level-display">
                    Total Level <span id="characterLevel">0</span>
                    <span id="characterCompleteBadge" class="character-complete-badge incomplete">Incomplete</span>
                </div>
                <div>Tier: <span id="characterTier">Local Heroes</span></div>
                <div id="pathLevelsDisplay" style="margin: 10px 0; font-size: 0.9em;"></div>
                <div id="talentPointsDisplay" style="margin: 10px 0; font-size: 0.9em;">Talent Points: <span id="talentPoints">0 available</span></div>
            </div>

            <div id="validationSummary" class="validation-summary"></div>

            <div class="point-tracker">
                <div class="point-tracker-header">
                    <div class="point-tracker-title">Attribute Points</div>
                    <div class="point-tracker-values">
                        <span class="points-used" id="attributePointsUsed">0</span>
                        <span>/</span>
                        <span class="points-total" id="attributePointsTotal">10</span>
                        <span class="points-remaining" id="attributePointsRemaining">10 remaining</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="attributeProgressBar" style="width: 0%"></div>
                </div>
                <div class="help-text">Starting characters have 12 attribute points to distribute (minimum 0, maximum 5 per attribute)</div>
            </div>

            <div class="point-tracker">
                <div class="point-tracker-header">
                    <div class="point-tracker-title">Skill Ranks</div>
                    <div class="point-tracker-values">
                        <span class="points-used" id="skillRanksUsed">0</span>
                        <span>/</span>
                        <span class="points-total" id="skillRanksTotal">0</span>
                        <span class="points-remaining" id="skillRanksRemaining">0 remaining</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="skillProgressBar" style="width: 0%"></div>
                </div>
                <div class="help-text">Skill ranks are gained through leveling and your chosen path</div>
            </div>

            <div class="sheet-header">
                <div class="input-group">
                    <label>Character Name</label>
                    <input type="text" id="characterName" placeholder="Enter name..." oninput="app.updateCharacter(); app.recalculateAll();">
                </div>
                <div class="input-group">
                    <label>Player Name</label>
                    <input type="text" id="playerName" placeholder="Your name..." onchange="app.updateCharacter()">
                </div>
                <div class="input-group">
                    <label>Ancestry</label>
                    <select id="ancestry" onchange="app.updateCharacter()"></select>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Culture</label>
                <select id="culture" onchange="app.updateCharacter()"></select>
            </div>

            <div class="stats-grid">
                <div class="stat-column physical">
                    <h3>Physical</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Strength</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="strength" min="0" max="5" value="2" oninput="app.updateAttributeValue('strength', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('strength', document.getElementById('strength').value)"
                                        title="Roll Strength test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Speed</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="speed" min="0" max="5" value="2" oninput="app.updateAttributeValue('speed', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('speed', document.getElementById('speed').value)"
                                        title="Roll Speed test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Physical Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="physicalDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Physical Defense', document.getElementById('physicalDefense').textContent)"
                                        title="Roll against Physical Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Physical Skills</h4>
                        <div id="physicalSkills"></div>
                    </div>
                </div>

                <div class="stat-column cognitive">
                    <h3>Cognitive</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Intellect</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="intellect" min="0" max="5" value="2" oninput="app.updateAttributeValue('intellect', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('intellect', document.getElementById('intellect').value)"
                                        title="Roll Intellect test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Willpower</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="willpower" min="0" max="5" value="2" oninput="app.updateAttributeValue('willpower', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('willpower', document.getElementById('willpower').value)"
                                        title="Roll Willpower test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Cognitive Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="cognitiveDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Cognitive Defense', document.getElementById('cognitiveDefense').textContent)"
                                        title="Roll against Cognitive Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Cognitive Skills</h4>
                        <div id="cognitiveSkills"></div>
                    </div>
                </div>

                <div class="stat-column spiritual">
                    <h3>Spiritual</h3>
                    
                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Awareness</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="awareness" min="0" max="5" value="2" oninput="app.updateAttributeValue('awareness', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('awareness', document.getElementById('awareness').value)"
                                        title="Roll Awareness test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="attribute-box">
                        <div class="attribute-row">
                            <div class="attribute-label">Presence</div>
                            <div style="display: flex; align-items: center;">
                                <input type="number" class="attribute-value" id="presence" min="0" max="5" value="2" oninput="app.updateAttributeValue('presence', this.value)">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollAttribute('presence', document.getElementById('presence').value)"
                                        title="Roll Presence test">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="defense-box">
                        <div class="defense-row">
                            <div class="defense-label">Spiritual Defense</div>
                            <div style="display: flex; align-items: center;">
                                <div class="defense-value auto-calc" id="spiritualDefense">14</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollDefense('Spiritual Defense', document.getElementById('spiritualDefense').textContent)"
                                        title="Roll against Spiritual Defense">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h4 style="margin-bottom: 10px;">Spiritual Skills</h4>
                        <div id="spiritualSkills"></div>
                    </div>
                </div>
            </div>

            <div class="resources-section">
                <div class="resource-box">
                    <div class="resource-label">Health</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentHealth" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxHealth">16</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Focus</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentFocus" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxFocus">8</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Investiture</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="currentInvestiture" min="0" onchange="app.updateCharacter()">
                        <span>/</span>
                        <div class="resource-max auto-calc" id="maxInvestiture">4</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Deflect</div>
                    <div class="resource-values">
                        <input type="number" class="resource-current" id="deflect" min="0" onchange="app.updateCharacter()">
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Recovery Die</div>
                    <div class="resource-values" style="flex-direction: column; gap: 10px;">
                        <div class="resource-max auto-calc" id="recoveryDie">1d6</div>
                        <button class="inline-dice-btn large" 
                                onclick="diceRoller.rollRecovery(document.getElementById('recoveryDie').textContent)"
                                title="Roll Recovery Die"
                                style="margin: 0 auto;">üé≤ Roll</button>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Movement</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="movement">40 ft</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Senses Range</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="sensesRange">80 ft</div>
                    </div>
                </div>

                <div class="resource-box">
                    <div class="resource-label">Lifting Capacity</div>
                    <div class="resource-values">
                        <div class="resource-max auto-calc" id="liftingCapacity">200 lbs</div>
                    </div>
                </div>
            </div>

            <!-- Equipment & Combat Section -->
            <div class="equipment-section">
                <h2>‚öîÔ∏è Equipment & Combat</h2>
                
                <!-- Attack Bonuses -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="resource-box">
                        <div class="resource-label">Melee Attack</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="meleeAttack">+4</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollAttack('Melee', document.getElementById('meleeAttack').textContent)"
                                    title="Roll melee attack">üé≤</button>
                        </div>
                    </div>
                    <div class="resource-box">
                        <div class="resource-label">Ranged Attack</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="rangedAttack">+4</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollAttack('Ranged', document.getElementById('rangedAttack').textContent)"
                                    title="Roll ranged attack">üé≤</button>
                        </div>
                    </div>
                    <div class="resource-box">
                        <div class="resource-label">Initiative</div>
                        <div class="resource-values">
                            <div class="resource-max auto-calc" id="initiative">+2</div>
                            <button class="inline-dice-btn" 
                                    onclick="diceRoller.rollInitiative(document.getElementById('initiative').textContent)"
                                    title="Roll initiative">üé≤</button>
                        </div>
                    </div>
                </div>

                <!-- Weapons -->
                <h3>üó°Ô∏è Weapons</h3>
                <div id="weaponsList" class="items-list"></div>
                <button onclick="app.addWeapon()" style="margin-top: 10px;">+ Add Weapon</button>

                <!-- Armor -->
                <h3 style="margin-top: 25px;">üõ°Ô∏è Armor</h3>
                <div class="armor-selector">
                    <label>Equipped Armor:</label>
                    <select id="equippedArmor" onchange="app.equipArmor(this.value)">
                        <option value="">None</option>
                    </select>
                    <div id="armorDetails" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;">
                        <div><strong>Deflect:</strong> <span id="armorDeflect">0</span></div>
                        <div><strong>Weight:</strong> <span id="armorWeight">0</span> lbs</div>
                        <div><strong>Traits:</strong> <span id="armorTraits">-</span></div>
                    </div>
                </div>

                <!-- Currency -->
                <h3 style="margin-top: 25px;">üíé Spheres (Currency)</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="currency-input">
                        <label>Chips (0.05 mk)</label>
                        <input type="number" id="chips" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div class="currency-input">
                        <label>Marks (1 mk)</label>
                        <input type="number" id="marks" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div class="currency-input">
                        <label>Broams (20 mk)</label>
                        <input type="number" id="broams" min="0" value="0" onchange="app.updateCurrency()">
                    </div>
                    <div style="margin-left: auto; padding: 15px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 8px; color: #333; font-weight: bold;">
                        <div style="font-size: 0.85em;">Total Worth</div>
                        <div style="font-size: 1.3em;"><span id="totalMarks">0</span> marks</div>
                    </div>
                </div>

                <!-- Inventory -->
                <h3 style="margin-top: 25px;">üéí Inventory</h3>
                <div id="inventoryList" class="items-list"></div>
                <button onclick="app.addInventoryItem()" style="margin-top: 10px;">+ Add Item</button>
            </div>

            <!-- Injuries & Conditions Section -->
            <div class="injuries-section" style="margin-top: 30px;">
                <h2>ü©π Injuries & Conditions</h2>
                
                <h3>Injuries</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h4 style="margin: 10px 0;">Temporary Injuries</h4>
                        <div id="temporaryInjuries" class="injuries-list"></div>
                        <button onclick="app.addInjury('temporary')" style="margin-top: 10px;">+ Add Temporary Injury</button>
                    </div>
                    <div>
                        <h4 style="margin: 10px 0;">Permanent Injuries</h4>
                        <div id="permanentInjuries" class="injuries-list"></div>
                        <button onclick="app.addInjury('permanent')" style="margin-top: 10px;">+ Add Permanent Injury</button>
                    </div>
                </div>

                <h3 style="margin-top: 25px;">Conditions</h3>
                <div id="conditionsList" class="conditions-list"></div>
                <button onclick="app.addCondition()" style="margin-top: 10px;">+ Add Condition</button>
            </div>

            <!-- Connections Section -->
            <div class="connections-section" style="margin-top: 30px;">
                <h2>ü§ù Connections & Relationships</h2>
                <div class="help-text">Track important NPCs, allies, enemies, and other relationships</div>
                <div id="connectionsList" class="connections-list"></div>
                <button onclick="app.addConnection()" style="margin-top: 10px;">+ Add Connection</button>
            </div>

            <!-- Character Details Section -->
            <div class="character-details-section" style="margin-top: 30px;">
                <h2>üë§ Character Details</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="input-group">
                        <label>Age</label>
                        <input type="text" id="characterAge" placeholder="25" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Gender/Pronouns</label>
                        <input type="text" id="characterGender" placeholder="She/Her" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Height</label>
                        <input type="text" id="characterHeight" placeholder="5'8\"" onchange="app.updateCharacter()">
                    </div>
                    <div class="input-group">
                        <label>Weight</label>
                        <input type="text" id="characterWeight" placeholder="140 lbs" onchange="app.updateCharacter()">
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Physical Appearance</label>
                    <textarea id="characterAppearance" placeholder="Describe your character's appearance, distinguishing features, typical clothing, etc." 
                              onchange="app.updateCharacter()" style="min-height: 80px;"></textarea>
                </div>

                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Backstory</label>
                    <textarea id="characterBackstory" placeholder="Your character's history, important life events, motivations, fears, etc." 
                              onchange="app.updateCharacter()" style="min-height: 100px;"></textarea>
                </div>
            </div>

            <div class="paths-section">
                <h2>Paths & Talents</h2>
                <div class="help-text" style="margin-bottom: 15px;">Select your character's heroic paths and radiant order. Each path grants unique talents.</div>
                
                <div id="pathsAndTalentsContainer"></div>

                <div class="path-selector" style="margin-top: 20px;">
                    <label>Add Path:</label>
                    <select id="addPathDropdown" onchange="app.addPath(this.value); this.value='';">
                        <option value="">-- Select a path to add --</option>
                        <optgroup label="Heroic Paths" id="heroicPathOptions"></optgroup>
                        <optgroup label="Radiant Orders" id="radiantOrderOptions"></optgroup>
                    </select>
                </div>
            </div>

            <div class="expertises-section">
                <h2>Expertises</h2>
                <div class="expertise-list" id="expertiseList">
                    <button class="add-expertise" onclick="app.addExpertise()">+ Add Expertise</button>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Purpose</label>
                <input type="text" id="purpose" placeholder="Your character's driving purpose..." oninput="app.updateCharacter(); app.validateCharacter();">
                <div class="help-text">What drives your character? What is their ultimate goal?</div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Obstacle</label>
                <input type="text" id="obstacle" placeholder="Your character's main obstacle..." oninput="app.updateCharacter(); app.validateCharacter();">
                <div class="help-text">What stands in their way? What weakness or challenge must they overcome?</div>
            </div>

            <div class="notes-section">
                <h2>Goals & Notes</h2>
                <textarea class="notes-area" id="notes" placeholder="Track your goals, equipment, connections, and other notes..." onchange="app.updateCharacter()"></textarea>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="app.handleFileImport(event)">

    <!-- Dice Roller Controls -->
    <div class="dice-controls">
        <button id="plotDieToggle" class="dice-toggle" onclick="diceRoller.togglePlotDie()" title="Plot Die">
            üìñ
        </button>
        <button id="advantageToggle" class="dice-toggle" onclick="diceRoller.toggleAdvantage()" title="Advantage">
            ‚¨ÜÔ∏è
        </button>
        <button id="disadvantageToggle" class="dice-toggle" onclick="diceRoller.toggleDisadvantage()" title="Disadvantage">
            ‚¨áÔ∏è
        </button>
        <button class="dice-fab" onclick="diceRoller.open()" title="Dice Roller (D key)">üé≤</button>
    </div>

    <!-- Roll Toast Notification -->
    <div id="rollToast" class="roll-toast" onclick="if(event.target === this) diceRoller.hideToast()">
        <div class="roll-toast-content" onclick="event.stopPropagation()">
            <button class="roll-toast-close" onclick="diceRoller.hideToast()" title="Close (or click outside)">√ó</button>
            <div class="roll-toast-title" id="toastTitle">Roll Result</div>
            <div class="roll-toast-result" id="toastResult">15</div>
            <div class="roll-toast-breakdown" id="toastBreakdown">1d20+5</div>
        </div>
    </div>

    <!-- Weapon Selection Modal -->
    <div id="weaponModal" class="dice-roller-modal" onclick="if(event.target === this) app.closeWeaponModal()">
        <div class="dice-roller-content" style="max-width: 800px;">
            <div class="dice-roller-header">
                <h2>‚öîÔ∏è Select Weapon</h2>
                <button class="modal-close" onclick="app.closeWeaponModal()">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="weaponSearch" placeholder="Search weapons..." 
                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1em;"
                       oninput="app.filterWeapons(this.value)">
            </div>

            <div style="max-height: 60vh; overflow-y: auto;">
                <h3 style="color: var(--primary-color);">Light Weapons</h3>
                <div id="lightWeaponsList" class="weapon-selection-list"></div>
                
                <h3 style="color: var(--secondary-color); margin-top: 20px;">Heavy Weapons</h3>
                <div id="heavyWeaponsList" class="weapon-selection-list"></div>
            </div>
        </div>
    </div>

    <!-- Dice Roller Modal -->
    <div id="diceRollerModal" class="dice-roller-modal" onclick="if(event.target === this) diceRoller.close()">
        <div class="dice-roller-content">
            <div class="dice-roller-header">
                <h2>üé≤ Dice Roller</h2>
                <button class="modal-close" onclick="diceRoller.close()">√ó</button>
            </div>

            <div id="rollResult" style="display: none;"></div>

            <h3>Quick Roll</h3>
            <div class="dice-grid">
                <button class="dice-button" onclick="diceRoller.roll('1d4')">d4</button>
                <button class="dice-button" onclick="diceRoller.roll('1d6')">d6</button>
                <button class="dice-button" onclick="diceRoller.roll('1d8')">d8</button>
                <button class="dice-button" onclick="diceRoller.roll('1d10')">d10</button>
                <button class="dice-button" onclick="diceRoller.roll('1d12')">d12</button>
                <button class="dice-button" onclick="diceRoller.roll('1d20')">d20</button>
            </div>

            <div class="plot-die-section">
                <h3 style="margin-top: 0;">Plot Die (Cosmere Mechanic)</h3>
                <p style="margin: 5px 0; font-size: 0.9em;">Roll with advantage/disadvantage based on plot die result</p>
                <button class="dice-button" style="width: 100%;" onclick="diceRoller.rollWithPlotDie()">
                    Roll d20 + Plot Die
                </button>
                <div id="plotDieResult"></div>
            </div>

            <div class="modifier-section">
                <h3>Custom Roll</h3>
                <div class="modifier-input-group">
                    <input type="text" class="modifier-input" id="customDiceInput" placeholder="e.g., 2d6+5, 1d20+3" value="1d20">
                    <button class="dice-button" style="width: auto; padding: 10px 20px;" onclick="diceRoller.rollCustom()">Roll</button>
                </div>
            </div>

            <div id="skillQuickRolls"></div>

            <h3>Roll History</h3>
            <div class="roll-history" id="rollHistory">
                <p style="text-align: center; color: #999;">No rolls yet</p>
            </div>
            <button style="margin-top: 10px;" onclick="diceRoller.clearHistory()">Clear History</button>
        </div>
    </div>

    <script>
        // Dice Roller System
        const diceRoller = {
            history: [],
            hasAdvantage: false,
            hasDisadvantage: false,
            hasPlotDie: false,

            toggleAdvantage: function() {
                this.hasAdvantage = !this.hasAdvantage;
                if (this.hasAdvantage) this.hasDisadvantage = false; // Mutex with disadvantage
                this.updateToggleUI();
            },

            toggleDisadvantage: function() {
                this.hasDisadvantage = !this.hasDisadvantage;
                if (this.hasDisadvantage) this.hasAdvantage = false; // Mutex with advantage
                this.updateToggleUI();
            },

            togglePlotDie: function() {
                this.hasPlotDie = !this.hasPlotDie;
                this.updateToggleUI();
            },

            updateToggleUI: function() {
                document.getElementById('advantageToggle').classList.toggle('active', this.hasAdvantage);
                document.getElementById('disadvantageToggle').classList.toggle('active', this.hasDisadvantage);
                document.getElementById('plotDieToggle').classList.toggle('active', this.hasPlotDie);
            },

            resetToggles: function() {
                this.hasAdvantage = false;
                this.hasDisadvantage = false;
                this.hasPlotDie = false;
                this.updateToggleUI();
            },

            open: function() {
                document.getElementById('diceRollerModal').classList.add('active');
                this.updateSkillQuickRolls();
            },

            close: function() {
                document.getElementById('diceRollerModal').classList.remove('active');
            },

            roll: function(diceNotation, label = '') {
                const result = this.parseDiceRoll(diceNotation);
                this.displayResult(result, label);
                this.addToHistory(result, label);
                return result;
            },

            rollCustom: function() {
                const input = document.getElementById('customDiceInput').value.trim();
                if (!input) return;
                this.roll(input, 'Custom Roll');
            },

            rollWithPlotDie: function() {
                const plotDieRoll = Math.floor(Math.random() * 6) + 1;
                let plotResult = '';
                let plotBonus = 0;

                // Plot die mechanics (6-sided)
                // 1-2: Complication with bonus, 3-4: Blank, 5-6: Opportunity
                if (plotDieRoll >= 5) {
                    plotResult = `‚≠ê Opportunity! (${plotDieRoll})`;
                } else if (plotDieRoll <= 2) {
                    plotBonus = plotDieRoll * 2;
                    plotResult = `‚ö†Ô∏è Complication! (+${plotBonus} bonus) (${plotDieRoll})`;
                } else {
                    plotResult = `Blank (${plotDieRoll}) - No effect`;
                }

                // Roll d20
                const d20Roll = Math.floor(Math.random() * 20) + 1;
                const finalRoll = d20Roll + plotBonus;
                
                let breakdown = `Plot Die: ${plotResult}<br>`;
                if (plotBonus > 0) {
                    breakdown += `d20: ${d20Roll} + ${plotBonus} (Complication bonus) = ${finalRoll}`;
                } else {
                    breakdown += `d20: ${d20Roll}`;
                }

                const result = {
                    total: finalRoll,
                    breakdown: breakdown,
                    dice: [d20Roll],
                    modifier: plotBonus,
                    diceRolls: [d20Roll]
                };

                this.displayResult(result, 'Plot Die Roll');
                this.addToHistory(result, 'Plot Die Roll');

                // Show plot die result
                document.getElementById('plotDieResult').innerHTML = `
                    <div class="plot-die-result">
                        <span class="plot-die-icon">üé≤</span>
                        <div>${plotResult}</div>
                    </div>
                `;
            },

            parseDiceRoll: function(notation) {
                notation = notation.toLowerCase().replace(/\s/g, '');
                
                // Parse notation like "2d6+5" or "1d20-2"
                const match = notation.match(/(\d+)?d(\d+)([\+\-]\d+)?/);
                
                if (!match) {
                    // Try just a modifier
                    if (/^[\+\-]?\d+$/.test(notation)) {
                        return {
                            total: parseInt(notation),
                            breakdown: `Flat modifier: ${notation}`,
                            dice: [],
                            modifier: parseInt(notation),
                            diceRolls: []
                        };
                    }
                    return null;
                }

                const numDice = parseInt(match[1]) || 1;
                const dieSize = parseInt(match[2]);
                const modifier = match[3] ? parseInt(match[3]) : 0;

                const rolls = [];
                for (let i = 0; i < numDice; i++) {
                    rolls.push(Math.floor(Math.random() * dieSize) + 1);
                }

                const diceTotal = rolls.reduce((sum, roll) => sum + roll, 0);
                const total = diceTotal + modifier;

                const breakdown = `${numDice}d${dieSize}${modifier >= 0 ? '+' : ''}${modifier !== 0 ? modifier : ''}<br>` +
                                `Rolls: [${rolls.join(', ')}] = ${diceTotal}` +
                                (modifier !== 0 ? `<br>Modifier: ${modifier >= 0 ? '+' : ''}${modifier}` : '');

                return {
                    total: total,
                    breakdown: breakdown,
                    dice: rolls,
                    modifier: modifier,
                    diceRolls: rolls
                };
            },

            displayResult: function(result, label) {
                if (!result) {
                    document.getElementById('rollResult').innerHTML = `
                        <div class="roll-result">
                            <div>Invalid dice notation</div>
                        </div>
                    `;
                    document.getElementById('rollResult').style.display = 'block';
                    return;
                }

                const resultHTML = `
                    <div class="roll-result">
                        ${label ? `<div style="font-size: 1.2em; margin-bottom: 10px;">${label}</div>` : ''}
                        <div class="roll-result-total">${result.total}</div>
                        <div class="roll-result-breakdown">${result.breakdown}</div>
                    </div>
                `;

                document.getElementById('rollResult').innerHTML = resultHTML;
                document.getElementById('rollResult').style.display = 'block';
            },

            addToHistory: function(result, label) {
                const timestamp = new Date().toLocaleTimeString();
                this.history.unshift({
                    result: result,
                    label: label,
                    timestamp: timestamp
                });

                // Keep only last 20 rolls
                if (this.history.length > 20) {
                    this.history = this.history.slice(0, 20);
                }

                this.updateHistoryDisplay();
            },

            updateHistoryDisplay: function() {
                const container = document.getElementById('rollHistory');
                
                if (this.history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No rolls yet</p>';
                    return;
                }

                container.innerHTML = this.history.map(entry => {
                    let resultDisplay;
                    if (entry.result.damageTotal !== undefined) {
                        // Weapon attack with damage
                        resultDisplay = `<strong>${entry.result.total}</strong> <span style="font-size: 0.8em; color: #999;">ATK</span> / <strong>${entry.result.damageTotal}</strong> <span style="font-size: 0.8em; color: #999;">DMG</span>`;
                    } else {
                        resultDisplay = `<strong>${entry.result.total}</strong>`;
                    }
                    
                    return `
                        <div class="roll-history-item">
                            ${resultDisplay} - ${entry.label || 'Roll'}
                            <span style="float: right; color: #999; font-size: 0.85em;">${entry.timestamp}</span>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${entry.result.breakdown.replace(/<br>/g, ', ').replace(/<\/?strong>/g, '')}</div>
                        </div>
                    `;
                }).join('');
            },

            clearHistory: function() {
                this.history = [];
                this.updateHistoryDisplay();
            },

            updateSkillQuickRolls: function() {
                if (!app.currentCharacter) return;

                const char = app.currentCharacter;
                const skills = app.rules.skills.list;

                // Get skills with ranks > 0 or significant modifiers
                const relevantSkills = skills.filter(skill => {
                    const rank = char.skills[skill.id] || 0;
                    const attr = char.attributes[skill.attribute] || 0;
                    return rank > 0 || attr > 0;
                }).slice(0, 12); // Show top 12

                if (relevantSkills.length === 0) return;

                const html = `
                    <h3>Quick Skill Rolls</h3>
                    <div class="skill-quick-roll">
                        ${relevantSkills.map(skill => {
                            const rank = char.skills[skill.id] || 0;
                            const attr = char.attributes[skill.attribute] || 0;
                            const modifier = attr + rank;
                            
                            return `
                                <button class="skill-roll-btn" onclick="diceRoller.rollSkill('${skill.id}', '${skill.name}', ${modifier})">
                                    <div class="skill-roll-name">${skill.name}</div>
                                    <div class="skill-roll-modifier">+${modifier}</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                `;

                document.getElementById('skillQuickRolls').innerHTML = html;
            },

            rollSkill: function(skillId, skillName, modifier) {
                const d20Roll = Math.floor(Math.random() * 20) + 1;
                const total = d20Roll + modifier;

                const result = {
                    total: total,
                    breakdown: `1d20 + ${modifier}<br>Roll: ${d20Roll} + Modifier: ${modifier}`,
                    dice: [d20Roll],
                    modifier: modifier,
                    diceRolls: [d20Roll]
                };

                this.displayResult(result, `${skillName} Test`);
                this.addToHistory(result, `${skillName} Test`);
            },

            // Inline rolling - shows toast instead of modal
            rollInline: function(notation, label, showToast = true) {
                let finalResult;
                let plotDieInfo = '';
                let plotBonus = 0;

                // Roll plot die if enabled
                if (this.hasPlotDie) {
                    const plotRoll = Math.floor(Math.random() * 6) + 1;
                    if (plotRoll >= 5) {
                        // 5-6: Opportunity
                        plotDieInfo = 'üìñ Plot Die: ‚≠ê Opportunity! ‚Ä¢ ';
                    } else if (plotRoll <= 2) {
                        // 1-2: Complication with bonus
                        plotBonus = plotRoll * 2; // +2 for roll of 1, +4 for roll of 2
                        plotDieInfo = `üìñ Plot Die: ‚ö†Ô∏è Complication! (+${plotBonus} bonus) ‚Ä¢ `;
                    } else {
                        // 3-4: Blank (no effect)
                        plotDieInfo = 'üìñ Plot Die: Blank (no effect) ‚Ä¢ ';
                    }
                }

                // Check if this is a d20 roll that can have advantage/disadvantage
                const isD20Roll = notation.toLowerCase().includes('d20');
                
                if (isD20Roll && (this.hasAdvantage || this.hasDisadvantage)) {
                    // Roll with advantage/disadvantage
                    const baseResult = this.parseDiceRoll(notation);
                    const secondResult = this.parseDiceRoll(notation);
                    
                    if (this.hasAdvantage) {
                        finalResult = baseResult.total >= secondResult.total ? baseResult : secondResult;
                        finalResult.breakdown = `‚¨ÜÔ∏è Advantage: [${baseResult.total}, ${secondResult.total}] ‚Üí Keep ${finalResult.total}`;
                    } else {
                        finalResult = baseResult.total <= secondResult.total ? baseResult : secondResult;
                        finalResult.breakdown = `‚¨áÔ∏è Disadvantage: [${baseResult.total}, ${secondResult.total}] ‚Üí Keep ${finalResult.total}`;
                    }
                    
                    // Apply plot die bonus
                    if (plotBonus > 0) {
                        finalResult.total += plotBonus;
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown + ` + ${plotBonus}`;
                    } else if (plotDieInfo) {
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown;
                    }
                } else {
                    finalResult = this.parseDiceRoll(notation);
                    if (!finalResult) return;
                    
                    // Apply plot die bonus
                    if (plotBonus > 0) {
                        finalResult.total += plotBonus;
                    }
                    
                    if (plotDieInfo) {
                        finalResult.breakdown = plotDieInfo + finalResult.breakdown;
                    }
                }

                this.addToHistory(finalResult, label);

                if (showToast) {
                    this.showToast(finalResult, label);
                } else {
                    this.displayResult(finalResult, label);
                }

                // Reset toggles after integrated roll
                this.resetToggles();

                return finalResult;
            },

            showToast: function(result, label) {
                const toast = document.getElementById('rollToast');
                const title = document.getElementById('toastTitle');
                const resultElem = document.getElementById('toastResult');
                const breakdown = document.getElementById('toastBreakdown');

                title.textContent = label || 'Roll';
                
                // If this is a weapon attack with damage, show both totals prominently
                if (result.damageTotal !== undefined) {
                    resultElem.innerHTML = `${result.total} <span style="font-size: 0.7em; color: #999;">ATK</span> / ${result.damageTotal} <span style="font-size: 0.7em; color: #999;">DMG</span>`;
                } else {
                    resultElem.textContent = result.total;
                }
                
                breakdown.innerHTML = result.breakdown.replace(/<br>/g, ' ‚Ä¢ ');

                // Show toast (stays visible until manually dismissed)
                toast.classList.remove('hiding');
                toast.classList.add('show');
            },

            hideToast: function() {
                const toast = document.getElementById('rollToast');
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.classList.remove('show', 'hiding');
                }, 300);
            },

            rollAttribute: function(attrName, attrValue) {
                const label = attrName.charAt(0).toUpperCase() + attrName.slice(1) + ' Test';
                this.rollInline(`1d20+${attrValue}`, label);
            },

            rollDefense: function(defenseName, defenseValue) {
                const label = defenseName + ' Check';
                // For defense checks, just roll d20 (defense is the DC for opponents)
                this.rollInline('1d20', label);
            },

            rollRecovery: function(dieType) {
                this.rollInline(dieType, 'Recovery Roll');
            },

            rollWeaponAttack: function(weaponName, attackBonus, damage) {
                let plotDieInfo = '';
                let effectiveAdvantage = this.hasAdvantage;
                let effectiveDisadvantage = this.hasDisadvantage;

                // Roll plot die if enabled
                let plotBonus = 0;
                if (this.hasPlotDie) {
                    const plotRoll = Math.floor(Math.random() * 6) + 1;
                    if (plotRoll >= 5) {
                        // 5-6: Opportunity
                        plotDieInfo = 'üìñ Plot Die: ‚≠ê Opportunity!<br>';
                    } else if (plotRoll <= 2) {
                        // 1-2: Complication with bonus
                        plotBonus = plotRoll * 2; // +2 for roll of 1, +4 for roll of 2
                        plotDieInfo = `üìñ Plot Die: ‚ö†Ô∏è Complication! (+${plotBonus} bonus)<br>`;
                    } else {
                        // 3-4: Blank (no effect)
                        plotDieInfo = 'üìñ Plot Die: Blank (no effect)<br>';
                    }
                }

                // Roll attack (1d20 + bonus) with advantage/disadvantage
                let d20Roll, attackTotal, attackInfo;
                if (this.hasAdvantage || this.hasDisadvantage) {
                    const roll1 = Math.floor(Math.random() * 20) + 1;
                    const roll2 = Math.floor(Math.random() * 20) + 1;
                    
                    if (this.hasAdvantage) {
                        d20Roll = Math.max(roll1, roll2);
                        attackInfo = `‚¨ÜÔ∏è Advantage: [${roll1}, ${roll2}] ‚Üí ${d20Roll}`;
                    } else {
                        d20Roll = Math.min(roll1, roll2);
                        attackInfo = `‚¨áÔ∏è Disadvantage: [${roll1}, ${roll2}] ‚Üí ${d20Roll}`;
                    }
                    attackTotal = d20Roll + attackBonus + plotBonus;
                    if (plotBonus > 0) {
                        attackInfo += ` + ${attackBonus} + ${plotBonus}`;
                    } else {
                        attackInfo += ` + ${attackBonus}`;
                    }
                } else {
                    d20Roll = Math.floor(Math.random() * 20) + 1;
                    attackTotal = d20Roll + attackBonus + plotBonus;
                    if (plotBonus > 0) {
                        attackInfo = `1d20 (${d20Roll}) + ${attackBonus} + ${plotBonus}`;
                    } else {
                        attackInfo = `1d20 (${d20Roll}) + ${attackBonus}`;
                    }
                }
                
                // Roll damage
                const damageResult = this.parseDiceRoll(damage);
                
                const label = `${weaponName} Attack`;
                let breakdown = plotDieInfo + `<strong>Attack:</strong> ${attackInfo} = <strong>${attackTotal}</strong>`;
                
                if (damageResult) {
                    breakdown += `<br><strong>Damage:</strong> ${damageResult.breakdown.replace(/<br>/g, ' ')} = <strong>${damageResult.total}</strong>`;
                } else {
                    breakdown += `<br><strong>Damage:</strong> ${damage}`;
                }
                
                const result = {
                    total: attackTotal,
                    damageTotal: damageResult ? damageResult.total : 0,
                    breakdown: breakdown,
                    diceRolls: [d20Roll, ...(damageResult ? damageResult.diceRolls : [])]
                };
                
                this.showToast(result, label);
                this.addToHistory(result, label);

                // Reset toggles after weapon attack
                this.resetToggles();
            },

            rollAttack: function(type, bonusStr) {
                const bonus = parseInt(bonusStr.replace('+', '')) || 0;
                const label = `${type} Attack Roll`;
                this.rollInline(`1d20+${bonus}`, label);
            },

            rollInitiative: function(bonusStr) {
                const bonus = parseInt(bonusStr.replace('+', '')) || 0;
                this.rollInline(`1d20+${bonus}`, 'Initiative');
            }
        };

        // Keyboard shortcut: Press 'D' to open dice roller
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
                // Don't trigger if typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                diceRoller.open();
            }
            // Press Escape to close
            if (e.key === 'Escape') {
                diceRoller.close();
            }
        });

        // Embedded rules data
        const COSMERE_RULES = {"version":"2.0","gameName":"Cosmere RPG - Stormlight","maxLevel":10,"attributes":{"list":[{"id":"strength","name":"Strength","abbr":"STR","category":"physical","description":"Physical power and resilience"},{"id":"speed","name":"Speed","abbr":"SPD","category":"physical","description":"Quickness and reflexes"},{"id":"intellect","name":"Intellect","abbr":"INT","category":"cognitive","description":"Applied intelligence and wit"},{"id":"willpower","name":"Willpower","abbr":"WIL","category":"cognitive","description":"Mental fortitude and determination"},{"id":"awareness","name":"Awareness","abbr":"AWA","category":"spiritual","description":"Perception and environmental awareness"},{"id":"presence","name":"Presence","abbr":"PRE","category":"spiritual","description":"Force of personality and charisma"}],"minValue":0,"maxValue":5,"startingTotal":12},"skills":{"list":[{"id":"agility","name":"Agility","category":"physical","attribute":"speed","description":"Acrobatics, climbing, and nimbleness"},{"id":"athletics","name":"Athletics","category":"physical","attribute":"strength","description":"Running, jumping, and physical prowess"},{"id":"heavy_weaponry","name":"Heavy Weaponry","category":"physical","attribute":"strength","description":"Large melee and ranged weapons"},{"id":"light_weaponry","name":"Light Weaponry","category":"physical","attribute":"speed","description":"Small melee and ranged weapons"},{"id":"stealth","name":"Stealth","category":"physical","attribute":"speed","description":"Hiding and moving undetected"},{"id":"crafting","name":"Crafting","category":"cognitive","attribute":"intellect","description":"Creating and repairing items"},{"id":"deduction","name":"Deduction","category":"cognitive","attribute":"intellect","description":"Logic and investigation"},{"id":"discipline","name":"Discipline","category":"cognitive","attribute":"willpower","description":"Self-control and composure"},{"id":"intimidation","name":"Intimidation","category":"cognitive","attribute":"willpower","description":"Threats and coercion"},{"id":"lore","name":"Lore","category":"cognitive","attribute":"intellect","description":"Knowledge and education"},{"id":"medicine","name":"Medicine","category":"cognitive","attribute":"intellect","description":"Healing and treating injuries"},{"id":"perception","name":"Perception","category":"cognitive","attribute":"awareness","description":"Spotting details and danger"},{"id":"survival","name":"Survival","category":"cognitive","attribute":"awareness","description":"Wilderness skills and tracking"},{"id":"thievery","name":"Thievery","category":"cognitive","attribute":"speed","description":"Lockpicking and sleight of hand"},{"id":"deception","name":"Deception","category":"spiritual","attribute":"presence","description":"Lying and misdirection"},{"id":"insight","name":"Insight","category":"spiritual","attribute":"awareness","description":"Reading people and motives"},{"id":"leadership","name":"Leadership","category":"spiritual","attribute":"presence","description":"Inspiring and commanding others"},{"id":"persuasion","name":"Persuasion","category":"spiritual","attribute":"presence","description":"Convincing and negotiating"}],"maxRanks":5},"defenses":{"physical":{"name":"Physical","base":10,"attributes":["strength","speed"]},"cognitive":{"name":"Cognitive","base":10,"attributes":["intellect","willpower"]},"spiritual":{"name":"Spiritual","base":10,"attributes":["awareness","presence"]}},"resources":{"health":{"baseValue":10,"perLevel":5,"attributeBonus":"strength"},"focus":{"baseValue":5,"perLevel":2,"attributeBonus":"willpower"},"investiture":{"baseValue":0,"perLevel":2,"note":"Radiant paths only"},"recoveryDie":{"progression":{"1":"1d6","4":"1d8","7":"1d10","10":"1d12"}}},"movement":{"baseSpeed":25,"note":"Base movement in feet, +5 per Speed"},"senses":{"baseRange":30,"note":"Base range in feet, +10 per Awareness"},"lifting":{"baseCapacity":100,"note":"Base capacity in lbs, +50 per Strength"},"heroicPaths":[{"id":"agent","name":"Agent","description":"Artists of duplicity and sabotage, Agents grasp the threads of fate in the palms of their hands","keyAttribute":"awareness","startingSkill":"insight","primarySkills":["stealth","thievery","deception","insight","deduction"],"keyTalent":{"id":"opportunist","name":"Opportunist","prerequisite":"none","activation":"special","description":"Once per round, when you roll a plot die, you can reroll that result. The original roll has no effect and you must use the new result."},"specialties":[{"id":"investigator","name":"Investigator","description":"Cultivate trustworthy instincts, learning to listen, collaborate, and pursue answers to questions others don't think to ask","talents":[{"id":"watchful_eye","name":"Watchful Eye","prerequisite":"Deduction 1+","activation":"reaction","description":"Use Opportunist on the plot die of a willing ally within 20 feet."},{"id":"get_em_talking","name":"Get 'Em Talking","prerequisite":"Insight 2+","activation":"2_actions","description":"Spend 1 focus to test Deduction vs. Spiritual to learn the target's motivation. During this scene, you can raise the stakes on tests to leverage this motivation."},{"id":"quick_analysis","name":"Quick Analysis","prerequisite":"Get 'Em Talking","activation":"free_action","description":"Spend 2 focus to gain momentum for cognitive tests with Use a Skill, Gain Advantage, or an Agent talent."},{"id":"baleful","name":"Baleful","prerequisite":"Get 'Em Talking","activation":"always","description":"To resist your influence, a character must spend additional focus equal to your tier."},{"id":"gather_evidence","name":"Gather Evidence","prerequisite":"Insight 2+, Quick Analysis","activation":"always","description":"Gain Legal Codes expertise. When you succeed on a cognitive test against a target, you become Focused until the end of your next turn."},{"id":"hardy_agent","name":"Hardy","prerequisite":"none","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"sleuths_instincts","name":"Sleuth's Instincts","prerequisite":"Deduction 3+","activation":"always","description":"Gain an advantage on cognitive tests against characters whose motivation you know. You know when those characters lie to you."},{"id":"close_the_case","name":"Close the Case","prerequisite":"Deduction 3+, Hardy","activation":"1_action","description":"Spend 3 focus to test Deduction vs. Cognitive, gaining an advantage if you know the target's motivation. On failure, the target gains an advantage against you. On success, they back down."}]},{"id":"spy","name":"Spy","description":"Plant themselves in sticky situations, ready to deflect or ease suspicion when it inevitably sweeps their way","talents":[{"id":"sure_outcome","name":"Sure Outcome","prerequisite":"Insight 2+","activation":"special","description":"When you use Opportunist, spend 2 focus to change opportunity to 4, or change any result to opportunity."},{"id":"plausible_excuse","name":"Plausible Excuse","prerequisite":"Deception 1+","activation":"free_action","description":"Gain Sleight of Hand expertise. When discovered skulking, spend 2 focus to feign innocence."},{"id":"collected_agent","name":"Collected","prerequisite":"none","activation":"always","description":"Increase your Cognitive and Spiritual defenses by 2."},{"id":"cover_story","name":"Cover Story","prerequisite":"none","activation":"always","description":"Gain a false identity and a relevant cultural expertise."},{"id":"subtle_takedown","name":"Subtle Takedown","prerequisite":"Insight 3+","activation":"1_action","description":"Make an unarmed attack with Insight vs. an unsuspecting target's Cognitive, raising the stakes. On a hit, they can't communicate."},{"id":"mighty_agent","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"mercurial_facade","name":"Mercurial Facade","prerequisite":"Deception 3+","activation":"1_action","description":"Disguise yourself using Deception without needing physical supplies. The first character to see through your disguise is Surprised."},{"id":"high_society_contacts_agent","name":"High Society Contacts","prerequisite":"Patron in high society","activation":"special","description":"Gain High Society expertise. Spend 2 focus to add opportunity to a test to interact in high society."}]},{"id":"thief","name":"Thief","description":"Train their bodies to keep pace with their quick minds, risking it all to swindle insurmountable odds","talents":[{"id":"risky_behavior","name":"Risky Behavior","prerequisite":"Insight 2+","activation":"special","description":"Spend 1 focus to raise the stakes on your test."},{"id":"cheap_shot","name":"Cheap Shot","prerequisite":"none","activation":"1_action","description":"Spend 1 focus to make an unarmed attack with Thievery vs. Cognitive, raising the stakes. On a hit, the target is Stunned."},{"id":"double_down","name":"Double Down","prerequisite":"none","activation":"special","description":"You can reroll again with Opportunist, but on complication, you lose 2 focus."},{"id":"surefooted_agent","name":"Surefooted","prerequisite":"none","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"underworld_contacts","name":"Underworld Contacts","prerequisite":"Patron or follower in criminal underworld","activation":"special","description":"Gain Criminal Groups expertise. Spend 2 focus to add opportunity to a social test against criminals."},{"id":"shadow_step","name":"Shadow Step","prerequisite":"Thievery 3+","activation":"special","description":"After you Disengage, spend 2 focus to test Thievery vs. each enemy's Cognitive to hide from them. You gain an advantage if in cover or obscured."},{"id":"fast_talker","name":"Fast Talker","prerequisite":"Insight 3+","activation":"free_action","description":"Spend 2 focus to gain momentum for spiritual tests with Use a Skill, Gain Advantage, or an Agent talent."},{"id":"tricksters_hand","name":"Trickster's Hand","prerequisite":"Thievery 3+","activation":"free_action","description":"Spend 2 focus to gain momentum for physical tests with Use a Skill, Gain Advantage, or an Agent talent."}]}]},{"id":"envoy","name":"Envoy","description":"Prominent organizations appoint Envoys who vie for resources, curry favor, or offer service on the organization's behalf","keyAttribute":"presence","startingSkill":"discipline","primarySkills":["discipline","leadership","persuasion","deception","lore"],"keyTalent":{"id":"rousing_presence","name":"Rousing Presence","prerequisite":"none","activation":"free_action","description":"Choose an ally you can influence. They become Determined until they benefit from that condition or until the scene ends."},"specialties":[{"id":"diplomat","name":"Diplomat","description":"Adept at navigating court politics, using what they learn to seek favorable treatment","talents":[{"id":"steadfast_challenge","name":"Steadfast Challenge","prerequisite":"Discipline 1+","activation":"1_action","description":"Spend 1 focus to test Discipline vs. an enemy's Spiritual. On success, they are Disoriented and gain a disadvantage on tests against you."},{"id":"collected_envoy","name":"Collected","prerequisite":"none","activation":"always","description":"Increase your Cognitive and Spiritual defenses by 2."},{"id":"withering_retort","name":"Withering Retort","prerequisite":"Discipline 2+, Steadfast Challenge","activation":"reaction","description":"Use your Steadfast Challenge before an attack and increase your deflect against the attack by your ranks in Discipline."},{"id":"well_dressed_envoy","name":"Well Dressed","prerequisite":"none","activation":"always","description":"Gain Fashion expertise. While wearing Presentable armor or fashionable clothing, gain an advantage on your first Deception, Leadership, or Persuasion test."},{"id":"calm_appeal","name":"Calm Appeal","prerequisite":"Discipline 2+, Withering Retort","activation":"special","description":"When your Steadfast Challenge makes a target Disoriented, spend 1 focus to pacify them. Resisting your Steadfast Challenge costs additional focus equal to your ranks in Discipline."},{"id":"high_society_contacts_envoy","name":"High Society Contacts","prerequisite":"Patron in high society, Well Dressed","activation":"special","description":"Gain High Society expertise. Spend 2 focus to add opportunity to a test to interact in high society."},{"id":"peaceful_solution","name":"Peaceful Solution","prerequisite":"Discipline 3+, Calm Appeal","activation":"special","description":"If all non-minion enemies are pacified, you ease tensions and end combat."},{"id":"practiced_oratory","name":"Practiced Oratory","prerequisite":"Persuasion 3+","activation":"special","description":"When you use Rousing Presence or Steadfast Challenge, spend focus up to your ranks in Persuasion to add that many targets."}]},{"id":"faithful","name":"Faithful","description":"Devote themselves to traditions of their faith, demonstrating convictions through word or deed","talents":[{"id":"customary_garb_envoy","name":"Customary Garb","prerequisite":"none","activation":"always","description":"While wearing Presentable armor or appropriate clothing, increase your Physical and Spiritual defenses by 2."},{"id":"galvanize","name":"Galvanize","prerequisite":"none","activation":"1_action","description":"An ally rolls their recovery die and recovers that much focus."},{"id":"devoted_presence","name":"Devoted Presence","prerequisite":"Lore 1+","activation":"special","description":"When you use Rousing Presence, spend 1 focus to remove Prone, Slowed, Stunned, and Surprised from your target."},{"id":"composed_envoy","name":"Composed","prerequisite":"none","activation":"always","description":"Increase your max and current focus by your tier."},{"id":"stalwart_presence","name":"Stalwart Presence","prerequisite":"Discipline 2+","activation":"special","description":"When you use Rousing Presence, spend 1 focus to increase one of the target's defenses by 2."},{"id":"applied_motivation","name":"Applied Motivation","prerequisite":"Discipline 2+","activation":"always","description":"When you cause a character to recover focus, they recover additional focus equal to half your ranks in Lore."},{"id":"sage_counsel","name":"Sage Counsel","prerequisite":"Lore 3+","activation":"special","description":"When you Aid a character, spend 1 focus to grant them Rousing Presence."},{"id":"inspired_zeal","name":"Inspired Zeal","prerequisite":"Discipline 3+","activation":"always","description":"When an ally uses Determined, choose other allies to recover 1 focus, up to your ranks in Discipline."}]},{"id":"mentor","name":"Mentor","description":"Devote themselves to their wards, patiently nurturing others toward greatness","talents":[{"id":"sound_advice","name":"Sound Advice","prerequisite":"none","activation":"special","description":"Spend 1 focus to use Rousing Presence on an ally who failed a skill test."},{"id":"practical_demonstration","name":"Practical Demonstration","prerequisite":"Leadership 1+","activation":"special","description":"When you Gain Advantage or hit with an attack, use your Rousing Presence as a free action."},{"id":"lessons_in_patience","name":"Lessons in Patience","prerequisite":"Discipline 2+","activation":"special","description":"Gain Motivational Speech expertise. When you use Rousing Presence, your target recovers 1 focus."},{"id":"mighty_envoy","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"instill_confidence","name":"Instill Confidence","prerequisite":"A companion","activation":"special","description":"Rousing Presence can make an ally Focused instead of Determined."},{"id":"guiding_oration","name":"Guiding Oration","prerequisite":"Leadership 2+","activation":"always","description":"After you Gain Advantage, an ally within 10 feet of your target gains an advantage on their next test against your target."},{"id":"foresight","name":"Foresight","prerequisite":"Discipline 3+","activation":"always","description":"Gain an additional action each turn."},{"id":"rallying_shout","name":"Rallying Shout","prerequisite":"Leadership 3+","activation":"special","description":"Rousing Presence can revive an Unconscious ally, and if they have 0 health, they recover health equal to their recovery die + your ranks in Leadership."}]}]},{"id":"hunter","name":"Hunter","description":"The thrill of the chase thrums in a Hunter's mind as they patiently surveil","keyAttribute":"awareness","startingSkill":"perception","primarySkills":["perception","stealth","survival","agility","light_weaponry"],"keyTalent":{"id":"seek_quarry","name":"Seek Quarry","prerequisite":"none","activation":"special","description":"After spending 1 minute mentally preparing, you choose a character who you can sense or who you've previously encountered. That character becomes your quarry. You gain an advantage on tests made to find, attack, or study your quarry."},"specialties":[{"id":"archer","name":"Archer","description":"Shape the battlefield before frontline confrontation, steadily unleashing a torrent of arrows","talents":[{"id":"tagging_shot","name":"Tagging Shot","prerequisite":"Perception 2+","activation":"1_action","description":"Move 5 feet and make a ranged attack. On a hit or a graze, the target becomes your quarry."},{"id":"combat_training_hunter","name":"Combat Training","prerequisite":"none","activation":"always","description":"Gain expertise in a weapon, an armor, and Military Life. Once per round, graze without spending focus."},{"id":"sharp_eye","name":"Sharp Eye","prerequisite":"Tagging Shot","activation":"special","description":"Observe a target then test Perception vs. Cognitive to learn their lowest attribute, lowest defense, or if their health, focus, or Investiture are below half."},{"id":"steady_aim","name":"Steady Aim","prerequisite":"Agility 1+, Combat Training","activation":"always","description":"Increase your weapon range by half and deal extra damage equal to your ranks in Perception."},{"id":"exploit_weakness","name":"Exploit Weakness","prerequisite":"Perception 3+, Sharp Eye","activation":"free_action","description":"Gain Advantage on your quarry without spending actions."},{"id":"backstep","name":"Backstep","prerequisite":"Agility 2+, Steady Aim","activation":"special","description":"After making a ranged attack, spend 2 focus to Disengage without spending actions, and Brace if you enter cover or obscured area."},{"id":"unrelenting_salvo","name":"Unrelenting Salvo","prerequisite":"Agility 3+, Hardy","activation":"always","description":"You can Strike your quarry more than once per turn with the same ranged weapon."},{"id":"hardy_hunter","name":"Hardy","prerequisite":"Steady Aim","activation":"always","description":"Gain +1 max health per level (including previous levels)."}]},{"id":"assassin","name":"Assassin","description":"Exploit weaknesses to quickly incapacitate their quarry","talents":[{"id":"startling_blow","name":"Startling Blow","prerequisite":"Stealth 1+","activation":"1_action","description":"Make an unarmed or improvised weapon attack vs. Cognitive. On a hit or graze, the target is Surprised."},{"id":"killing_edge","name":"Killing Edge","prerequisite":"Perception 2+","activation":"always","description":"Gain Knives and Slings expertises. These weapons gain the Deadly and Quickdraw expert traits."},{"id":"fatal_thrust","name":"Fatal Thrust","prerequisite":"Perception 3+","activation":"1_action","description":"Attack an unsuspecting target with a light melee weapon vs. Cognitive. Add 4d4 damage, and gain two advantages if the weapon is Discreet. Max damage rolls add a penalty to the injury roll."},{"id":"shadowing","name":"Shadowing","prerequisite":"Stealth 2+","activation":"always","description":"Your quarry gains a disadvantage to sense you, and you gain an advantage to avoid their notice. When you succeed vs. Spiritual while in cover or obscured, spend 3 focus to designate that target as your quarry."},{"id":"mighty_hunter","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"cold_eyes","name":"Cold Eyes","prerequisite":"none","activation":"always","description":"After you defeat your quarry, recover 1 focus and choose a new quarry."},{"id":"swift_strikes_hunter","name":"Swift Strikes","prerequisite":"none","activation":"special","description":"Spend 1 focus to make a second Strike with the same weapon."},{"id":"sidestep","name":"Sidestep","prerequisite":"Stealth 3+","activation":"always","description":"Gain an additional action to Dodge when you're not wearing armor with deflect of 2 or higher."}]},{"id":"tracker","name":"Tracker","description":"In untamed wilds, none are more capable, with trusty animal companions at their sides","talents":[{"id":"deadly_trap","name":"Deadly Trap","prerequisite":"Survival 1+","activation":"1_action","description":"Conceal a 5-foot entangling or impaling trap. Entangling Trap: Test Survival vs. Cognitive, roll 2d4 impact damage, target is Immobilized. Impaling Trap: Test Survival vs. Physical, roll 2d4 keen damage, target is Afflicted."},{"id":"animal_bond","name":"Animal Bond","prerequisite":"Animal companion","activation":"always","description":"While your companion is within 10 feet, your defenses increase by 1. Use free action to give your companion momentum or actions on your turn. They can use Track as free action to make a target your quarry."},{"id":"experienced_trapper","name":"Experienced Trapper","prerequisite":"Perception 2+","activation":"always","description":"You easily forage for characters up to your ranks in Survival. You can fashion natural tools using Survival. Your Deadly Traps increase to 2d6 damage and 2 rounds duration."},{"id":"protective_bond","name":"Protective Bond","prerequisite":"Animal Bond","activation":"always","description":"Your animal companion protects an ally within 30 feet of you, and that ally gains your Animal Bond bonus instead of you."},{"id":"hunters_edge","name":"Hunter's Edge","prerequisite":"Survival 3+","activation":"always","description":"Your animal companion gains an advantage against your quarry. Your Deadly Traps increase to 2d8 damage and 3 rounds duration."},{"id":"pack_hunting","name":"Pack Hunting","prerequisite":"Perception 3+","activation":"special","description":"Spend 1 focus to add your ranks in Survival to your ally's attack or damage roll against your quarry."},{"id":"surefooted_hunter","name":"Surefooted","prerequisite":"none","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"feral_connection","name":"Feral Connection","prerequisite":"Survival 2+","activation":"always","description":"Gain expertise in Animal Care. Your animal companion's health increases by 5 \u00d7 your tier, their defenses increase by 2, and their tests gain a bonus equal to your ranks in Survival."}]}]},{"id":"leader","name":"Leader","description":"Beacons of encouragement and direction, Leaders oversee the efforts of others","keyAttribute":"presence","startingSkill":"leadership","primarySkills":["leadership","persuasion","intimidation","athletics","heavy_weaponry"],"keyTalent":{"id":"decisive_command","name":"Decisive Command","prerequisite":"none","activation":"1_action","description":"Gain a command die (d4). Spend 1 focus to choose an ally you can influence within 20 feet. The next time they make a test before the end of their next turn, they can roll your command die and add it to one die roll from that test (other than the plot die)."},"specialties":[{"id":"champion","name":"Champion","description":"Inspiring others through unfaltering grit, ferociously charging their foes","talents":[{"id":"combat_coordination","name":"Combat Coordination","prerequisite":"Leadership 2+","activation":"special","description":"After you Strike, use Decisive Command as free action. If your Strike didn't hit, you also don't spend focus."},{"id":"valiant_intervention","name":"Valiant Intervention","prerequisite":"Athletics 1+","activation":"1_action","description":"Spend 1 focus to move 10 feet, then test Athletics vs. Spiritual to give a target a disadvantage on tests against your allies."},{"id":"imposing_posture","name":"Imposing Posture","prerequisite":"Athletics 2+, Combat Coordination","activation":"always","description":"After an enemy resists your influence while in your weapon's reach, they are Disoriented until the end of their next turn."},{"id":"hardy_leader","name":"Hardy","prerequisite":"Valiant Intervention","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"mighty_leader","name":"Mighty","prerequisite":"Imposing Posture","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"resolute_stand","name":"Resolute Stand","prerequisite":"Athletics 1+","activation":"special","description":"Valiant Intervention prevents Reactive Strikes. Spend focus up to your ranks in Leadership to add that many targets for Valiant Intervention."},{"id":"resilient_hero","name":"Resilient Hero","prerequisite":"Athletics 3+, Resolute Stand","activation":"reaction","description":"Once per scene, before your health drops to 0, it instead becomes equal to your Athletics modifier."},{"id":"demonstrative_command","name":"Demonstrative Command","prerequisite":"Leadership 2+, Resolute Stand","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Athletics, Agility, or Leadership d20 roll."}]},{"id":"officer","name":"Officer","description":"Coolly maintain order in utter chaos, orchestrating the march to victory","talents":[{"id":"composed_leader","name":"Composed","prerequisite":"none","activation":"always","description":"Increase your max and current focus by your tier."},{"id":"through_the_fray","name":"Through the Fray","prerequisite":"Persuasion 1+","activation":"free_action","description":"An ally within 20 feet can Disengage or Gain Advantage as free action."},{"id":"well_supplied","name":"Well Supplied","prerequisite":"Persuasion 2+","activation":"special","description":"Gain Military Logistics expertise. Spend 2 focus to add opportunity to your test to requisition resources."},{"id":"customary_garb_leader","name":"Customary Garb","prerequisite":"none","activation":"always","description":"While wearing Presentable armor or appropriate clothing, increase your Physical and Spiritual defenses by 2."},{"id":"relentless_march","name":"Relentless March","prerequisite":"Persuasion 3+","activation":"always","description":"Decisive Command increases your target's movement by 10 feet, and they ignore Exhausted, Slowed, and Surprised."},{"id":"confident_command","name":"Confident Command","prerequisite":"Leadership 2+","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Intimidation, Leadership, or Persuasion d20 roll."},{"id":"synchronized_assault","name":"Synchronized Assault","prerequisite":"Leadership 3+","activation":"2_actions","description":"Spend 2 focus to test Leadership vs. enemy's Cognitive. On success, allies up to your ranks in Leadership gain momentum for an additional Strike against the target. On failure, only one ally gains momentum."},{"id":"authority","name":"Authority","prerequisite":"Title granting you command of 5+ people","activation":"always","description":"Double the range of Leader talents that affect allies, and double the number of allies affected."}]},{"id":"politico","name":"Politico","description":"With a penchant for theatrics, chase favor and prestige while subtly undermining enemies","talents":[{"id":"cutthroat_tactics","name":"Cutthroat Tactics","prerequisite":"Deception 1+","activation":"special","description":"Your ally can raise the stakes instead of rolling your command die; if they roll complication, you recover 1 focus."},{"id":"tactical_ploy","name":"Tactical Ploy","prerequisite":"none","activation":"1_action","description":"Test Deception vs. Cognitive to make your target lose one action and gain a disadvantage on their next cognitive or spiritual test."},{"id":"rumormonger","name":"Rumormonger","prerequisite":"A patron","activation":"special","description":"Gain Scandal expertise. Spend 2 focus to add opportunity when you make a test to spread misinformation or gather rumors."},{"id":"well_dressed_leader","name":"Well Dressed","prerequisite":"none","activation":"always","description":"Gain Fashion expertise. While wearing Presentable armor or fashionable clothing, gain an advantage on your first Deception, Leadership, or Persuasion test."},{"id":"baleful_leader","name":"Baleful","prerequisite":"none","activation":"always","description":"To resist your influence, a character must spend additional focus equal to your tier."},{"id":"set_at_odds","name":"Set at Odds","prerequisite":"Leadership 3+","activation":"special","description":"Spend focus equal to the number of targets you want to seed division among. Test Leadership vs. their highest Spiritual to make them hostile to each other."},{"id":"shrewd_command","name":"Shrewd Command","prerequisite":"Leadership 2+","activation":"special","description":"Increase the size of your command die. Spend 1 focus to add your command die to your Deception, Insight, or Leadership d20 roll."},{"id":"grand_deception","name":"Grand Deception","prerequisite":"Deception 3+","activation":"3_actions","description":"Spend 3 focus to test Deception (DC 15) to reveal a ruse that changes a detail."}]}]},{"id":"scholar","name":"Scholar","description":"Creativity, acumen, and patience are hallmarks of legendary Scholars","keyAttribute":"intellect","startingSkill":"lore","primarySkills":["lore","deduction","crafting","medicine"],"keyTalent":{"id":"erudition","name":"Erudition","prerequisite":"none","activation":"always","description":"Choose one cultural or utility expertise you don't already have, and choose two different cognitive skills that aren't surge skills. When you make a test, you count as having the chosen expertise and one additional rank of each chosen skill. After a long rest with library access, you can reassign these."},"specialties":[{"id":"artifabrian","name":"Artifabrian","description":"Combining science, engineering, and artistry, construct fabrials that perform precise functions","talents":[{"id":"efficient_engineer","name":"Efficient Engineer","prerequisite":"Crafting 1+","activation":"always","description":"Gain expertise in Armor Crafting, Equipment Crafting, or Weapon Crafting, and gain a fabrial. When crafting, your Opportunity range expands by 2 and your material cost is halved."},{"id":"prized_acquisition","name":"Prized Acquisition","prerequisite":"none","activation":"always","description":"Gain Fabrial Crafting expertise. Gain a special gem you can immediately use to craft a fabrial of your tier. You can reuse this gem for new fabrials."},{"id":"deep_study","name":"Deep Study","prerequisite":"Efficient Engineer","activation":"always","description":"Erudition grants you an additional cultural or utility expertise and two additional non-surge cognitive skills."},{"id":"inventive_design","name":"Inventive Design","prerequisite":"Crafting 2+, Prized Acquisition","activation":"always","description":"Your Prized Acquisition fabrial can have an effect 1 tier higher than the tier you're currently crafting."},{"id":"fine_handiwork","name":"Fine Handiwork","prerequisite":"Efficient Engineer","activation":"always","description":"When crafting, advanced features cost one upgrade instead of two."},{"id":"overcharge","name":"Overcharge","prerequisite":"Crafting 3+, Prized Acquisition","activation":"special","description":"Once per turn, you can raise the stakes on a fabrial attack, then spend opportunity to Strike with that fabrial as free action."},{"id":"experimental_tinkering","name":"Experimental Tinkering","prerequisite":"Fine Handiwork","activation":"always","description":"When crafting, your Opportunity range expands by 1 and your crafting time is halved. During a long rest, you can reconfigure your Prized Acquisition fabrial to a different fabrial."},{"id":"overwhelm_with_details","name":"Overwhelm with Details","prerequisite":"Lore 3+, Experimental Tinkering","activation":"special","description":"Spend 2 focus to use your Lore modifier on another cognitive or spiritual test."}]},{"id":"strategist","name":"Strategist","description":"Always three steps ahead, knowing timing is everything","talents":[{"id":"strategize","name":"Strategize","prerequisite":"none","activation":"1_action","description":"Test Deduction vs. Cognitive to learn one of target's defenses, health, focus, or Investiture. On opportunity, learn all."},{"id":"mind_and_body","name":"Mind and Body","prerequisite":"none","activation":"always","description":"Choose a physical skill. When you make a test with that skill, you can use your Intellect modifier instead of the usual attribute."},{"id":"know_your_moment","name":"Know Your Moment","prerequisite":"Lore 2+","activation":"always","description":"Gain +2 to initiative. When you succeed on Strategize, your target gains a disadvantage on their next test."},{"id":"deep_contemplation","name":"Deep Contemplation","prerequisite":"Deduction 2+","activation":"special","description":"Spend 2 focus and 1 minute to remove Confused and Disoriented from you and allies within 10 feet, and they gain momentum for their next cognitive test."},{"id":"turning_point","name":"Turning Point","prerequisite":"Deduction 3+","activation":"reaction","description":"After an ally within 20 feet fails a test, spend 3 focus to let them reroll, adding your Intellect modifier to one die."},{"id":"read_the_field","name":"Read the Field","prerequisite":"Lore 3+","activation":"2_actions","description":"Spend 2 focus to test Lore vs. Cognitive of all enemies within 30 feet. Those who fail are Surprised and grant advantage to your allies."}]},{"id":"surgeon","name":"Surgeon","description":"Apply their knowledge and empathy to heal the unwell and save lives","talents":[{"id":"field_medicine","name":"Field Medicine","prerequisite":"none","activation":"1_action","description":"Test Medicine (DC 10) to let an ally roll their recovery die and recover that much health. On opportunity, they also recover focus equal to your Intellect modifier."},{"id":"emotional_intelligence","name":"Emotional Intelligence","prerequisite":"none","activation":"always","description":"Choose Insight or Persuasion. When you make a test with that skill, you can use your Intellect modifier instead of the usual attribute."},{"id":"ongoing_care","name":"Ongoing Care","prerequisite":"Medicine 2+, Field Medicine","activation":"special","description":"When you use Field Medicine, spend 1 focus to also remove one condition or reduce injury level by 1."},{"id":"medical_expertise","name":"Medical Expertise","prerequisite":"Medicine 2+","activation":"always","description":"Gain three medical utility expertises. Your Medicine tests to treat injuries, diseases, or poisons expand Opportunity range by 2."},{"id":"resuscitate","name":"Resuscitate","prerequisite":"Medicine 3+, Ongoing Care","activation":"2_actions","description":"Spend 3 focus to revive an Unconscious ally. They recover health equal to their recovery die + your Intellect modifier."},{"id":"miraculous_recovery","name":"Miraculous Recovery","prerequisite":"Medicine 3+, Medical Expertise","activation":"special","description":"When you treat someone during a long rest, they recover an additional recovery die of health and remove one injury level."}]}]},{"id":"warrior","name":"Warrior","description":"Roshar is a world riven by conflict, and many of its people follow the path of the Warrior","keyAttribute":"strength","startingSkill":"athletics","primarySkills":["athletics","heavy_weaponry","light_weaponry","intimidation","leadership"],"keyTalent":{"id":"vigilant_stance","name":"Vigilant Stance","prerequisite":"none","activation":"free_action","description":"You learn to use stances. Enter Vigilant Stance: While in this stance, reduce the focus cost of your Dodge and Reactive Strike reactions by 1. Additionally, you can enter another stance you know as free action."},"specialties":[{"id":"duelist","name":"Duelist","description":"In the inner circles of the elite, contend for glory and political sway","talents":[{"id":"practiced_kata","name":"Practiced Kata","prerequisite":"none","activation":"always","description":"You can now use stances in conversations and endeavors, and unless Surprised, you can start each scene in Vigilant Stance. Spend 1 focus to enter a stance mid-conversation or mid-endeavor."},{"id":"flamestance","name":"Flamestance","prerequisite":"Intimidation 1+","activation":"1_action","description":"Enter Flamestance: You gain an advantage on Intimidation, and when only one enemy is in reach and no allies are, gain momentum to attack or Gain Advantage."},{"id":"ironstance","name":"Ironstance","prerequisite":"Athletics 2+, Practiced Kata","activation":"1_action","description":"Enter Ironstance: You gain an advantage on Insight, and when you're grazed or missed, you can make a Reactive Strike against your attacker."},{"id":"signature_weapon","name":"Signature Weapon","prerequisite":"Flamestance","activation":"always","description":"Gain a weapon expertise. Choose one of your weapon expertises, expanding its Opportunity range by 1 (2 at tier 3)."},{"id":"surefooted_warrior","name":"Surefooted","prerequisite":"Ironstance","activation":"always","description":"Your movement increases by 10. Reduce damage from falling and dangerous terrain by twice your tier."},{"id":"feinting_strike","name":"Feinting Strike","prerequisite":"Intimidation 2+, Flamestance","activation":"2_actions","description":"Spend 2 focus to make a melee weapon attack vs. Cognitive. On a hit, your target loses one action and loses focus equal to your ranks in Intimidation. On a graze, they lose half as much focus."},{"id":"vinestance","name":"Vinestance","prerequisite":"Athletics 3+, Feinting Strike","activation":"1_action","description":"Enter Vinestance: Your Physical and Cognitive defenses increase by 1. After you're hit or grazed in melee, spend momentum to test Athletics vs. Cognitive to make attacker lose 1d4 focus and be pushed."},{"id":"wits_end","name":"Wit's End","prerequisite":"Intimidation 3+","activation":"1_action","description":"Spend 1 focus to move half your movement then make a melee weapon attack vs. Cognitive of a target who has 0 focus. This attack ignores deflect, deals an extra 4d6 damage, and can't graze."}]},{"id":"shardbearer","name":"Shardbearer","description":"Wield Shardblades and Shardplate to dominate the battlefield with mythic might","talents":[{"id":"shard_training","name":"Shard Training","prerequisite":"Access to a Shardblade and Shardplate","activation":"always","description":"Gain Shardplate expertise, and gain either Grandbow, Shardblade, or Warhammer expertise. Your Shardplate has 2 additional charges. Your Shardblade Strikes graze additional targets up to your ranks in the skill used."},{"id":"stonestance","name":"Stonestance","prerequisite":"none","activation":"1_action","description":"Enter Stonestance: Your deflect increases by 1, and enemies within your reach must spend an additional action to attack your allies who aren't in Stonestance."},{"id":"windstance","name":"Windstance","prerequisite":"Perception 1+","activation":"1_action","description":"Enter Windstance: Gain an advantage on Agility. While you can reach multiple enemies, use free action to gain momentum to Disengage or attack."},{"id":"mighty_warrior","name":"Mighty","prerequisite":"none","activation":"always","description":"When you hit with a weapon or unarmed attack, for each action spent, deal extra damage equal to 1 + your tier."},{"id":"shattering_blow","name":"Shattering Blow","prerequisite":"Perception 2+","activation":"special","description":"When you hit with a melee attack, spend 2 focus to deplete 1 charge from their armor, and each target you damage is pushed 5 feet."},{"id":"bloodstance","name":"Bloodstance","prerequisite":"Athletics 2+","activation":"1_action","description":"Enter Bloodstance: Your Opportunity range for attacks and physical tests expands by 2, but your Physical, Cognitive, and Spiritual defenses decrease by 2."},{"id":"precise_parry","name":"Precise Parry","prerequisite":"Perception 3+","activation":"reaction","description":"Before being hit in melee, spend 1 focus to attempt to turn it into a graze. Test Athletics (unarmed) or Light/Heavy Weaponry (armed) vs. triggering attack."},{"id":"meteoric_leap","name":"Meteoric Leap","prerequisite":"Athletics 3+","activation":"2_actions","description":"Spend 2 focus to leap a quarter of your movement and make unarmed attack vs. Physical of multiple targets, doubling damage and knocking weaker targets Prone. Gain an advantage in Shardplate."}]},{"id":"soldier","name":"Soldier","description":"The most common of fighting forces, mastering tactics to fight effectively in units","talents":[{"id":"cautious_advance","name":"Cautious Advance","prerequisite":"Discipline 1+","activation":"1_action","description":"Move up to half your movement, ignoring difficult terrain, then gain momentum to Brace or Gain Advantage."},{"id":"combat_training_warrior","name":"Combat Training","prerequisite":"none","activation":"always","description":"Gain expertise in a weapon, armor, and Military Life. Once per round, graze without spending focus."},{"id":"defensive_position","name":"Defensive Position","prerequisite":"Athletics 2+","activation":"always","description":"The Brace action adds two disadvantages to attacks against you, instead of one, and allies can Brace behind your shield."},{"id":"devastating_blow","name":"Devastating Blow","prerequisite":"Athletics 3+","activation":"1_action","description":"Make a melee weapon attack vs. Physical, rolling an extra 2d8 damage."},{"id":"formation_drills","name":"Formation Drills","prerequisite":"Discipline 2+","activation":"always","description":"Allies within 10 feet who Brace gain the benefits of your Defensive Position."},{"id":"hardy_warrior","name":"Hardy","prerequisite":"none","activation":"always","description":"Gain +1 max health per level (including previous levels)."},{"id":"wary","name":"Wary","prerequisite":"Discipline 3+","activation":"always","description":"You can't be Surprised while you have focus. When you lose focus involuntarily, reduce the amount lost by your ranks in Discipline."},{"id":"swift_strikes_warrior","name":"Swift Strikes","prerequisite":"none","activation":"special","description":"Spend 1 focus to make a second Strike with the same weapon."}]}]}],"radiantOrders":[{"id":"windrunner","name":"Windrunners","description":"Protect those who cannot protect themselves","oaths":["Life before death","Strength before weakness","Journey before destination","I will protect those who cannot protect themselves","I will protect even those I hate, even if the one I hate most is myself"],"surges":["gravitation","adhesion"],"sprenType":"Honorspren","attributes":["strength","willpower"],"keyTalent":{"name":"First Ideal (Windrunner Key)","description":"Begin bonding an honorspren and gain Investiture"},"specialties":[{"name":"Honorspren Bond","description":"Talents unique to your bond with an honorspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Windrunner Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Adhesion and Gravitation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of windspren as Radiant Shardplate."},{"id":"reverse_lashing","name":"Reverse Lashing","prerequisite":"First Ideal","activation":"1_action","description":"Infuse yourself or an object with a mix of Adhesion and Gravitation, giving it a weak gravitational pull on specific objects within your gravitation rate distance."},{"id":"invested","name":"Invested","prerequisite":"Reverse Lashing","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges and the ability to Breathe Stormlight, Enhance, and Regenerate. You can have a maximum number of squires up to twice your level."}]}]},{"id":"skybreaker","name":"Skybreakers","description":"Enforce the law and strive for justice","oaths":["Life before death","Strength before weakness","Journey before destination","I will follow the law","I am the law"],"surges":["gravitation","division"],"sprenType":"Highspren","attributes":["awareness","presence"],"keyTalent":{"name":"First Ideal (Skybreaker Key)","description":"Begin bonding a highspren and gain Investiture"},"specialties":[{"name":"Highspren Bond","description":"Talents unique to your bond with a highspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Skybreaker Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Division and Gravitation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of luckspren as Radiant Shardplate."},{"id":"soaring_destruction","name":"Soaring Destruction","prerequisite":"First Ideal","activation":"special","description":"After you Move while maintaining a Basic Lashing on yourself, spend 1 focus to gain an action which can be used only for Division or one of its talents."},{"id":"invested","name":"Invested","prerequisite":"Soaring Destruction","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges and the ability to Breathe Stormlight, Enhance, and Regenerate. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"dustbringer","name":"Dustbringers","description":"Great power requires strong discipline","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek mastery","I will use my power wisely"],"surges":["division","abrasion"],"sprenType":"Ashspren","attributes":["intellect","willpower"],"keyTalent":{"name":"First Ideal (Dustbringer Key)","description":"Begin bonding an ashspren and gain Investiture"},"specialties":[{"name":"Ashspren Bond","description":"Talents unique to your bond with an ashspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Dustbringer Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Abrasion and Division surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of flamespren as Radiant Shardplate."},{"id":"searing_dust_storm","name":"Searing Dust Storm","prerequisite":"First Ideal","activation":"special","description":"Spend Investiture to kick up an obscuring cloud of dust as you Move. Enemies in this cloud take extra damage equal to your ranks in Discipline."},{"id":"invested","name":"Invested","prerequisite":"Searing Dust Storm","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"edgedancer","name":"Edgedancers","description":"Remember and serve those who others forget","oaths":["Life before death","Strength before weakness","Journey before destination","I will remember those who have been forgotten","I will listen to those who have been ignored"],"surges":["abrasion","progression"],"sprenType":"Cultivationspren","attributes":["speed","awareness"],"keyTalent":{"name":"First Ideal (Edgedancer Key)","description":"Begin bonding a cultivationspren and gain Investiture"},"specialties":[{"name":"Cultivationspren Bond","description":"Talents unique to your bond with a cultivationspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Edgedancer Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Abrasion and Progression surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of lifespren as Radiant Shardplate."},{"id":"edgedancers_grace","name":"Edgedancer's Grace","prerequisite":"First Ideal","activation":"special","description":"After you start your turn with 1 Investiture or more, you gain an additional action, which you can use only to Avoid Danger or Dodge. If you use the Dodge reaction in this way, ignore its focus cost."},{"id":"invested","name":"Invested","prerequisite":"Edgedancer's Grace","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"truthwatcher","name":"Truthwatchers","description":"Search for fundamental truth and share it","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek truth","I will share truth"],"surges":["progression","illumination"],"sprenType":"Mistspren","attributes":["intellect","awareness"],"keyTalent":{"name":"First Ideal (Truthwatcher Key)","description":"Begin bonding a mistspren and gain Investiture"},"specialties":[{"name":"Mistspren Bond","description":"Talents unique to your bond with a mistspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Truthwatcher Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Progression and Illumination surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of gloryspren as Radiant Shardplate."},{"id":"healing_burst","name":"Healing Burst","prerequisite":"First Ideal","activation":"1_action","description":"Spend Investiture to create a burst of healing light. Allies within your Progression range can spend a Recovery Die to heal."},{"id":"invested","name":"Invested","prerequisite":"Healing Burst","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"lightweaver","name":"Lightweavers","description":"Separate truth from lies","oaths":["Life before death","Strength before weakness","Journey before destination","I will speak my truth","I will accept who I am"],"surges":["illumination","transformation"],"sprenType":"Cryptic","attributes":["presence","intellect"],"keyTalent":{"name":"First Ideal (Lightweaver Key)","description":"Begin bonding a cryptic and gain Investiture"},"specialties":[{"name":"Cryptic Bond","description":"Talents unique to your bond with a cryptic companion","talents":[{"id":"first_ideal","name":"First Ideal (Lightweaver Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Illumination and Transformation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of creationspren as Radiant Shardplate."},{"id":"lightweaving","name":"Lightweaving","prerequisite":"First Ideal","activation":"1_action","description":"Create illusions of light and sound. Spend Investiture to create increasingly complex and believable illusions."},{"id":"invested","name":"Invested","prerequisite":"Lightweaving","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"elsecaller","name":"Elsecallers","description":"Strive to reach your true potential","oaths":["Life before death","Strength before weakness","Journey before destination","I will reach my potential","I will seek self-mastery"],"surges":["transformation","transportation"],"sprenType":"Inkspren","attributes":["intellect","willpower"],"keyTalent":{"name":"First Ideal (Elsecaller Key)","description":"Begin bonding an inkspren and gain Investiture"},"specialties":[{"name":"Inkspren Bond","description":"Talents unique to your bond with an inkspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Elsecaller Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Transformation and Transportation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of logicspren as Radiant Shardplate."},{"id":"elsecalling","name":"Elsecalling","prerequisite":"First Ideal","activation":"1_action","description":"Use Transportation to teleport yourself and others. Spend Investiture to travel greater distances or bring more companions."},{"id":"invested","name":"Invested","prerequisite":"Elsecalling","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"willshaper","name":"Willshapers","description":"Seek freedom and choice for all peoples","oaths":["Life before death","Strength before weakness","Journey before destination","I will seek freedom for those in bondage","I will give others freedom to choose"],"surges":["transportation","cohesion"],"sprenType":"Lightspren","attributes":["presence","awareness"],"keyTalent":{"name":"First Ideal (Willshaper Key)","description":"Begin bonding a lightspren and gain Investiture"},"specialties":[{"name":"Lightspren Bond","description":"Talents unique to your bond with a lightspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Willshaper Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Cohesion and Transportation surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of joyspren as Radiant Shardplate."},{"id":"stone_shaping","name":"Stone Shaping","prerequisite":"First Ideal","activation":"1_action","description":"Use Cohesion to shape and manipulate stone and earth. Spend Investiture to create walls, tunnels, or other structures."},{"id":"invested","name":"Invested","prerequisite":"Stone Shaping","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]},{"id":"stoneward","name":"Stonewards","description":"Be the support on which others can depend","oaths":["Life before death","Strength before weakness","Journey before destination","I will be there when I'm needed","I will stand firm"],"surges":["cohesion","tension"],"sprenType":"Peakspren","attributes":["strength","willpower"],"keyTalent":{"name":"First Ideal (Stoneward Key)","description":"Begin bonding a peakspren and gain Investiture"},"specialties":[{"name":"Peakspren Bond","description":"Talents unique to your bond with a peakspren companion","talents":[{"id":"first_ideal","name":"First Ideal (Stoneward Key)","prerequisite":"none","activation":"special","description":"Gain Investiture score and the Breathe Stormlight, Enhance, and Regenerate actions. When you complete the goal 'Speak the First Ideal,' you become Empowered and gain access to Cohesion and Tension surges."},{"id":"second_ideal","name":"Second Ideal","prerequisite":"First Ideal","activation":"special","description":"Gain the goal 'Speak the Second Ideal.' After completing it, you become Empowered and can use Enhance as a free action without spending Investiture."},{"id":"third_ideal","name":"Third Ideal","prerequisite":"Second Ideal","activation":"special","description":"Gain the goal 'Speak the Third Ideal.' After completing it, you become Empowered and can summon your spren as a Radiant Shardblade."},{"id":"fourth_ideal","name":"Fourth Ideal","prerequisite":"Third Ideal","activation":"special","description":"Gain the goal 'Speak the Fourth Ideal.' After completing it, you become Empowered and can call a swarm of gloryspren as Radiant Shardplate."},{"id":"stone_stance","name":"Stone Stance","prerequisite":"First Ideal","activation":"free_action","description":"Use Cohesion to root yourself in place. While in Stone Stance, you cannot be moved against your will and gain bonus to resist being knocked down."},{"id":"invested","name":"Invested","prerequisite":"Stone Stance","activation":"always","description":"Your maximum Investiture increases by a number equal to your tier. When your tier increases by 1, your maximum Investiture does as well."},{"id":"wound_regeneration","name":"Wound Regeneration","prerequisite":"Invested","activation":"free_action","description":"When you use Regenerate, you can spend 2 Investiture to recover from a temporary injury, or spend 3 Investiture to recover from a permanent one."},{"id":"deepened_bond","name":"Deepened Bond","prerequisite":"Third Ideal","activation":"always","description":"Your spren bond range increases from 30 feet to 100 feet. Additionally, when you spend focus to give your spren a task, it costs you 1 fewer focus (to a minimum cost of 1)."},{"id":"take_squire","name":"Take Squire","prerequisite":"Third Ideal","activation":"special","description":"After a long rest, choose willing companions to take as your squires, granting them your surges. You can have a maximum number of squires equal to your current Ideal."}]}]}],"advancement":{"levelProgression":[{"level":1,"tier":1,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":2,"tier":1,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":3,"tier":1,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":4,"tier":2,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":5,"tier":2,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":6,"tier":2,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":7,"tier":3,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0},{"level":8,"tier":3,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":0},{"level":9,"tier":3,"talentPoints":1,"skillRankIncreases":1,"attributeIncreases":1},{"level":10,"tier":3,"talentPoints":1,"skillRankIncreases":2,"attributeIncreases":0}]},"ancestries":["Human","Singer"],"cultures":["Alethi","Azish","Veden","Thaylen","Kharbranthian","Unkalaki","Listener","Wayfarer","High Society","Military Life"],"weapons":{"light":[{"id":"javelin","name":"Javelin","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Thrown [30/120]","Indirect"],"weight":2,"price":20},{"id":"knife","name":"Knife","skill":"light_weaponry","damage":"1d4","damageType":"keen","range":"Melee","traits":["Discreet","Offhand","Thrown [20/60]"],"weight":1,"price":8},{"id":"mace","name":"Mace","skill":"light_weaponry","damage":"1d6","damageType":"impact","range":"Melee","traits":["Momentum"],"weight":3,"price":20},{"id":"rapier","name":"Rapier","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Quickdraw","Defensive"],"weight":2,"price":100},{"id":"shortspear","name":"Shortspear","skill":"light_weaponry","damage":"1d8","damageType":"keen","range":"Melee","traits":["Two-Handed","Unique: loses Two-Handed trait"],"weight":3,"price":10},{"id":"sidesword","name":"Sidesword","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Quickdraw","Offhand"],"weight":2,"price":40},{"id":"staff","name":"Staff","skill":"light_weaponry","damage":"1d6","damageType":"impact","range":"Melee","traits":["Discreet","Two-Handed","Defensive"],"weight":4,"price":1},{"id":"shortbow","name":"Shortbow","skill":"light_weaponry","damage":"1d6","damageType":"keen","range":"Ranged [80/320]","traits":["Two-Handed","Quickdraw"],"weight":2,"price":80},{"id":"sling","name":"Sling","skill":"light_weaponry","damage":"1d4","damageType":"impact","range":"Ranged [30/120]","traits":["Discreet","Indirect"],"weight":1,"price":2}],"heavy":[{"id":"axe","name":"Axe","skill":"heavy_weaponry","damage":"1d6","damageType":"keen","range":"Melee","traits":["Thrown [20/60]","Offhand"],"weight":2,"price":20},{"id":"greatsword","name":"Greatsword","skill":"heavy_weaponry","damage":"1d10","damageType":"keen","range":"Melee","traits":["Two-Handed","Deadly"],"weight":7,"price":200},{"id":"hammer","name":"Hammer","skill":"heavy_weaponry","damage":"1d10","damageType":"impact","range":"Melee","traits":["Two-Handed","Momentum"],"weight":8,"price":40},{"id":"longspear","name":"Longspear","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Melee [+5]","traits":["Two-Handed","Defensive"],"weight":9,"price":15},{"id":"longsword","name":"Longsword","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Melee","traits":["Quickdraw","Two-Handed","Unique: loses Two-Handed trait"],"weight":3,"price":60},{"id":"poleaxe","name":"Poleaxe","skill":"heavy_weaponry","damage":"1d10","damageType":"keen","range":"Melee","traits":["Two-Handed","Unique: Melee [+5]"],"weight":5,"price":40},{"id":"shield","name":"Shield","skill":"heavy_weaponry","damage":"1d4","damageType":"impact","range":"Melee","traits":["Defensive","Offhand"],"weight":2,"price":10},{"id":"crossbow","name":"Crossbow","skill":"heavy_weaponry","damage":"1d8","damageType":"keen","range":"Ranged [100/400]","traits":["Loaded [1]","Two-Handed","Deadly"],"weight":7,"price":200},{"id":"longbow","name":"Longbow","skill":"heavy_weaponry","damage":"1d6","damageType":"keen","range":"Ranged [150/600]","traits":["Two-Handed","Indirect"],"weight":3,"price":100}],"special":[{"id":"unarmed","name":"Unarmed Attack","skill":"athletics","damage":"Variable","damageType":"impact","range":"Melee","traits":["Always Available","Momentum","Offhand"],"weight":0,"price":0},{"id":"improvised","name":"Improvised Weapon","skill":"variable","damage":"Variable","damageType":"variable","range":"Variable","traits":["Fragile"],"weight":0,"price":0}]},"armor":[{"id":"uniform","name":"Uniform","deflect":0,"traits":["Presentable"],"expertTraits":[],"weight":5,"price":40,"strengthRequired":0},{"id":"leather","name":"Leather","deflect":1,"traits":[],"expertTraits":["Presentable"],"weight":10,"price":60,"strengthRequired":0},{"id":"chain","name":"Chain","deflect":2,"traits":["Cumbersome [3]"],"expertTraits":["Loses Cumbersome"],"weight":25,"price":80,"strengthRequired":3},{"id":"breastplate","name":"Breastplate","deflect":2,"traits":["Cumbersome [3]"],"expertTraits":["Presentable"],"weight":30,"price":120,"strengthRequired":3},{"id":"half_plate","name":"Half Plate","deflect":3,"traits":["Cumbersome [4]"],"expertTraits":["Cumbersome [3] instead"],"weight":40,"price":400,"strengthRequired":4},{"id":"full_plate","name":"Full Plate","deflect":4,"traits":["Cumbersome [5]"],"expertTraits":[],"weight":55,"price":1600,"strengthRequired":5}],"currency":{"denominations":[{"id":"chip","name":"Chip","value":0.05},{"id":"mark","name":"Mark","value":1},{"id":"broam","name":"Broam","value":20}]},"conditions":[{"id":"blinded","name":"Blinded","description":"Cannot see. Attacks against you gain advantage, your attacks gain disadvantage."},{"id":"deafened","name":"Deafened","description":"Cannot hear. Disadvantage on Perception tests that rely on hearing."},{"id":"frightened","name":"Frightened","description":"Disadvantage on attacks and tests while source of fear is in line of sight."},{"id":"immobilized","name":"Immobilized","description":"Speed becomes 0. Cannot Move or use movement."},{"id":"prone","name":"Prone","description":"Melee attacks against you gain advantage. Ranged attacks gain disadvantage. Moving requires half movement to stand."},{"id":"restrained","name":"Restrained","description":"Speed becomes 0. Attacks gain disadvantage. Attacks against you gain advantage."},{"id":"slowed","name":"Slowed","description":"Movement is halved."},{"id":"stunned","name":"Stunned","description":"Cannot take actions or reactions. Attacks against you gain advantage."},{"id":"unconscious","name":"Unconscious","description":"Cannot take actions. Drop items. Attacks against you gain advantage and auto-crit within 5 feet."}]};

        const app = {
            rules: null,
            characters: [],
            currentCharacter: null,

            init: async function() {
                await this.loadRules();
                this.loadFromLocalStorage();
                this.renderCharacterList();
                
                if (this.characters.length === 0) {
                    this.createNewCharacter();
                } else {
                    this.loadCharacter(this.characters[0].id);
                }
            },

            loadRules: async function() {
                // Load embedded rules (single source of truth)
                this.rules = COSMERE_RULES;
                console.log('Rules loaded:', this.rules);
            },

            reloadRules: async function() {
                // Rules are embedded - to update, edit cosmere-rules.json and run: python sync_rules.py
                alert('Rules are embedded in this file.\n\nTo update:\n1. Edit cosmere-rules.json\n2. Run: python sync_rules.py\n3. Reload this page');
            },

            createNewCharacter: function() {
                const newChar = {
                    id: Date.now().toString(),
                    name: 'New Character',
                    playerName: '',
                    ancestry: this.rules.ancestries[0],
                    culture: this.rules.cultures[0],
                    attributes: {
                        strength: 2,
                        speed: 2,
                        intellect: 2,
                        willpower: 2,
                        awareness: 2,
                        presence: 2
                    },
                    skills: {},
                    currentHealth: 16,
                    currentFocus: 8,
                    currentInvestiture: 4,
                    deflect: 0,
                    heroicPath: null,
                    radiantOrder: null,
                    pathProgression: [],
                    paths: [], // New multi-path system
                    talents: [],
                    radiantIdeals: [],
                    talentPointsSpent: 0,
                    talentPointsAvailable: 2,
                    expertises: [],
                    purpose: '',
                    obstacle: '',
                    notes: '',
                    // Equipment & Combat
                    weapons: [],
                    equippedArmor: null,
                    inventory: [],
                    currency: {chips: 0, marks: 0, broams: 0},
                    // Injuries & Conditions
                    injuries: {temporary: [], permanent: []},
                    conditions: [],
                    // Connections
                    connections: [],
                    // Character Details
                    characterDetails: {
                        age: '',
                        gender: '',
                        height: '',
                        weight: '',
                        appearance: '',
                        backstory: ''
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Initialize all skills to rank 0
                this.rules.skills.list.forEach(skill => {
                    newChar.skills[skill.id] = 0;
                });

                this.characters.push(newChar);
                this.loadCharacter(newChar.id);
                this.saveToLocalStorage();
            },

            loadCharacter: function(charId) {
                this.currentCharacter = this.characters.find(c => c.id === charId);
                if (this.currentCharacter) {
                    this.renderCharacterSheet();
                    this.renderCharacterList();
                    document.getElementById('characterSheetSection').classList.remove('hidden');
                }
            },

            renderCharacterList: function() {
                const container = document.getElementById('characterListItems');
                container.innerHTML = '';

                this.characters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    if (this.currentCharacter && char.id === this.currentCharacter.id) {
                        card.classList.add('active');
                    }
                    card.onclick = () => this.loadCharacter(char.id);
                    
                    card.innerHTML = `
                        <h3>${char.name || 'Unnamed Character'}</h3>
                        <p>Level ${char.level} ${char.heroicPath || 'No Path'}</p>
                        <p>${char.ancestry} ‚Ä¢ ${char.culture}</p>
                    `;
                    
                    container.appendChild(card);
                });
            },

            renderCharacterSheet: function() {
                const char = this.currentCharacter;
                
                // Basic info
                document.getElementById('characterName').value = char.name || '';
                document.getElementById('playerName').value = char.playerName || '';
                const totalLevel = this.getTotalLevel();
                document.getElementById('characterLevel').textContent = totalLevel;
                
                // Tier
                const levelData = this.rules.advancement.levelProgression.find(l => l.level === totalLevel);
                const tierNames = ['Local Heroes', 'Regional Heroes', 'World Shapers'];
                const tierIndex = totalLevel <= 3 ? 0 : (totalLevel <= 6 ? 1 : 2);
                document.getElementById('characterTier').textContent = tierNames[tierIndex];
                
                // Ancestry dropdown
                const ancestrySelect = document.getElementById('ancestry');
                ancestrySelect.innerHTML = this.rules.ancestries.map(a => 
                    `<option value="${a}" ${char.ancestry === a ? 'selected' : ''}>${a}</option>`
                ).join('');
                
                // Culture dropdown
                const cultureSelect = document.getElementById('culture');
                cultureSelect.innerHTML = this.rules.cultures.map(c => 
                    `<option value="${c}" ${char.culture === c ? 'selected' : ''}>${c}</option>`
                ).join('');
                
                // Attributes
                document.getElementById('strength').value = char.attributes.strength;
                document.getElementById('speed').value = char.attributes.speed;
                document.getElementById('intellect').value = char.attributes.intellect;
                document.getElementById('willpower').value = char.attributes.willpower;
                document.getElementById('awareness').value = char.attributes.awareness;
                document.getElementById('presence').value = char.attributes.presence;
                
                // Skills
                this.renderSkills('physical');
                this.renderSkills('cognitive');
                this.renderSkills('spiritual');
                
                // Resources
                document.getElementById('currentHealth').value = char.currentHealth;
                document.getElementById('currentFocus').value = char.currentFocus;
                document.getElementById('currentInvestiture').value = char.currentInvestiture;
                document.getElementById('deflect').value = char.deflect;
                
                // Purpose and Obstacle
                document.getElementById('purpose').value = char.purpose || '';
                document.getElementById('obstacle').value = char.obstacle || '';
                
                // Notes
                document.getElementById('notes').value = char.notes || '';
                
                // Paths and Talents
                this.renderPathsAndTalents();
                
                // Expertises
                this.renderExpertises();
                
                // Equipment
                this.renderWeapons();
                this.renderArmorOptions();
                if (char.equippedArmor) {
                    document.getElementById('equippedArmor').value = char.equippedArmor;
                    this.equipArmor(char.equippedArmor);
                }
                this.renderInventory();
                
                // Currency
                document.getElementById('chips').value = char.currency?.chips || 0;
                document.getElementById('marks').value = char.currency?.marks || 0;
                document.getElementById('broams').value = char.currency?.broams || 0;
                this.updateCurrency();
                
                // Injuries & Conditions
                this.renderInjuries();
                this.renderConditions();
                
                // Connections
                this.renderConnections();
                
                // Character Details
                document.getElementById('characterAge').value = char.characterDetails?.age || '';
                document.getElementById('characterGender').value = char.characterDetails?.gender || '';
                document.getElementById('characterHeight').value = char.characterDetails?.height || '';
                document.getElementById('characterWeight').value = char.characterDetails?.weight || '';
                document.getElementById('characterAppearance').value = char.characterDetails?.appearance || '';
                document.getElementById('characterBackstory').value = char.characterDetails?.backstory || '';
                
                // Path Levels Display
                const pathLevelsDisplay = document.getElementById('pathLevelsDisplay');
                if (char.paths && char.paths.length > 0) {
                    const pathLevels = char.paths
                        .filter(p => p.level > 0)
                        .map(p => {
                            const pathData = this.getPathData(p);
                            return `${pathData.name}: Level ${p.level}`;
                        })
                        .join(' | ');
                    pathLevelsDisplay.textContent = pathLevels || 'No path levels yet';
                } else {
                    pathLevelsDisplay.textContent = 'No paths selected';
                }
                
                // Recalculate all derived values
                this.recalculateAll();
            },

            renderSkills: function(category) {
                const container = document.getElementById(`${category}Skills`);
                const skills = this.rules.skills.list.filter(s => s.category === category);
                
                container.innerHTML = skills.map(skill => {
                    const rank = this.currentCharacter.skills[skill.id] || 0;
                    const attr = this.currentCharacter.attributes[skill.attribute] || 0;
                    const modifier = attr + rank;
                    
                    return `
                        <div class="skill-row">
                            <div>
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-attr">(${skill.attribute.toUpperCase().substring(0,3)})</div>
                            </div>
                            <input type="number" class="skill-rank" 
                                   data-skill-id="${skill.id}"
                                   value="${rank}" 
                                   min="0" 
                                   max="${this.rules.skills.maxRanks}"
                                   oninput="app.updateSkill('${skill.id}', this.value)"
                                   title="${skill.description}">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="skill-modifier" title="Modifier = ${skill.attribute.toUpperCase().substring(0,3)} (${attr}) + Rank (${rank})">+${modifier}</div>
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollInline('1d20+${modifier}', '${skill.name} Test')"
                                        title="Roll ${skill.name} test (1d20+${modifier})">üé≤</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateSkill: function(skillId, value) {
                const newValue = parseInt(value) || 0;
                // Enforce maximum rank
                if (newValue > this.rules.skills.maxRanks) {
                    this.currentCharacter.skills[skillId] = this.rules.skills.maxRanks;
                    // Update the input field to reflect the cap
                    const input = document.querySelector(`input.skill-rank[data-skill-id="${skillId}"]`);
                    if (input) {
                        input.value = this.rules.skills.maxRanks;
                    }
                } else {
                    this.currentCharacter.skills[skillId] = newValue;
                }
                this.recalculateAll();
                this.updateCharacter();
            },

            renderPathsAndTalents: function() {
                // Populate dropdown options
                const heroicOptions = document.getElementById('heroicPathOptions');
                const radiantOptions = document.getElementById('radiantOrderOptions');
                
                if (heroicOptions) {
                    heroicOptions.innerHTML = this.rules.heroicPaths.map(p => 
                        `<option value="heroic:${p.id}">${p.name}</option>`
                    ).join('');
                }
                
                if (radiantOptions) {
                    radiantOptions.innerHTML = this.rules.radiantOrders.map(o => 
                        `<option value="radiant:${o.id}">${o.name}</option>`
                    ).join('');
                }

                // Initialize paths array if needed
                if (!this.currentCharacter.paths) {
                    this.currentCharacter.paths = [];
                    // Migrate old heroicPath/radiantOrder if they exist
                    if (this.currentCharacter.heroicPath) {
                        this.currentCharacter.paths.push({type: 'heroic', id: this.currentCharacter.heroicPath});
                    }
                    if (this.currentCharacter.radiantOrder) {
                        this.currentCharacter.paths.push({type: 'radiant', id: this.currentCharacter.radiantOrder});
                    }
                }

                // Render each selected path
                const container = document.getElementById('pathsAndTalentsContainer');
                if (!container) return;
                
                if (this.currentCharacter.paths.length === 0) {
                    container.innerHTML = '<div class="help-text">No paths selected. Use the dropdown below to add a path.</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.paths.map((pathRef, index) => {
                    const pathData = this.getPathData(pathRef);
                    if (!pathData) return '';

                    return this.renderPathWithTalents(pathRef, pathData, index);
                }).join('');
            },

            getPathData: function(pathRef) {
                if (pathRef.type === 'heroic') {
                    return this.rules.heroicPaths.find(p => p.id === pathRef.id);
                } else if (pathRef.type === 'radiant') {
                    return this.rules.radiantOrders.find(o => o.id === pathRef.id);
                }
                return null;
            },

            renderPathWithTalents: function(pathRef, pathData, index) {
                const expandedId = `path-${index}`;
                const isExpanded = this.expandedPaths && this.expandedPaths[expandedId];
                const pathLevel = pathRef.level || 0;

                let html = `
                    <div class="path-section" style="border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <h3 style="margin: 0; color: var(--primary-color);">
                                        ${pathRef.type === 'heroic' ? '‚öîÔ∏è' : '‚ú®'} ${pathData.name}
                                    </h3>
                                    <div style="display: flex; align-items: center; gap: 5px; padding: 4px 10px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                        <button onclick="app.changePathLevel(${index}, -1)" 
                                                style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                                ${pathLevel <= 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚àí</button>
                                        <span style="min-width: 60px; text-align: center;">Level ${pathLevel}</span>
                                        <button onclick="app.changePathLevel(${index}, 1)" 
                                                style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold;"
                                                ${pathLevel >= 10 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>+</button>
                                    </div>
                                </div>
                                <p style="margin: 5px 0; color: var(--text-secondary); font-size: 0.9em;">${pathData.description}</p>
                `;

                if (pathRef.type === 'heroic' && pathData.keyTalent) {
                    html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Key Talent:</strong> ${pathData.keyTalent.name} - ${pathData.keyTalent.description}</div>`;
                }

                if (pathRef.type === 'radiant') {
                    html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Surges:</strong> ${pathData.surges.join(', ')}</div>`;
                    if (pathData.oaths && pathData.oaths.length > 0) {
                        html += `<div style="font-size: 0.85em; margin-top: 5px;"><strong>Ideals:</strong></div>`;
                        html += `<ul style="margin: 5px 0; padding-left: 20px; font-size: 0.85em;">`;
                        pathData.oaths.forEach(oath => {
                            html += `<li style="font-style: italic; margin: 2px 0;">"${oath}"</li>`;
                        });
                        html += `</ul>`;
                    }
                }

                html += `
                            </div>
                            <div style="display: flex; gap: 10px; align-items: start;">
                                ${pathLevel > 0 ? `<button onclick="app.togglePathTalents('${expandedId}')" style="padding: 5px 15px;">
                                    ${isExpanded ? '‚ñº Hide' : '‚ñ∂ Show'} Talents
                                </button>` : ''}
                                <button onclick="app.removePath(${index})" class="danger" style="padding: 5px 10px;">√ó</button>
                            </div>
                        </div>
                `;

                // Show talents if expanded and path has levels
                if (isExpanded && pathData.specialties && pathLevel > 0) {
                    html += this.renderPathTalentsSection(pathData, pathRef.id, pathLevel);
                }

                html += `</div>`;
                return html;
            },

            renderPathTalentsSection: function(pathData, pathId, pathLevel) {
                const selectedCount = this.currentCharacter.talents.filter(t => t.startsWith(pathId + '_')).length;
                const totalAvailable = pathLevel; // Talents available = path level

                let html = `
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="margin-bottom: 10px; font-weight: bold;">
                            Talents Selected: ${selectedCount} / ${totalAvailable}
                        </div>
                `;

                pathData.specialties.forEach(specialty => {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 10px 0 8px 0; color: var(--secondary-color);">${specialty.name}</h4>
                            <p style="margin: 0 0 10px 0; font-size: 0.85em; color: var(--text-secondary);">${specialty.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                    `;

                    specialty.talents.forEach(talent => {
                        const talentId = `${pathId}_${talent.id}`;
                        const isSelected = this.currentCharacter.talents.includes(talentId);
                        const prerequisiteMet = this.checkTalentPrerequisite(talent, pathId);
                        const canSelect = prerequisiteMet || isSelected;

                        const activationIcons = {
                            '1_action': '‚ñ∂',
                            '2_actions': '‚ñ∂‚ñ∂',
                            '3_actions': '‚ñ∂‚ñ∂‚ñ∂',
                            'free_action': '‚óÜ',
                            'reaction': '‚Üª',
                            'special': '‚òÖ',
                            'always': '‚àû'
                        };
                        const activationIcon = activationIcons[talent.activation] || '‚òÖ';

                        html += `
                            <div class="talent-card-inline" 
                                 style="border: 2px solid ${isSelected ? 'var(--success-color)' : (canSelect ? 'var(--border-color)' : '#ccc')};
                                        background: ${isSelected ? '#e8f5e9' : (canSelect ? 'white' : '#f5f5f5')};
                                        padding: 10px;
                                        border-radius: 4px;
                                        font-size: 0.85em;
                                        ${canSelect ? 'cursor: pointer;' : 'opacity: 0.6; cursor: not-allowed;'}"
                                 ${canSelect ? `onclick="app.toggleTalent('${talentId}')"` : ''}>
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${activationIcon} ${talent.name}
                                    ${isSelected ? ' <span style="color: var(--success-color);">‚úì</span>' : ''}
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">
                                    <em>Prerequisite: ${talent.prerequisite}</em>
                                </div>
                                <div style="line-height: 1.3;">
                                    ${talent.description}
                                </div>
                                ${!prerequisiteMet && !isSelected ? 
                                    '<div style="color: #f44336; font-size: 0.9em; margin-top: 4px;">‚ö†Ô∏è Prerequisites not met</div>' 
                                    : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                return html;
            },

            togglePathTalents: function(pathId) {
                if (!this.expandedPaths) this.expandedPaths = {};
                this.expandedPaths[pathId] = !this.expandedPaths[pathId];
                this.renderPathsAndTalents();
            },

            addPath: function(value) {
                if (!value) return;
                
                const [type, id] = value.split(':');
                const pathType = type === 'heroic' ? 'heroic' : 'radiant';
                
                // Check if already added
                const exists = this.currentCharacter.paths.some(p => p.type === pathType && p.id === id);
                if (exists) {
                    alert('This path is already added!');
                    return;
                }
                
                // Check if trying to add a second radiant order
                if (pathType === 'radiant') {
                    const hasRadiant = this.currentCharacter.paths.some(p => p.type === 'radiant');
                    if (hasRadiant) {
                        alert('You can only have one Radiant Order! Remove your current order first.');
                        return;
                    }
                }
                
                const pathRef = {type: pathType, id: id, level: 0};
                this.currentCharacter.paths.push(pathRef);
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            changePathLevel: function(pathIndex, delta) {
                const path = this.currentCharacter.paths[pathIndex];
                if (!path) return;
                
                const newLevel = (path.level || 0) + delta;
                if (newLevel < 0 || newLevel > 10) return;
                
                path.level = newLevel;
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            getTotalLevel: function() {
                if (!this.currentCharacter.paths) return 0;
                return this.currentCharacter.paths.reduce((sum, path) => sum + (path.level || 0), 0);
            },

            removePath: function(index) {
                if (!confirm('Remove this path? All associated talents will be lost.')) return;
                
                const pathRef = this.currentCharacter.paths[index];
                
                // Remove talents associated with this path
                const pathId = pathRef.id;
                this.currentCharacter.talents = this.currentCharacter.talents.filter(t => 
                    !t.startsWith(pathId + '_')
                );
                
                this.currentCharacter.paths.splice(index, 1);
                
                // Full re-render to ensure all derived values update
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            renderExpertises: function() {
                const container = document.getElementById('expertiseList');
                const expertises = this.currentCharacter.expertises || [];
                
                const tags = expertises.map((exp, index) => `
                    <div class="expertise-tag">
                        ${exp}
                        <button class="expertise-remove" onclick="app.removeExpertise(${index})">√ó</button>
                    </div>
                `).join('');
                
                container.innerHTML = tags + `
                    <button class="add-expertise" onclick="app.addExpertise()">+ Add Expertise</button>
                `;
            },

            addExpertise: function() {
                const expertise = prompt('Enter expertise name:');
                if (expertise && expertise.trim()) {
                    this.currentCharacter.expertises.push(expertise.trim());
                    this.renderExpertises();
                    this.updateCharacter();
                }
            },

            removeExpertise: function(index) {
                this.currentCharacter.expertises.splice(index, 1);
                this.renderExpertises();
                this.updateCharacter();
            },

            recalculateAll: function() {
                const char = this.currentCharacter;
                const totalLevel = this.getTotalLevel();
                
                // Defenses
                const physicalDefense = 10 + char.attributes.strength + char.attributes.speed;
                const cognitiveDefense = 10 + char.attributes.intellect + char.attributes.willpower;
                const spiritualDefense = 10 + char.attributes.awareness + char.attributes.presence;
                
                document.getElementById('physicalDefense').textContent = physicalDefense;
                document.getElementById('cognitiveDefense').textContent = cognitiveDefense;
                document.getElementById('spiritualDefense').textContent = spiritualDefense;
                
                // Resources
                const maxHealth = this.rules.resources.health.baseValue + (totalLevel * this.rules.resources.health.perLevel);
                const maxFocus = this.rules.resources.focus.baseValue + (totalLevel * this.rules.resources.focus.perLevel);
                
                document.getElementById('maxHealth').textContent = maxHealth;
                document.getElementById('maxFocus').textContent = maxFocus;
                
                // Investiture (only for Radiants)
                const hasRadiant = char.paths && char.paths.some(p => p.type === 'radiant' && p.level > 0);
                if (hasRadiant) {
                    const maxInvestiture = this.rules.resources.investiture.baseValue + (totalLevel * this.rules.resources.investiture.perLevel);
                    document.getElementById('maxInvestiture').textContent = maxInvestiture;
                } else {
                    document.getElementById('maxInvestiture').textContent = '‚Äî';
                }
                
                // Recovery Die
                let recoveryDie = '1d6';
                for (const [level, die] of Object.entries(this.rules.resources.recoveryDie.progression).reverse()) {
                    if (totalLevel >= parseInt(level)) {
                        recoveryDie = die;
                        break;
                    }
                }
                document.getElementById('recoveryDie').textContent = recoveryDie;
                
                // Movement
                const movement = this.rules.movement.baseSpeed + (char.attributes.speed * 5);
                document.getElementById('movement').textContent = movement + ' ft';
                
                // Senses
                const senses = this.rules.senses.baseRange + (char.attributes.awareness * 10);
                document.getElementById('sensesRange').textContent = senses + ' ft';
                
                // Lifting
                const lifting = this.rules.lifting.baseCapacity + (char.attributes.strength * 50);
                document.getElementById('liftingCapacity').textContent = lifting + ' lbs';
                
                // Update skill modifiers
                this.renderSkills('physical');
                this.renderSkills('cognitive');
                this.renderSkills('spiritual');
                
                // Combat stats
                this.calculateAttackBonuses();
                this.calculateInitiative();
                
                // Update point trackers and validation
                this.updatePointTrackers();
                this.validateCharacter();
            },

            updatePointTrackers: function() {
                const char = this.currentCharacter;
                const totalLevel = this.getTotalLevel();
                
                // Calculate available attribute points (12 base + increases from leveling)
                let totalAttributePoints = this.rules.attributes.startingTotal;
                for (let i = 1; i <= totalLevel; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData && levelData.attributeIncreases) {
                        totalAttributePoints += levelData.attributeIncreases;
                    }
                }
                
                // Calculate used attribute points
                const usedAttributePoints = Object.values(char.attributes).reduce((sum, val) => sum + val, 0);
                const remainingAttributePoints = totalAttributePoints - usedAttributePoints;
                
                // Update attribute tracker UI
                document.getElementById('attributePointsUsed').textContent = usedAttributePoints;
                document.getElementById('attributePointsTotal').textContent = totalAttributePoints;
                document.getElementById('attributePointsRemaining').textContent = remainingAttributePoints + ' remaining';
                
                const attrRemainingElem = document.getElementById('attributePointsRemaining');
                attrRemainingElem.classList.remove('over', 'complete');
                if (remainingAttributePoints < 0) {
                    attrRemainingElem.classList.add('over');
                } else if (remainingAttributePoints === 0) {
                    attrRemainingElem.classList.add('complete');
                }
                
                // Update attribute progress bar
                const attrProgress = Math.min((usedAttributePoints / totalAttributePoints) * 100, 100);
                const attrProgressBar = document.getElementById('attributeProgressBar');
                attrProgressBar.style.width = attrProgress + '%';
                attrProgressBar.classList.remove('over', 'complete');
                if (remainingAttributePoints < 0) {
                    attrProgressBar.classList.add('over');
                } else if (remainingAttributePoints === 0) {
                    attrProgressBar.classList.add('complete');
                }
                
                // Calculate available skill ranks (from leveling)
                let totalSkillRanks = 0;
                for (let i = 1; i <= totalLevel; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData && levelData.skillRankIncreases) {
                        totalSkillRanks += levelData.skillRankIncreases;
                    }
                }
                
                // Calculate used skill ranks
                const usedSkillRanks = Object.values(char.skills).reduce((sum, rank) => sum + rank, 0);
                const remainingSkillRanks = totalSkillRanks - usedSkillRanks;
                
                // Update skill tracker UI
                document.getElementById('skillRanksUsed').textContent = usedSkillRanks;
                document.getElementById('skillRanksTotal').textContent = totalSkillRanks;
                document.getElementById('skillRanksRemaining').textContent = remainingSkillRanks + ' remaining';
                
                const skillRemainingElem = document.getElementById('skillRanksRemaining');
                skillRemainingElem.classList.remove('over', 'complete');
                if (remainingSkillRanks < 0) {
                    skillRemainingElem.classList.add('over');
                } else if (remainingSkillRanks === 0 && totalSkillRanks > 0) {
                    skillRemainingElem.classList.add('complete');
                }
                
                // Update skill progress bar
                const skillProgress = totalSkillRanks > 0 ? Math.min((usedSkillRanks / totalSkillRanks) * 100, 100) : 0;
                const skillProgressBar = document.getElementById('skillProgressBar');
                skillProgressBar.style.width = skillProgress + '%';
                skillProgressBar.classList.remove('over', 'complete');
                if (remainingSkillRanks < 0) {
                    skillProgressBar.classList.add('over');
                } else if (remainingSkillRanks === 0 && totalSkillRanks > 0) {
                    skillProgressBar.classList.add('complete');
                }
            },

            validateCharacter: function() {
                const char = this.currentCharacter;
                const issues = [];
                const warnings = [];
                
                // Validate character name
                if (!char.name || char.name.trim() === '' || char.name === 'New Character') {
                    issues.push('Please enter a character name');
                }
                
                // Validate attribute points
                let totalAttributePoints = this.rules.attributes.startingTotal;
                for (let i = 1; i <= char.level; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData) {
                        totalAttributePoints += levelData.attributeIncreases;
                    }
                }
                
                const usedAttributePoints = Object.values(char.attributes).reduce((sum, val) => sum + val, 0);
                if (usedAttributePoints > totalAttributePoints) {
                    issues.push(`You have used ${usedAttributePoints - totalAttributePoints} too many attribute points`);
                } else if (usedAttributePoints < totalAttributePoints) {
                    warnings.push(`You have ${totalAttributePoints - usedAttributePoints} unspent attribute points`);
                }
                
                // Check for attributes over maximum
                for (const [attr, value] of Object.entries(char.attributes)) {
                    if (value > this.rules.attributes.maxValue) {
                        issues.push(`${attr.charAt(0).toUpperCase() + attr.slice(1)} cannot exceed ${this.rules.attributes.maxValue}`);
                    }
                }
                
                // Validate skill ranks
                let totalSkillRanks = 0;
                for (let i = 1; i <= char.level; i++) {
                    const levelData = this.rules.advancement.levelProgression.find(l => l.level === i);
                    if (levelData) {
                        totalSkillRanks += levelData.skillRankIncreases;
                    }
                }
                
                const usedSkillRanks = Object.values(char.skills).reduce((sum, rank) => sum + rank, 0);
                if (usedSkillRanks > totalSkillRanks) {
                    issues.push(`You have used ${usedSkillRanks - totalSkillRanks} too many skill ranks`);
                } else if (usedSkillRanks < totalSkillRanks && totalSkillRanks > 0) {
                    warnings.push(`You have ${totalSkillRanks - usedSkillRanks} unspent skill ranks`);
                }
                
                // Check for skills over maximum
                for (const [skillId, rank] of Object.entries(char.skills)) {
                    if (rank > this.rules.skills.maxRanks) {
                        const skill = this.rules.skills.list.find(s => s.id === skillId);
                        issues.push(`${skill.name} cannot exceed ${this.rules.skills.maxRanks} ranks`);
                    }
                }
                
                // Validate heroic path selection
                if (!char.heroicPath) {
                    issues.push('Please select a Heroic Path');
                }
                
                // Validate purpose and obstacle (recommended but not required)
                if (!char.purpose || char.purpose.trim() === '') {
                    warnings.push('Consider adding a Purpose for your character');
                }
                
                if (!char.obstacle || char.obstacle.trim() === '') {
                    warnings.push('Consider adding an Obstacle for your character');
                }
                
                // Update validation summary
                this.renderValidationSummary(issues, warnings);
                
                // Update character complete badge
                const isComplete = issues.length === 0 && warnings.length <= 2; // Allow missing purpose/obstacle
                const badge = document.getElementById('characterCompleteBadge');
                if (isComplete) {
                    badge.textContent = '‚úì Character Complete';
                    badge.className = 'character-complete-badge complete';
                } else {
                    badge.textContent = '‚ö† Incomplete';
                    badge.className = 'character-complete-badge incomplete';
                }
            },

            renderValidationSummary: function(issues, warnings) {
                const container = document.getElementById('validationSummary');
                
                if (issues.length === 0 && warnings.length === 0) {
                    container.innerHTML = `
                        <div class="validation-warning success">
                            <span class="validation-icon">‚úì</span>
                            <div class="validation-message">
                                <strong>Character is ready to play!</strong> All required fields are complete.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Show errors
                if (issues.length > 0) {
                    html += `
                        <div class="validation-warning error">
                            <span class="validation-icon">‚ö†</span>
                            <div class="validation-message">
                                <strong>Issues to fix:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Show warnings
                if (warnings.length > 0) {
                    html += `
                        <div class="validation-warning">
                            <span class="validation-icon">‚Ñπ</span>
                            <div class="validation-message">
                                <strong>Recommendations:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${warnings.map(warning => `<li>${warning}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            },

            updateAttributeValue: function(attrName, value) {
                this.currentCharacter.attributes[attrName] = parseInt(value) || 0;
                this.recalculateAll();
                this.updateCharacter();
            },

            updateCharacter: function() {
                const char = this.currentCharacter;
                
                char.name = document.getElementById('characterName').value;
                char.playerName = document.getElementById('playerName').value;
                char.ancestry = document.getElementById('ancestry').value;
                char.culture = document.getElementById('culture').value;
                
                char.attributes.strength = parseInt(document.getElementById('strength').value) || 0;
                char.attributes.speed = parseInt(document.getElementById('speed').value) || 0;
                char.attributes.intellect = parseInt(document.getElementById('intellect').value) || 0;
                char.attributes.willpower = parseInt(document.getElementById('willpower').value) || 0;
                char.attributes.awareness = parseInt(document.getElementById('awareness').value) || 0;
                char.attributes.presence = parseInt(document.getElementById('presence').value) || 0;
                
                char.currentHealth = parseInt(document.getElementById('currentHealth').value) || 0;
                char.currentFocus = parseInt(document.getElementById('currentFocus').value) || 0;
                char.currentInvestiture = parseInt(document.getElementById('currentInvestiture').value) || 0;
                char.deflect = parseInt(document.getElementById('deflect').value) || 0;
                
                char.purpose = document.getElementById('purpose').value;
                char.obstacle = document.getElementById('obstacle').value;
                char.notes = document.getElementById('notes').value;
                
                // Character details
                if (!char.characterDetails) char.characterDetails = {};
                char.characterDetails.age = document.getElementById('characterAge').value;
                char.characterDetails.gender = document.getElementById('characterGender').value;
                char.characterDetails.height = document.getElementById('characterHeight').value;
                char.characterDetails.weight = document.getElementById('characterWeight').value;
                char.characterDetails.appearance = document.getElementById('characterAppearance').value;
                char.characterDetails.backstory = document.getElementById('characterBackstory').value;
                
                char.updatedAt = new Date().toISOString();
                
                this.renderCharacterList();
                this.saveToLocalStorage();
            },



            checkTalentPrerequisite: function(talent, pathId) {
                if (talent.prerequisite === 'none') return true;

                const char = this.currentCharacter;
                const prereq = talent.prerequisite;

                // Check for skill rank requirements (e.g., "Deduction 1+")
                const skillRankMatch = prereq.match(/(\w+)\s+(\d+)\+/);
                if (skillRankMatch) {
                    const skillName = skillRankMatch[1];
                    const requiredRank = parseInt(skillRankMatch[2]);
                    
                    // Find skill by name
                    const skill = this.rules.skills.list.find(s => 
                        s.name.toLowerCase() === skillName.toLowerCase() || 
                        s.id === skillName.toLowerCase().replace(/\s+/g, '_')
                    );
                    
                    if (skill) {
                        const currentRank = char.skills[skill.id] || 0;
                        if (currentRank < requiredRank) return false;
                    }
                }

                // Check for other talent requirements
                const talentMatch = prereq.match(/([A-Z][^,]+)/g);
                if (talentMatch) {
                    for (const talentName of talentMatch) {
                        const cleanName = talentName.trim();
                        // Check if it's a talent name (not a skill rank requirement)
                        if (!cleanName.match(/\d+\+$/)) {
                            // Find talent by name across all paths
                            let found = false;
                            this.rules.heroicPaths.forEach(path => {
                                path.specialties.forEach(spec => {
                                    if (spec.talents.some(t => {
                                        const fullTalentId = `${path.id}_${t.id}`;
                                        return t.name === cleanName && char.talents.includes(fullTalentId);
                                    })) {
                                        found = true;
                                    }
                                });
                            });
                            if (!found) return false;
                        }
                    }
                }

                return true;
            },

            toggleTalent: function(talentId) {
                if (!this.currentCharacter.talents) {
                    this.currentCharacter.talents = [];
                }

                const index = this.currentCharacter.talents.indexOf(talentId);
                if (index > -1) {
                    // Remove talent
                    this.currentCharacter.talents.splice(index, 1);
                } else {
                    // Add talent
                    this.currentCharacter.talents.push(talentId);
                }

                // Full re-render to ensure all derived values update (some talents may affect stats)
                this.renderCharacterSheet();
                this.updateCharacter();
            },

            deleteCurrentCharacter: function() {
                if (confirm(`Are you sure you want to delete ${this.currentCharacter.name}? This cannot be undone.`)) {
                    this.characters = this.characters.filter(c => c.id !== this.currentCharacter.id);
                    this.saveToLocalStorage();
                    
                    if (this.characters.length > 0) {
                        this.loadCharacter(this.characters[0].id);
                    } else {
                        this.currentCharacter = null;
                        document.getElementById('characterSheetSection').classList.add('hidden');
                        this.createNewCharacter();
                    }
                    
                    this.renderCharacterList();
                }
            },

            saveToLocalStorage: function() {
                try {
                    localStorage.setItem('cosmereCharacters', JSON.stringify(this.characters));
                    console.log('Saved to localStorage');
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    alert('Error saving to local storage. Your browser may have storage disabled.');
                }
            },

            loadFromLocalStorage: function() {
                try {
                    const saved = localStorage.getItem('cosmereCharacters');
                    if (saved) {
                        this.characters = JSON.parse(saved);
                        console.log('Loaded from localStorage');
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            },

            exportToFile: async function() {
                if (!this.currentCharacter) return;
                
                const dataStr = JSON.stringify(this.currentCharacter, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.currentCharacter.name.replace(/[^a-z0-9]/gi, '_')}_${this.currentCharacter.level}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            },

            importFromFile: function() {
                document.getElementById('fileInput').click();
            },

            handleFileImport: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const character = JSON.parse(e.target.result);
                        
                        // Generate new ID to avoid conflicts
                        character.id = Date.now().toString();
                        character.updatedAt = new Date().toISOString();
                        
                        this.characters.push(character);
                        this.loadCharacter(character.id);
                        this.saveToLocalStorage();
                        
                        alert('Character imported successfully!');
                    } catch (error) {
                        console.error('Error importing character:', error);
                        alert('Error importing character. Make sure the file is a valid character JSON.');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            },

            // ========== EQUIPMENT & COMBAT FUNCTIONS ==========
            
            addWeapon: function() {
                // Open weapon selection modal
                this.renderWeaponModal();
                document.getElementById('weaponModal').classList.add('active');
            },

            closeWeaponModal: function() {
                document.getElementById('weaponModal').classList.remove('active');
            },

            renderWeaponModal: function() {
                const renderWeaponList = (weapons, containerId) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = weapons.map(weapon => `
                        <div class="weapon-option" onclick="app.selectWeapon('${weapon.id}', '${containerId.includes('light') ? 'light' : 'heavy'}')">
                            <div class="weapon-option-name">${weapon.name}</div>
                            <div class="weapon-option-stats">
                                ${weapon.damage} ${weapon.damageType} | ${weapon.range}<br>
                                ${weapon.price} mk | ${weapon.weight} lbs
                            </div>
                            ${weapon.traits && weapon.traits.length > 0 ? 
                                `<div style="font-size: 0.75em; margin-top: 4px; color: #666;">${weapon.traits.slice(0, 2).join(', ')}</div>` 
                                : ''}
                        </div>
                    `).join('');
                };

                renderWeaponList(this.rules.weapons.light, 'lightWeaponsList');
                renderWeaponList(this.rules.weapons.heavy, 'heavyWeaponsList');
            },

            filterWeapons: function(searchTerm) {
                const term = searchTerm.toLowerCase();
                
                const filterList = (weapons, containerId) => {
                    const filtered = weapons.filter(w => 
                        w.name.toLowerCase().includes(term) || 
                        w.damageType.toLowerCase().includes(term) ||
                        (w.traits && w.traits.some(t => t.toLowerCase().includes(term)))
                    );
                    
                    const container = document.getElementById(containerId);
                    if (filtered.length === 0) {
                        container.innerHTML = '<div class="help-text">No weapons found</div>';
                    } else {
                        container.innerHTML = filtered.map(weapon => `
                            <div class="weapon-option" onclick="app.selectWeapon('${weapon.id}', '${containerId.includes('light') ? 'light' : 'heavy'}')">
                                <div class="weapon-option-name">${weapon.name}</div>
                                <div class="weapon-option-stats">
                                    ${weapon.damage} ${weapon.damageType} | ${weapon.range}<br>
                                    ${weapon.price} mk | ${weapon.weight} lbs
                                </div>
                                ${weapon.traits && weapon.traits.length > 0 ? 
                                    `<div style="font-size: 0.75em; margin-top: 4px; color: #666;">${weapon.traits.slice(0, 2).join(', ')}</div>` 
                                    : ''}
                            </div>
                        `).join('');
                    }
                };

                filterList(this.rules.weapons.light, 'lightWeaponsList');
                filterList(this.rules.weapons.heavy, 'heavyWeaponsList');
            },

            selectWeapon: function(weaponId, category) {
                const weapon = this.rules.weapons[category].find(w => w.id === weaponId);
                if (!weapon) return;
                
                if (!this.currentCharacter.weapons) this.currentCharacter.weapons = [];
                this.currentCharacter.weapons.push({...weapon, equipped: true});
                
                this.closeWeaponModal();
                this.renderWeapons();
                this.calculateAttackBonuses();
                this.updateCharacter();
            },

            removeWeapon: function(index) {
                if (!confirm('Remove this weapon?')) return;
                this.currentCharacter.weapons.splice(index, 1);
                this.renderWeapons();
                this.calculateAttackBonuses();
                this.updateCharacter();
            },

            renderWeapons: function() {
                const container = document.getElementById('weaponsList');
                if (!this.currentCharacter.weapons || this.currentCharacter.weapons.length === 0) {
                    container.innerHTML = '<div class="help-text">No weapons equipped. Click "Add Weapon" to equip a weapon.</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.weapons.map((weapon, index) => {
                    const skillName = this.rules.skills.list.find(s => s.id === weapon.skill)?.name || weapon.skill;
                    const skillRank = this.currentCharacter.skills[weapon.skill] || 0;
                    const attr = this.rules.skills.list.find(s => s.id === weapon.skill)?.attribute || 'strength';
                    const attrValue = this.currentCharacter.attributes[attr] || 0;
                    const attackBonus = attrValue + skillRank;
                    
                    return `
                        <div class="item-card">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">${weapon.name}</div>
                                <div class="item-details">
                                    <div class="item-stat">
                                        <div class="item-stat-label">Damage</div>
                                        <div class="item-stat-value">${weapon.damage} ${weapon.damageType}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Range</div>
                                        <div class="item-stat-value">${weapon.range}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Attack Bonus</div>
                                        <div class="item-stat-value">+${attackBonus}</div>
                                    </div>
                                    <div class="item-stat">
                                        <div class="item-stat-label">Skill</div>
                                        <div class="item-stat-value">${skillName}</div>
                                    </div>
                                </div>
                                ${weapon.traits && weapon.traits.length > 0 ? 
                                    `<div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                                        <strong>Traits:</strong> ${weapon.traits.join(', ')}
                                    </div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="inline-dice-btn" 
                                        onclick="diceRoller.rollWeaponAttack(\`${weapon.name}\`, ${attackBonus}, \`${weapon.damage}\`)"
                                        title="Roll attack">üé≤</button>
                                <button onclick="app.removeWeapon(${index})" class="danger">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            equipArmor: function(armorId) {
                this.currentCharacter.equippedArmor = armorId || null;
                const armor = armorId ? this.rules.armor.find(a => a.id === armorId) : null;
                
                const details = document.getElementById('armorDetails');
                if (armor) {
                    document.getElementById('armorDeflect').textContent = armor.deflect;
                    document.getElementById('armorWeight').textContent = armor.weight;
                    document.getElementById('armorTraits').textContent = armor.traits.join(', ') || 'None';
                    details.style.display = 'block';
                } else {
                    details.style.display = 'none';
                }
                
                this.recalculateAll();
                this.updateCharacter();
            },

            renderArmorOptions: function() {
                const select = document.getElementById('equippedArmor');
                select.innerHTML = '<option value="">None</option>' + 
                    this.rules.armor.map(armor => 
                        `<option value="${armor.id}" ${this.currentCharacter.equippedArmor === armor.id ? 'selected' : ''}>
                            ${armor.name} (Deflect ${armor.deflect})
                        </option>`
                    ).join('');
            },

            calculateAttackBonuses: function() {
                // Melee attack = STR or SPD + Light/Heavy Weaponry skill
                const str = this.currentCharacter.attributes.strength || 0;
                const spd = this.currentCharacter.attributes.speed || 0;
                const lightWeap = this.currentCharacter.skills.light_weaponry || 0;
                const heavyWeap = this.currentCharacter.skills.heavy_weaponry || 0;
                
                const meleeBonus = Math.max(str + lightWeap, str + heavyWeap, spd + lightWeap);
                const rangedBonus = Math.max(spd + lightWeap, str + heavyWeap);
                
                document.getElementById('meleeAttack').textContent = `+${meleeBonus}`;
                document.getElementById('rangedAttack').textContent = `+${rangedBonus}`;
            },

            calculateInitiative: function() {
                const awa = this.currentCharacter.attributes.awareness || 0;
                const spd = this.currentCharacter.attributes.speed || 0;
                const initiative = awa + spd;
                document.getElementById('initiative').textContent = `+${initiative}`;
            },

            addInventoryItem: function() {
                const name = prompt('Item name:');
                if (!name) return;
                const quantity = parseInt(prompt('Quantity:', '1')) || 1;
                const weight = parseFloat(prompt('Weight (lbs):', '0')) || 0;
                const description = prompt('Description (optional):', '') || '';
                
                if (!this.currentCharacter.inventory) this.currentCharacter.inventory = [];
                this.currentCharacter.inventory.push({name, quantity, weight, description});
                this.renderInventory();
                this.updateCharacter();
            },

            removeInventoryItem: function(index) {
                if (!confirm('Remove this item?')) return;
                this.currentCharacter.inventory.splice(index, 1);
                this.renderInventory();
                this.updateCharacter();
            },

            renderInventory: function() {
                const container = document.getElementById('inventoryList');
                if (!this.currentCharacter.inventory || this.currentCharacter.inventory.length === 0) {
                    container.innerHTML = '<div class="help-text">No items in inventory.</div>';
                    return;
                }

                let totalWeight = 0;
                container.innerHTML = this.currentCharacter.inventory.map((item, index) => {
                    totalWeight += item.weight * item.quantity;
                    return `
                        <div class="item-card">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${item.name} ${item.quantity > 1 ? `(√ó${item.quantity})` : ''}</div>
                                ${item.description ? `<div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">${item.description}</div>` : ''}
                                <div style="font-size: 0.85em; margin-top: 4px;">Weight: ${item.weight * item.quantity} lbs</div>
                            </div>
                            <div class="item-actions">
                                <button onclick="app.removeInventoryItem(${index})" class="danger">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('') + `<div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: bold;">Total Weight: ${totalWeight.toFixed(1)} lbs</div>`;
            },

            updateCurrency: function() {
                const chips = parseFloat(document.getElementById('chips').value) || 0;
                const marks = parseFloat(document.getElementById('marks').value) || 0;
                const broams = parseFloat(document.getElementById('broams').value) || 0;
                
                this.currentCharacter.currency = {chips, marks, broams};
                
                const totalMarks = (chips * 0.05) + marks + (broams * 20);
                document.getElementById('totalMarks').textContent = totalMarks.toFixed(2);
                
                this.updateCharacter();
            },

            // ========== INJURIES & CONDITIONS FUNCTIONS ==========
            
            addInjury: function(type) {
                const description = prompt(`Enter ${type} injury description:`);
                if (!description) return;
                
                if (!this.currentCharacter.injuries) {
                    this.currentCharacter.injuries = {temporary: [], permanent: []};
                }
                
                this.currentCharacter.injuries[type].push({description, date: new Date().toLocaleDateString()});
                this.renderInjuries();
                this.updateCharacter();
            },

            removeInjury: function(type, index) {
                if (!confirm('Remove this injury?')) return;
                this.currentCharacter.injuries[type].splice(index, 1);
                this.renderInjuries();
                this.updateCharacter();
            },

            renderInjuries: function() {
                ['temporary', 'permanent'].forEach(type => {
                    const container = document.getElementById(`${type}Injuries`);
                    const injuries = this.currentCharacter.injuries?.[type] || [];
                    
                    if (injuries.length === 0) {
                        container.innerHTML = `<div class="help-text">No ${type} injuries</div>`;
                        return;
                    }
                    
                    container.innerHTML = injuries.map((injury, index) => `
                        <div class="injury-card">
                            <div>
                                <div style="font-weight: bold;">${injury.description}</div>
                                <div style="font-size: 0.85em; margin-top: 4px;">Date: ${injury.date}</div>
                            </div>
                            <button onclick="app.removeInjury('${type}', ${index})" class="danger">√ó</button>
                        </div>
                    `).join('');
                });
            },

            addCondition: function() {
                const conditionNames = this.rules.conditions.map(c => c.name).join('\n');
                const conditionName = prompt(`Select condition:\n\n${conditionNames}\n\nEnter name:`);
                if (!conditionName) return;
                
                const condition = this.rules.conditions.find(c => 
                    c.name.toLowerCase() === conditionName.toLowerCase()
                );
                
                if (!condition) {
                    alert('Condition not found');
                    return;
                }
                
                if (!this.currentCharacter.conditions) this.currentCharacter.conditions = [];
                this.currentCharacter.conditions.push({
                    ...condition,
                    applied: new Date().toLocaleDateString()
                });
                this.renderConditions();
                this.updateCharacter();
            },

            removeCondition: function(index) {
                if (!confirm('Remove this condition?')) return;
                this.currentCharacter.conditions.splice(index, 1);
                this.renderConditions();
                this.updateCharacter();
            },

            renderConditions: function() {
                const container = document.getElementById('conditionsList');
                if (!this.currentCharacter.conditions || this.currentCharacter.conditions.length === 0) {
                    container.innerHTML = '<div class="help-text">No active conditions</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.conditions.map((condition, index) => `
                    <div class="condition-card">
                        <div>
                            <div style="font-weight: bold;">${condition.name}</div>
                            <div style="font-size: 0.9em; margin-top: 4px;">${condition.description}</div>
                            <div style="font-size: 0.85em; margin-top: 4px;">Applied: ${condition.applied}</div>
                        </div>
                        <button onclick="app.removeCondition(${index})" class="danger">√ó</button>
                    </div>
                `).join('');
            },

            // ========== CONNECTIONS FUNCTIONS ==========
            
            addConnection: function() {
                const name = prompt('Connection name:');
                if (!name) return;
                const relationship = prompt('Relationship (e.g., Ally, Enemy, Family, Mentor):') || 'Acquaintance';
                const description = prompt('Description (optional):') || '';
                
                if (!this.currentCharacter.connections) this.currentCharacter.connections = [];
                this.currentCharacter.connections.push({name, relationship, description});
                this.renderConnections();
                this.updateCharacter();
            },

            removeConnection: function(index) {
                if (!confirm('Remove this connection?')) return;
                this.currentCharacter.connections.splice(index, 1);
                this.renderConnections();
                this.updateCharacter();
            },

            renderConnections: function() {
                const container = document.getElementById('connectionsList');
                if (!this.currentCharacter.connections || this.currentCharacter.connections.length === 0) {
                    container.innerHTML = '<div class="help-text">No connections tracked</div>';
                    return;
                }

                container.innerHTML = this.currentCharacter.connections.map((conn, index) => `
                    <div class="connection-card">
                        <div>
                            <div style="font-weight: bold;">${conn.name}</div>
                            <div style="font-size: 0.9em; margin-top: 4px;"><strong>${conn.relationship}</strong></div>
                            ${conn.description ? `<div style="font-size: 0.9em; margin-top: 4px;">${conn.description}</div>` : ''}
                        </div>
                        <button onclick="app.removeConnection(${index})" class="danger">√ó</button>
                    </div>
                `).join('');
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>

